#数据管理和业务分析

管理和分析云中的数据与管理和分析其他任何地方的数据一样重要。为让你实现此目的，Azure 提供了各种用于处理关系数据和非关系数据的技术。本文将一一介绍这些方式。 

##目录      

- [Blob 存储](#blob)
- [在虚拟机中运行 DBMS](#dbinvm)
- [SQL 数据库](#sqldb)
	<!-- - [SQL 数据同步](#datasync)-->
	- [使用虚拟机进行 SQL 数据报告](#datarpt)
- [表存储](#tblstor)
- [Hadoop](#hadoop)

## <a name="blob"></a>Blob 存储

单词"blob"是"二进制大型对象"的缩写，它能够精确说明 blob 的含义：二进制信息的集合。虽然 blob 很简单，但它们非常有用。[图 1](#Fig1) 说明 Azure Blob 存储的基础知识。

<a name="Fig1"></a>![Diagram of Blobs][blobs]
 
**图 1：Azure Blob 存储在容器中存储二进制数据 - blob。**

若要使用 blob，必须先创建 Azure *storage account*。在创建帐户期间，需要指定将存储你使用此帐户创建的对象的 Azure 数据中心。无论所创建的每个 blob 位于何处，它都属于存储帐户中的某个容器。若要访问 blob，应用程序应提供以下形式的 URL：

http://&lt;*StorageAccount*&gt;.blob.core.chinacloudapi.cn/&lt;*Container*&gt;/&lt;*BlobName*&gt;

&lt;*存储帐户*&gt; 是在创建新存储帐户时分配的唯一标识符，而 &lt;*容器*&gt; 和 &lt;*Blob 名称*&gt; 分别是特定容器以及该容器中的 blob 的名称。

Azure 提供了两个不同种类的 blob。选项有：

- *块* blob，每个 blob 最多可包含 200 GB 的数据。顾名思义，一个块 blob 细分为若干个块。如果在传输块 blob 时出现问题，重新传输过程会从最近的块开始传输，而不是再次发送整个 blob。块 blob 是非常流行的存储方法，并且它们是当今最常用的 blob 类型。

- 页 blob，每个 blob 大小可为 1 TB。**页 blob 旨在实现随机访问，因此每个 blob 划分为若干个页。应用程序可在 blob 中自由地随机读取和写入单个页。例如，在 Azure 虚拟机中，你创建的 VM 使用页 blob 作为 OS 磁盘和数据磁盘的永久性存储。

无论你选择块 blob 还是页 blob，应用程序都可以通过多种不同方式访问 blob 数据。这些方式包括：

- 直接通过 RESTful（即，基于 HTTP 的）访问协议。Azure 应用程序和外部应用程序（包括本地运行的应用程序）都可以使用此方式。
- 使用 Azure 存储客户端库，它依据原始 RESTful blob 访问协议提供更加便于开发人员使用的界面。重申一下，Azure 应用程序和外部应用程序都可以使用此库来访问 blob。
- 使用 Azure 驱动器，Azure 应用程序可通过此方式将页 blob 视为使用 NTFS 文件系统的本地驱动器。对应用程序来说，页 blob 看上去像可使用标准文件 I/O 访问的普通 Windows 文件系统。事实上，读取和写入操作均发送到可实现 Azure 驱动器的基础页 blob。 

为避免出现硬件故障并提高可用性，可在 Azure 数据中心的三台计算机上复制每个 blob。写入 blob 时会更新所有三个副本，因此稍后的读取操作不会导致不一致的结果。你还可以指定将 blob 数据复制到位于同一地域中但至少相距 500 英里的另一个 Azure 数据中心。此复制称为 *geo-replication*，发生在 blob 更新后的几分钟内，可用于灾难恢复。

还可以通过 Azure *Content Delivery Network (CDN)* 来使用 blob 中的数据。通过在全球数十台服务器上缓存 blob 数据的副本，CDN 可以加快对重复访问的信息的访问速度。 

因为 blob 很简单，所以它们在许多情况下都是正确的选择。存储和流式处理视频及音频就是典型的示例，就像备份和其他种类的数据存档一样。开发人员还可以使用 blob 来保存他们喜欢的任何种类的非结构化数据。通过一种简单方式来存储和访问二进制数据将非常有用。


## <a name="dbinvm"></a>在虚拟机中运行 DBMS

当今许多应用程序都依赖某种数据库管理系统 (DBMS)。关系系统（如 SQL Server）是最常用的选择，但非关系方法（通常称为 *NoSQL* 技术）变得日益流行。为了让云应用程序能够使用这些数据管理方式，Azure 虚拟机允许你在 VM 中运行 DBMS（关系或 NoSQL）。[图 2](#Fig2) 以 SQL Server 为例说明了这种情况。

<a name="Fig2"></a>![Diagram of SQL Server in a Virtual Machine][SQLSvr-vm]
 
**图 2：Azure 虚拟机允许在 VM 中运行 DBMS，并且通过 blob 实现永久存储。**

对开发人员和数据库管理员来说，此方案非常类似于在他们自己的数据中心中运行同一软件。例如，在此处显示的示例中，可以使用 SQL Server 的几乎所有功能，并且你对系统具有完全管理访问权限。当然，你还负责管理数据库服务器，就好像它在本地运行一样。

正如[图 2](#Fig2) 所示，你的数据库似乎存储在运行服务器的 VM 的本地磁盘上。不过，事实上，其中每个磁盘都写入到 Azure blob。（它类似于在你自己的数据中心中使用 SAN，并且 blob 的行为非常类似于 LUN。）与任何 Azure blob 一样，它所包含的数据会在数据中心中复制三次，并且如果你需要使用这些数据，则可通过地域复制将其复制到同一区域中的另一个数据中心。还可以使用 SQL Server 数据库镜像等方式来提高可靠性。 

在 VM 中使用 SQL Server 的另一种方法是创建混合应用程序，采用该方法时，数据位于 Azure 上，而应用程序逻辑在本地运行。例如，当运行在多个位置或各种移动设备上的应用程序必须共享相同数据时，这可能很有用。为了使云数据库和本地逻辑之间的通信更简单，组织可以使用 Azure 虚拟网络在 Azure 数据中心和其自己的本地数据中心之间创建虚拟专用网络 (VPN) 连接。


## <a name="sqldb"></a>SQL 数据库

对许多人来说，在 VM 中运行 DBMS 是所能想到的、在云中管理结构化数据的第一种方式。但它不是唯一选择，也不总是最佳选择。在一些情况下，使用"平台即服务"(PaaS) 方法管理数据更有意义。Azure 提供了称为 SQL 数据库 的 PaaS 技术，该技术允许你对关系数据进行管理。[图 3](#Fig3) 说明了此方式。 

<a name="Fig3"></a>![Diagram of SQL 数据库][SQL-db]
 
**图 3：SQL 数据库 提供了共享的 PaaS 关系存储服务。**

SQL 数据库 不为每个客户提供自己的 SQL Server 物理实例。相反，它为每个客户提供多租户服务和逻辑 SQL 数据库 服务器。所有客户共享该服务提供的计算和存储容量。与 Blob 存储一样，SQL 数据库 中的所有数据都存储在 Azure 数据中心的三台独立计算机上，从而为你的数据库提供内置的高可用性 (HA)。

对应用程序来说，SQL 数据库 非常类似于 SQL Server。应用程序可以对关系表发出 SQL 查询，使用 T-SQL 存储过程，并跨多个表执行事务。因为应用程序使用表格格式数据流 (TDS) 协议（用于访问 SQL Server 的同一协议）访问 SQL 数据库，所以它们可以使用 Entity Framework、ADO.NET、JDBC 和其他熟悉的数据访问接口来处理数据。 

但是，因为 SQL 数据库 是运行在 Azure 数据中心中的云服务，所以你无需管理系统的任何物理方面，例如磁盘使用率。你还无需担心软件更新或其他低级管理任务的处理过程。当然，每个客户组织仍能够控制自己的数据库（包括他们的架构和用户登录），但 SQL 数据库 将为您执行许多常规管理任务。 

虽然对应用程序来说，SQL 数据库 非常类似于 SQL Server，但它的行为与运行在物理计算机或虚拟机上的 DBMS 不完全相同。因为它运行在共享硬件上，所以其性能将随其所有客户置于该硬件上的负载而变。这意味着 SQL 数据库 中存储过程等任务的性能可能每天都在变化。 

如今，SQL 数据库 允许你创建可容纳多达 150 GB 数据的数据库。如果你需要处理更大的数据库，该服务提供了一个称为 *Federation* 的选项。为此，数据库管理员需要创建两个或更多个 *federation members*，其中每个成员都是具有自己的架构的单独数据库。数据分散存储在这些成员中，这通常称为 *sharding*，并为每个成员分配了一个唯一的 *federation key*。应用程序通过指定标识作为查询目标的联合成员的联合键来对此数据发出 SQL 查询。这将允许对大量数据使用传统的关系方法。通常，需要进行一些权衡；例如，查询和事务都无法跨越联合成员。但是，当关系 PaaS 服务是最佳选择且这些权衡可接受时，使用 SQL Federation 会是一个很好的解决方案。

SQL 数据库 可由运行在 Azure 上或其他位置（例如你的本地数据中心）的应用程序使用。这使它对于需要关系数据的云应用程序以及可受益于在云中存储数据的本地应用程序很有用。例如，就像全球多个经销商所运行的库存应用程序一样，移动应用程序可能依赖 SQL 数据库 来管理共享的关系数据。

考虑使用 SQL 数据库 会引发一个明显（且重要）的问题：应何时在 VM 中运行 SQL Server，以及 SQL 数据库 在何时是更好的选择？通常，需要进行一些权衡，因此哪种方法较好取决于您的要求。 

做出适当选择的一个简单方法是，可将 SQL 数据库 用于新应用程序，而当你要将现有的本地应用程序移动到云中时，则在 VM 中运行 SQL Server 是理想之选。不过，最好采用更加精确的方式来做出此决定。例如，SQL 数据库 更易于使用，因为其设置和管理工作最少。但在 VM 中运行 SQL Server 具有更易预测的性能（因为它不是共享服务），并且与 SQL 数据库 相比，它还支持更大的非联合数据库。但是，SQL 数据库 可以提供数据和处理的内置复制，因此只需完成非常少的工作即可为您高效提供高可用性 DBMS。虽然 SQL Server 为你提供了更多控制权和更广泛的一组选项，但 SQL 数据库 的设置更简单，且要管理的工作明显减少。

最后，必须指出 SQL 数据库 不是 Azure 中提供的唯一 PaaS 数据服务。Microsoft 合作伙伴还提供了其他服务。例如，ClearDB 提供了 MySQL PaaS 产品/服务，而 Cloudant 销售 NoSQL 服务。PaaS 数据服务是适用于许多情况的解决方案，因此，此数据管理方法是 Azure 的重要组成部分。


<!--### <a name="datasync"></a>SQL 数据同步

虽然 SQL 数据库 在单个 Azure 数据中心中保存了每个数据库的三个副本，但它不会在 Azure 数据中心之间自动复制数据。它提供了 SQL 数据同步，您可以使用该服务实现此目的。[图 4](#Fig4) 显示了这种情况。

<a name="Fig4"></a>![Diagram of SQL data sync][SQL-datasync]
 
**图 4：SQL 数据同步将 SQL 数据库 中的数据与其他 Azure 和本地数据中心中的数据进行同步。**

正如图中所示，SQL 数据同步可以同步不同位置的数据。例如，假定你在多个 Azure 数据中心中运行应用程序，并且数据存储在 SQL 数据库 中。您可以使用 SQL 数据同步来使该数据保持同步。SQL 数据同步还可以在 Azure 数据中心和运行在本地数据中心中的 SQL Server 的实例之间同步数据。这可能对同时保存本地应用程序所用数据的本地副本和运行在 Azure 上的应用程序所使用的云副本很有用。虽然图中未显示，但 SQL 数据同步还可用于在 SQL 数据库 和运行在 Azure 上或其他位置的 VM 中的 SQL Server 之间同步数据。

同步可以是双向的，并且你完全可以确定同步哪些数据以及同步频率。（不过，数据库之间的同步不是原子事务，即，至少始终存在一些延迟。）无论以哪种方式同步，使用 SQL 数据同步设置同步完全由配置驱动；无需编写代码。-->

<div style="display:none">
### <a name="datarpt"></a>使用虚拟机进行 SQL 数据报告

在数据库包含数据之后，你很可能需要使用该数据创建报告。Azure 可以在 Azure 虚拟机中运行 SQL Server Reporting Services (SSRS)，在功能上相当于在本地运行 SQL Server Reporting Services。然后，你可以使用 SSRS 对存储在 Azure SQL 数据库 中的数据运行报告。[图 5](#Fig5) 演示了此过程的工作原理。

<a name="Fig5"></a>![Diagram of SQL reporting][SQL-report]

**图 5：在 Azure 虚拟机中运行的 SQL Server Reporting Services 提供针对 SQL 数据库 中数据的报告服务。。**

在用户查看报告之前，你可以定义该报告应具有的外观（步骤 1）。通过 VM 上的 SSRS，可以使用以下两个工具中的任一个来执行此操作：SQL Server Data Tools（属于 SQL Server 2012 或其早期版本的一部分）和 Business Intelligence (BI) Development Studio。与 SSRS 相同，这些报告定义以报告定义语言 (RDL) 表示。在创建报告的 RDL 文件之后，可将其上载到云中的 VM（步骤 2）。报告定义现在即可供使用。

接下来，应用程序的用户可访问该报告（步骤 3）。应用程序将此请求传递给 SSRS VM（步骤 4），后者与 SQL 数据库 或其他数据源联系来获得所需数据（步骤 5）。SSRS 使用此数据和相关的 RDL 文件来呈现报告（步骤 6），然后将报告返回给应用程序（步骤 7），后者将向用户显示该报告（步骤 8）。

此处所示方案将报告嵌入应用程序中，但这并不是唯一方式。也可以在 VM 的报表管理器中、VM 的 SharePoint 中或以其他方式查看报告。还可以通过在一个报告中包含指向另一个报告的链接来组合报告。

Azure VM 上的 SSRS 为你提供完整的功能，可以在云中充当报告解决方案。报告可以使用 SSRS 支持的任何数据源。应用程序和报告可以包含嵌入的代码或程序集，用于支持自定义行为。报告的执行和呈现速度很快，因为报表服务器内容和引擎在相同的虚拟服务器上一起运行。
</div>


## <a name="tblstor"></a>表存储

关系数据在许多情况下都很有用，但它并不总是正确选择。例如，如果您的应用程序需要快速轻松地访问数量庞大的结构松散的数据，则关系数据库可能无法很好地工作。NoSQL 技术很可能是较好的选择。

例如，Azure 表存储就是一种 NoSQL 方法。尽管其名称为表存储，但它不支持标准关系表，而是提供 *key/value store*，即，将一组数据与特定键相关联，然后让应用程序通过提供该键来访问这些数据。[图 6](#Fig6) 演示了基本原理。

<a name="Fig6"></a>![Diagram of table storage][SQL-tblstor]
 
**图 6：Azure 表存储是支持快速轻松地访问大量数据的键/值存储。**

与 blob 相似，每个表与一个 Azure 存储帐户相关联。表的命名也与 blob 非常相似，使用以下形式的 URL

http://&lt;*StorageAccount*&gt;.table.core.chinacloudapi.cn/&lt;*TableName*&gt;

正如图中所示，每个表划分为一定数量的分区，其中每个分区可以存储在单独的计算机上。（这是一种形式的分区，与 SQL Federation 一样。）Azure 应用程序和运行在其他位置的应用程序都可以使用 RESTful OData 协议或 Azure 存储客户端库来访问表。

表中的每个分区保存一定数量的 *entities*，每个实体包含多达 255 个 *properties*。每个属性具有名称、类型（例如 Binary、Bool、DateTime、Int 或 String）和值。与关系存储不同，这些表没有固定架构，因此同一表中的不同实体可以包含不同类型的属性。例如，一个实体可能仅具有包含名称的 String 属性，而同一表中的另一个实体具有两个包含客户 ID 编号和信用等级的 Int 属性。

为识别表中的特定实体，应用程序提供了该实体的键。键由两部分组成：用于识别特定分区的 *partition key*，以及用于识别该分区中的实体的 *row key*。例如，在 [图 6](#Fig6) 中，客户端请求分区键为 A、行键为 3 的实体，表存储返回该实体及其所包含的全部属性。

此结构支持大型表（一个表可包含多达 100 TB 的数据），并且它允许快速访问表中包含的数据。不过，它也具有一些限制。例如，不支持跨表或单个表中的分区的事务性更新。如果所涉及的所有实体在同一分区中，则只能将对表执行的一组更新分组到原子事务中。还无法基于表属性的值查询表，也不支持跨多个表进行联接。与关系数据库不同，表不支持存储过程。

对于需要经济实惠地快速访问大量结构松散的数据的应用程序，Azure 表存储是最佳选择。例如，为许多用户存储配置文件信息的 Internet 应用程序可能使用表。在此情况下，快速访问很重要，并且应用程序很可能不需要 SQL 的完整功能。放弃相应功能以获得速度和大小有时会很有用，因此表存储正是解决某些问题的合适解决方案。


## <a name="hadoop"></a>Hadoop

几十年来，组织一直在不断地构建数据仓库。这些信息集合最常存储在关系表中，它使用户可以许多不同的方式使用数据并从数据中了解相关信息。例如，SQL Server 通常使用 SQL Server Analysis Services 等工具来实现此目的。

但假定你需要对非关系数据进行分析。你的数据可能采用许多形式：传感器或 RFID 标签中的信息、服务器场中的日志文件、 Web 应用生成的点击流数据、医疗诊断设备中的图像，等等。这些数据的大小还可能非常大，以至于无法通过传统的数据仓库高效使用它们。这样的大型数据问题几年前很少见，但现在变得很常见。

为分析这种大型数据，我们的行业重点关注以下单个解决方案：开放源代码技术 Hadoop。Hadoop 运行在物理计算机或虚拟机群集上，将它处理的数据分散存储在这些计算机上并以并行方式处理这些数据。Hadoop 所需使用的计算机越多，它完成相应工作的速度就越快。

此类问题自然符合公有云的需要。在云中运行 Hadoop 使您能够根据需要创建 VM 并为之付费，而不必维护可能大部分时间都空闲的大量本地服务器。更好的是，可在云中创建更多您需要使用 Hadoop 进行分析的大型数据，从而不必来回移动数据。为帮助你利用这些协作优势，Microsoft 在 Azure 中提供了 Hadoop 服务。[图 7](#Fig7) 显示了此服务的最重要的组件。

<a name="Fig7"></a>![Diagram of hadoop][hadoop]

**图 7：Azure 上的 Hadoop 运行使用多个虚拟机并行处理数据的 MapReduce 作业。**

要在 Azure 上使用 Hadoop，首先要求此云平台创建 Hadoop 群集，以指定你需要的 VM 的数量。你自己设置 Hadoop 群集并非一项简单任务，因此最好让 Azure 为你执行此任务。设置群集后，请关闭它。无需为你不使用的计算资源付费。

通常称为 *job*的 Hadoop 应用程序使用称为 *MapReduce*的编程模型。正如图中所示，MapReduce 作业的逻辑跨许多 VM 同时运行。通过并行处理数据，Hadoop 可以比单个计算机解决方案更快地分析数据。

在 Azure 上，MapReduce 作业处理的数据通常保存在 blob 存储中。不过，在 Hadoop 中，MapReduce 作业要求数据存储在 *Hadoop Distributed File System (HDFS)*中。HDFS 在某些方面类似于 Blob 存储；例如，它跨多台物理服务器复制数据。Azure 上的 Hadoop 通过 HDFS API 公开 Blob 存储，而不是复制此功能，如图中所示。虽然 MapReduce 作业中的逻辑认为它访问的是普通 HDFS 文件，但事实上，该作业处理的是通过 blob 流式传输给其的数据。为支持对相同数据运行多个作业的情况，Azure 上的 Hadoop 还允许将数据从 blob 复制到运行在 VM 中的完整 HDFS 中。 

现今，MapReduce 作业通常是使用 Java 编写的，这是 Azure 上的 Hadoop 支持的方法。Microsoft 还支持使用其他语言（包括 C#、F# 和 JavaScript）创建 MapReduce 作业。其目标是使更多开发人员能够更轻松地采用此大型数据技术。

除了 HDFS 和 MapReduce 以外，Hadoop 还包括允许用户分析数据而无需自己编写 MapReduce 作业的其他技术。例如，Pig 是为分析大型数据而设计的高级语言，而 Hive 提供类似于 SQL 的称为 HiveQL 的语言。Pig 和 Hive 实际上都生成可处理 HDFS 数据的 MapReduce 作业，但为其用户隐藏了此复杂性。 
二者均随 Azure 上的 Hadoop 提供。

Microsoft 还为 Excel 提供了 HiveQL 驱动程序。使用 Excel 外接程序时，业务分析人员可以直接从 Excel 创建 HiveQL 查询（从而创建 MapReduce 作业），然后使用 PowerPivot 及其他 Excel 工具处理并显示相关结果。Azure 上的 Hadoop 还包括其他技术，例如机器学习库 Mahout、图表挖掘系统 Pegasus，等等。

大型数据分析很重要，因此 Hadoop 也很重要。通过提供作为 Azure 上的托管服务的 Hadoop 以及指向熟悉工具（如 Excel）的链接，Microsoft 旨在使更广泛的用户群能够使用此技术。

更广泛地说，所有类型的数据都很重要。这就是 Azure 包括各种数据管理和业务分析方法的原因。无论你尝试创建何种应用程序，你都可能会发现此云平台中有适合你的内容。

[blobs]: ./media/cloud-storage/Data_01_Blobs.png
[SQLSvr-vm]: ./media/cloud-storage/Data_02_SQLSvrVM.png
[SQL-db]: ./media/cloud-storage/Data_03_SQLdb.png
[SQL-datasync]: ./media/cloud-storage/Data_04_SQLDataSync.png
[SQL-report]: ./media/cloud-storage/Data_05_SQLReporting.png
[SQL-tblstor]: ./media/cloud-storage/Data_06_TblStorage.png
[hadoop]: ./media/cloud-storage/Data_07_Hadoop.png
<!--HONumber=43--> 
