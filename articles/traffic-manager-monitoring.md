<properties 
   pageTitle="流量管理器监视"
   description="本文将帮助你了解和配置流量管理器监视"
   services="traffic-manager"
   documentationCenter=""
   authors="joaoma"
   manager="carmonm"
   editor="tysonn" />
<tags
	ms.service="traffic-manager"
   ms.date="12/07/2015"
	wacn.date="01/21/2016"/>

# 关于流量管理器监视

Azure 流量管理器将监视终结点（包括云服务和 Web 应用）以确保它们可用。若要使监视功能正常工作，必须以相同的方式针对你在流量管理器配置文件中指定的每个终结点设置监视功能。配置监视功能后，流量管理器将在管理门户中显示终结点和配置文件的状态。你可以在管理门户中的“配置”页上为流量管理器配置文件配置监视设置。你可以指定以下设置：

- **协议** – 选择 HTTP 或 HTTPS。请务必注意，HTTPS 监视并不验证 SSL 证书是否有效，它只检查是否有证书。

- **端口** – 选择用于请求的端口。选项包括标准 HTTP 和 HTTPS 端口。

- **相对路径和文件名** – 指定监视系统将要尝试访问的文件的路径和名称。请注意，正斜杠“/”是有效的相对路径条目，表示文件位于根目录（默认位置）中。

## 关于监视运行状态

Azure 流量管理器在管理门户中显示配置文件和终结点服务运行状况。配置文件和终结点的状态列显示最新的监视器状态。你可以使用此状态，根据流量管理器监视设置了解配置文件的运行状况。当配置文件正常运行时，系统将根据配置文件的流量路由设置（轮循机制、性能或故障转移）将 DNS 查询分配到你的服务。一旦流量管理器监视系统检测到监视器状态更改，它就会更新管理门户中的状态条目。状态更改刷新最多需要五分钟时间。

### 终结点监视器状态

下表中的终结点监视器状态是终结点运行状况探测结果与你的配置文件和终结点配置相组合的结果。

|配置文件状态|终结点状态|终结点监视器状态（API 和门户）|说明|
|---|---|---|---|
|已禁用|已启用|非活动|不会监视已禁用的配置文件。但是，仍可管理已禁用的配置文件中的终结点状态。|
|&lt;任意&gt;|已禁用|已禁用|不会监视已禁用的配置文件。但是，仍可管理已禁用的配置文件中的终结点状态。|
|已启用|已启用|联机|终结点受到监视，处于正常状态。|
|已启用|已启用|已降级|终结点受到监视，处于不正常状态。|
|已启用|已启用|正在检查终结点|终结点受到监视，但是，尚未收到首个探测的结果。如果刚刚向配置文件添加了新的终结点，或者刚刚启用了终结点或配置文件，则此状态为临时状态。|
|已启用|已启用|已停止|基础云服务或 Web 应用未运行。|

### 配置文件监视器状态

下表中的配置文件监视器状态是终结点监视器状态与已配置的配置文件状态相组合的结果。

|配置文件状态（已配置）|终结点监视器状态|配置文件监视器状态（API 和门户）|说明|
|---|---|---|---|
|已禁用|&lt;任意&gt;或包含未定义终结点的配置文件。|已禁用|终结点不会被监视。|
|已启用|至少一个终结点的状态为"已降级"。|已降级|这是一个指明需要客户操作的标志。|
|已启用|至少一个终结点的状态为"联机"。没有任何终结点为"已降级"。|联机|该服务正在接受流量，不需要客户操作。|
|已启用|至少一个终结点的状态为"正在检查终结点"。没有任何终结点为"联机"或"已降级"。|正在检查终结点|过渡状态。这通常在刚启用配置文件并且正在探测终结点运行状况时发生。|
|已启用|配置文件中定义的所有终结点的状态为"已禁用"或"已停止"，或者配置文件中没有定义终结点。|非活动|没有任何终结点处于活动状态，但是依旧启用了配置文件。|

## 监视功能如何工作

下面显示了一条示例时间线，用于演示对单个云服务进行监视的过程。此方案显示了以下情况：

- 该云服务可用，并且只通过此流量管理器配置文件接收流量。

- 该云服务变得不可用。

- 该云服务保持不可用的时间远远超过了 DNS 生存时间 (TTL)。

- 该云服务再次变得可用。

- 该云服务继续只通过此流量管理器配置文件接收流量。

![流量管理器监视序列](./media/traffic-manager-monitoring/IC697947.jpg)

**图 1** – 监视序列示例。图中的数字对应于下面带编号的说明。

1. **GET** – 流量管理器监视系统对你在监视设置中指定的路径和文件执行 GET。
2. **200 OK** – 监视系统预期在 10 秒内会返回一条 HTTP 200 OK 消息。如果收到此响应，则它认为云服务可用。 

>[AZURE.NOTE]只有当返回消息为 200 OK 时，流量管理器才会将终结点视为处于联机状态。如果收到非 200 响应，则它将认为终结点不可用，并且将此算作失败的检查。有关对失败的检查进行故障排除的更多详细信息，请参阅 [Azure 流量管理器上的降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded)。

3. **30 秒间隔检查** – 此检查每 30 秒执行一次。
4. **云服务不可用** – 云服务变得不可用。在下次执行监视器检查前，流量管理器不会知道。
5. **尝试访问监视文件（4 次尝试）**– 监视系统执行 GET，但在 10 秒或更短时间内没收到响应。然后它又执行了三次尝试，每隔 30 秒一次。这意味着服务变得不可用时，监视系统最多需要约 1.5 分钟能发现。如果其中一次尝试成功，尝试次数就会重置。如果执行 GET 后返回 200 OK 消息所经历的时间超过了 10 秒，监视系统仍会将其算作失败的检查，不过，图中未显示此行为。
6. **标记为已降级** – 连续第四次失败之后，监视系统会将不可用的云服务标记为“已降级”。 

7. **发送到云服务的流量减少** – 流量可能会继续流向不可用的云服务。由于该服务不可用，客户端会遇到失败。客户端和辅助 DNS 服务器已经缓存了不可用云服务 IP 地址的 DNS 记录。它们会继续将公司域的 DNS 名称解析为该服务的 IP 地址。此外，辅助 DNS 服务器可能会继续分发不可用服务的 DNS 信息。随着客户端和辅助 DNS 服务器的更新，发送到不可用服务 IP 地址的流量将会变慢。监视系统继续以 30 秒间隔执行检查。在此示例中，该服务没有响应并保持不可用。
8. **发送到云服务的流量停止** – 此时，大多数 DNS 服务器和客户端都应更新，并且发送到不可用服务的流量将停止。流量完全停止前的最长时间取决于 TTL 时间。默认 DNS TTL 为 300 秒（5 分钟）。使用此值，客户端在 5 分钟后停止使用该服务。监视系统继续以 30 秒间隔执行检查，云服务没有响应。
9. **云服务重新联机并接收流量** – 该服务变为可用，但在监视系统执行检查前，流量管理器并不知道。
10. **到服务的流量恢复** - 流量管理器发送 GET 并在 10 秒内收到 200 OK 消息。然后在 DNS 服务器请求更新时，流量管理器开始将云服务的 DNS 名称分发给 DNS 服务器。结果，流量开始再次流向该服务。

## 嵌套的配置文件的子级终结点和父级终结点状态

下表介绍了流量管理器针对嵌套的配置文件的子配置文件和父配置文件的监视行为，以及 minChildEndpoints 设置。有关详细信息，请参阅[什么是流量管理器？](/documentation/articles/traffic-manager-overview)。

|子配置文件监视器状态|父级终结点监视器状态|说明|
|---|---|---|
|已禁用 这是由于配置文件被你禁用。|已停止|父级终结点状态为“已停止”，而不是“已禁用”。“已禁用”状态保留用于指示你已在父配置文件中禁用了终结点。|
|已降级 至少一个子级终结点处于“已降级”状态。|“联机”状态，如果子配置文件中的“联机”终结点数量至少为 minChildEndpoints 的值，则为“联机”状态。“正在检查终结点”状态，如果子配置文件中的“联机”加“正在检查终结点”终结点的数量至少为 minChildEndpoints 的值，则为“正在检查终结点”状态。否则，将处于“已降级”状态。|流量被路由到“正在检查终结点”状态的终结点。如果 minChildEndpoints 设置得过高，则父级终结点必定会被降级。|
|联机 至少一个子级终结点处于“联机”状态，没有终结点处于“已降级”状态。|同上。||
|正在检查终结点 至少一个终结点处于“正在检查终结点”状态；没有终结点处于“联机”或“已降级”状态|同上。||
|非活动 所有终结点都处于“已禁用”或“已停止”状态，除非这是没有终结点的配置文件|已停止||

## 配置针对特定路径和文件名的监视

1. 在你要包括在配置文件中的每个终结点上创建一个同名的文件。
2. 对于每个终结点，使用 web 浏览器测试对该文件的访问。URL 由特定终结点（云服务或 Web 应用）的域名、文件路径以及文件名组成。 
3. 在管理门户上的“监视设置”下，在“相对路径和文件名”字段中指定路径和文件名。
4. 完成配置更改后，单击页面底部的“保存”。

## 另请参阅

[创建配置文件](/documentation/articles/traffic-manager-manage-profiles)

[添加终结点](/documentation/articles/traffic-manager-endpoints)

[Azure 流量管理器上的降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded)
 

<!---HONumber=Mooncake_1221_2015-->