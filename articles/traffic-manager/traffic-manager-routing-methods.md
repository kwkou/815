<properties 
   pageTitle="流量管理器 - 流量路由方法 | Azure"
   description="本文将帮助你了解流量管理器使用的各种流量路由方法。"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags
	ms.service="traffic-manager"
	ms.date="05/25/2016"
	wacn.date="07/04/2016"/>

# 流量管理器流量路由方法

此页说明 Azure 流量管理器支持的流量路由方法。可以使用这些方法将最终用户引导到正确的服务终结点。

> [AZURE.NOTE] 适用于流量管理器的 Azure Resource Manager (ARM) API 使用的术语不同于 Azure 服务管理 (ASM) API。引入此项更改是为了响应客户的反馈，目的是让术语更加明确，减少常见的误解。我们将在此页使用 ARM 术语。差异表现在：

>- 在 ARM 中，我们使用“流量路由方法”来描述如何使用相应的算法来确定在特定的时间应将特定的最终用户引导到哪个终结点。在 ASM 中，我们称之为“负载平衡方法”。

>- 在 ARM 中，我们使用“加权”来表示跨所有可用终结点根据为每个终结点定义的权重分配流量的流量路由方法。在 ASM 中，我们称之为“轮询”。
>- 在 ARM 中，我们使用“优先级”来表示将所有流量定向到有序列表中第一个可用终结点的流量路由方法。在 ASM 中，我们称之为“故障转移”。

> 在所有示例中，唯一区别是命名。功能没有区别。


Azure 流量管理器支持使用多种算法来确定如何将最终用户路由到不同的服务终结点。这些算法称为流量路由方法。对每个接收的 DNS 查询应用流量路由方法后，即可确定应在 DNS 响应中返回哪个终结点。

流量管理器中提供了三种流量路由方法：

- **优先级：**如果你想要使用主服务终结点来处理所有流量，并提供了后备终结点来防范主终结点或后备终结点不可用的情况，则可选择“优先级”。有关详细信息，请参阅[优先级流量路由方法](#priority-traffic-routing-method)。

- **加权：**如果你想要跨一组终结点来分配流量，不管是平均分配还是根据所定义的权重进行分配，则可选择“加权”。有关详细信息，请参阅[加权流量路由方法](#weighted-traffic-routing-method)。

- **性能**：如果终结点位于不同的地理位置，并且你希望最终用户依据最低网络延迟使用“最近的”终结点，则可选择“性能”。有关详细信息，请参阅[性能流量路由方法](#performance-traffic-routing-method)。

> [AZURE.NOTE] 所有流量管理器配置文件都包括持续监视终结点运行状况以及终结点自动故障转移的设置。所有流量路由方法都支持此设置。有关详细信息，请参阅[流量管理器终结点监视](/documentation/articles/traffic-manager-monitoring/)。

一个流量管理器配置文件只能使用一种流量路由方法。你可以随时为配置文件选择其他流量路由方法。1 分钟内即可应用所做的更改，不会导致停机。
可以通过嵌套式流量管理器配置文件来组合使用多种流量路由方法。这样可以创建复杂且灵活的流量路由配置，以满足更大型、更复杂应用程序的需求。有关详细信息，请参阅[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/)。

##<a name="priority-traffic-routing-method"></a> 优先级流量路由方法

通常情况下，组织需要确保其服务的可靠性，因此需提供一项或多项后备服务来防范主服务发生故障的情况。Azure 客户可以通过“优先级”流量路由方法来轻松实现此故障转移模式。

![Azure 流量管理器的“优先级”流量路由方法][1]

流量管理器配置文件配置了包含服务终结点的优先级列表。默认情况下，所有最终用户流量都会发送到主终结点（优先级最高）。如果主终结点不可用（根据已配置终结点的“已启用/已禁用”状态以及正在进行的终结点监视情况来判断），则会将用户引导到第二个终结点。如果主终结点和辅助终结点都不可用，流量将转到第三个终结点，依此类推。

对终结点优先级的配置在 ARM API（以及新的 Azure 门户预览）和 ASM API（以及经典管理门户）中是按不同方式进行的：

- 在 ARM API 中，终结点优先级是使用为每个终结点定义的“priority”属性显式配置的。该属性的值必须间于 1 到 1000 之间，值越小表示优先级越高。两个终结点的优先级值不能相同。该属性为可选，在省略的情况下，将会根据终结点顺序使用默认优先级。

- 在 ASM API 中，终结点优先级是根据终结点在配置文件定义中的排列顺序显式配置的。你还可以在 Azure 经典管理门户的配置文件的“配置”页上配置故障转移顺序。

##<a name="weighted-traffic-routing-method"></a> 加权流量路由方法

若要确保高可用性并最大程度地提高服务利用率，常用方法是提供一组终结点并跨所有终结点分配流量，不管是平均分配还是按预定义权重进行分配。可以使用“加权”流量路由方法来执行此操作。

![Azure 流量管理器的“加权”流量路由方法][2]

在“加权”流量路由方法中，每个终结点都会在进行流量管理器配置文件配置时分配一个权重。每个权重都是一个从 1 到 1000 的整数。此参数为可选，在省略的情况下使用默认权重“1”。
  
最终用户流量跨所有的可用服务终结点进行分配（分配依据是已配置终结点的“已启用/已禁用”状态以及正在进行的终结点监视情况）。每收到一个 DNS 查询，系统就会随机选择一个可用终结点，选择概率取决于分配给该终结点和其他可用终结点的权重。

如果所有终结点都使用相同的权重，则会平均分配流量，这适用于一组相同的终结点需要实现一致的利用率的情况。对特定终结点使用较高（或较低）的权重会导致这些终结点在 DNS 响应中的返回次数较多（或较少），因此接收的流量也较多（或较少）。你可以据此启用许多有用的方案：

- 应用程序逐步升级：分配要路由到新终结点的流量百分比，并随着时间的推移逐渐将流量增加到 100％。

- 到 Azure 的应用程序迁移：创建一个包含 Azure 和外部终结点的配置文件，并为要路由到每个终结点的流量指定权重。

- 适用于更多容量的云爆发：通过将本地部署放在流量管理器配置文件之后，快速将本地部署扩展到云中。当你需要在云中获得额外的容量时，可以添加或启用更多终结点，并指定哪部分流量将流向每个终结点。

“加权”流量路由可以通过新的 Azure 门户预览进行配置，但权重不能通过经典管理门户进行配置。它还可以使用 Azure PowerShell、Azure CLI 和 Azure REST API 通过 ARM 和 ASM 进行配置。

注意：DNS 响应可以通过客户端以及这些客户端进行 DNS 查询时所使用的递归 DNS 服务器进行缓存。必须了解这种缓存对加权流量分配造成的潜在影响。如果客户端和递归 DNS 服务器的数目大（典型的面向 Internet 的应用程序就是如此情况），则流量分配会正常进行。但是，如果客户端或递归 DNS 服务器的数目小，则这种缓存可能会严重影响流量分配。可能会发生这种情况的常见用例包括：

- 开发和测试环境
- 应用程序间通信
- 面向的用户群（例如组织员工用户群）较小的应用程序，这些应用程序共享通用的递归 DNS 基础结构。

这些 DNS 缓存影响常见于所有基于 DNS 的流量路由系统，不只存在于 Azure 流量管理器上。在某些情况下，显式清除 DNS 缓存可能会解决问题。在另外一些情况下，可能更适合使用替代性流量路由方法。

##<a name="performance-traffic-routing-method"></a> 性能流量路由方法

可以将终结点部署在全球两个或两个以上的位置，并将最终用户路由到“最靠近”他们的位置，这样可以改进许多应用程序的响应能力。“性能”流量路由方法的用途正是这样。

![Azure 流量管理器的“性能”流量路由方法][3]

为了最大程度地提高响应能力，在执行时不一定要求“最靠近”的终结点是地理距离最近的。与之相反，“性能”流量路由方法是根据网络延迟来确定哪个终结点最靠近最终用户。这是通过 Internet 延迟表确定的，该表显示 IP 地址范围与每个 Azure 数据中心之间的往返时间。

流量管理器检查每个传入 DNS 请求，并在 Internet 延迟表中查看该请求的源 IP 地址。这决定了从该 IP 地址到每个 Azure 数据中心的延迟。然后，流量管理器会根据已配置终结点的“已启用/已禁用”状态以及正在进行的终结点监视情况选取延迟最低的可用终结点，并在 DNS 响应中返回该终结点。然后，最终用户会被引导到延迟最低（因此也是性能最强）的终结点。

如[流量管理器工作原理](/documentation/articles/traffic-manager-how-traffic-manager-works/)中所述，流量管理器不直接从最终用户接收 DNS 查询，而是从用户按配置应使用的递归 DNS 服务处接收。因此，用于确定“最靠近”终结点的 IP 地址不是最终用户的 IP 地址，而是其递归 DNS 服务的 IP 地址。在实践中，该 IP 地址适合充当最终用户此方面用途的代理。

为了反映全球 Internet 的变化以及所添加的新 Azure 区域，流量管理器会定期更新所使用的 Internet 延迟表。但是，这没法考虑整个 Internet 在性能或负载方面的实时差异。

“性能”流量路由不考虑给定服务终结点上的负载，不过，流量管理器将会监视终结点，如果终结点不可用，则不将这些终结点包含在 DNS 查询响应中。

需要注意的要点：

- 如果配置文件包含同一 Azure 区域的多个终结点，则定向到该区域的流量将在可用终结点中平均分布（具体取决于已配置终结点的“已启用/已禁用”状态和正在进行的终结点监视情况）。若要在某个区域中对流量采用其他分配方式，则可使用[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/)来完成。

- 如果给定 Azure 区域中的所有已启用终结点均已降级（根据正在进行的终结点监视情况来判断），则这些终结点的流量将分布到配置文件中指定的所有其他可用终结点，而不是分布到接下来最近的终结点。这有助于避免当下一个最靠近的终结点过载时可能发生的级联失败。如果你想要定义终结点故障转移顺序，则可使用[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/)来完成。

- 对外部终结点或嵌套式终结点使用“性能”流量路由方法时，需要指定这些终结点的位置。选择最靠近你的部署的 Azure 区域--可用选项为 Azure 区域，因为这些区域是 Internet 延迟表所支持的位置。

- 通过算法来选择返回给指定的最终用户的终结点时，该算法的结果是确定性的，不含随机因素。同一客户端重复进行 DNS 查询时，系统会将此类查询定向到同一终结点。但是，不应使用“性能”流量路由方法将给定用户始终路由到给定部署（仅在特定情况下，例如仅在该用户的用户数据存储在一个位置的情况下，才可能需要使用该方法）。这是因为，最终用户在旅行时通常会使用不同的递归 DNS 服务器，因此可能会被路由到其他终结点。更新 Internet 延迟表也可能会影响这些用户。

- 更新 Internet 延迟表时，你可能会注意到，某些客户端可能会被定向到其他终结点。受影响用户数应尽可能小，并应根据当前的延迟数据将更准确的路由反映出来。进行这些更新很重要，可以确保在 Internet 持续发展的情况下“性能”流量路由的准确性。


## 后续步骤

了解如何使用[流量管理器终结点监视](/documentation/articles/traffic-manager-monitoring/)开发高可用性应用程序

了解如何[创建流量管理器配置文件](/documentation/articles/traffic-manager-manage-profiles/)


<!--Image references-->
[1]: ./media/traffic-manager-routing-methods/priority.png
[2]: ./media/traffic-manager-routing-methods/weighted.png
[3]: ./media/traffic-manager-routing-methods/performance.png

<!---HONumber=Mooncake_0627_2016-->