<properties
    pageTitle="嵌套式流量管理器配置文件 | Azure"
    description="本文介绍了 Azure 流量管理器的“嵌套式配置文件”功能"
    services="traffic-manager"
    documentationCenter=""
    authors="sdwheeler"
    manager="carmonm"
    editor=""
/>  

<tags
    ms.service="traffic-manager"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="infrastructure-services"
    ms.date="03/22/2017"
    wacn.date="05/31/2017"
    ms.author="sewhee"
/>  


# 嵌套式流量管理器配置文件

流量管理器包含一系列流量路由方法，可用于控制流量管理器如何选择具体的终结点来从每个最终用户处接收流量。有关详细信息，请参阅[流量管理器流量路由方法](/documentation/articles/traffic-manager-routing-methods/)。

每个流量管理器配置文件都会指定一个流量路由方法。但在某些情况下，所需的流量路由方法比单个流量管理器配置文件所提供的方法更复杂。可以嵌套流量管理器配置文件，将多个流量路由方法的优势结合在一起。使用嵌套式配置文件可以重写默认的流量管理器行为，支持更大、更复杂的应用程序部署。

以下示例演示如何在不同的方案中使用嵌套式流量管理器配置文件。

## 示例 1：组合使用“性能”和“加权”流量路由

假设在以下 Azure 区域部署了一个应用程序：中国北部和中国东部。你使用流量管理器的“性能”流量路由方法将流量分发到最靠近用户的区域。

![单个流量管理器配置文件][4]  


现在，假设你要针对服务的某项更新进行测试，然后再推广该更新。你想要使用“加权”流量路由方法，以便将少部分流量定向到测试部署。你在西欧设置了测试部署以及现有的生产部署。

无法在单个配置文件中结合使用“加权”和“性能”流量路由方法。若要支持此方案，可以使用位于中国东部的两个站点 1 终结点和“加权”流量路由方法创建流量管理器配置文件。接下来，将此“子”配置文件作为终结点添加到“父”配置文件。父配置文件仍使用“性能”流量路由方法，并且仍包含终结点形式的其他全局部署。

下图演示了此示例：

![嵌套式流量管理器配置文件][2]  


在此配置中，通过父配置文件定向的流量可跨区域正常分发。在中国东部的站点 1 中，嵌套式配置文件根据分配的权重将流量分发到生产和测试终结点。

当父配置文件使用“性能”流量路由方法时，必须为每个终结点分配一个位置。可在配置终结点时分配该位置。请选择离你的部署最近的 Azure 区域。Azure 区域是 Internet 延迟表支持的位置值。有关详细信息，请参阅 [Traffic Manager 'Performance' traffic-routing method](/documentation/articles/traffic-manager-routing-methods/#performance-traffic-routing-method)（流量管理器“性能”流量路由方法）。

## 示例 2：嵌套式配置文件中的终结点监视

流量管理器会主动监视每个服务终结点的运行状况。如果终结点不正常，流量管理器会将用户定向到替代终结点，保持服务的可用性。这种终结点监视和故障转移行为适用于所有流量路由方法。有关详细信息，请参阅 [Traffic Manager Endpoint Monitoring](/documentation/articles/traffic-manager-monitoring/)（流量管理器终结点监视）。终结点监视的工作方式不同于嵌套式配置文件。对于嵌套式配置文件，父配置文件不会针对子配置文件直接执行运行状况检查。子配置文件的终结点运行状况用于计算子配置文件的总体运行状况。此运行状况信息将在嵌套式配置文件层次结构中向上传播。父配置文件使用此聚合运行状况信息确定是否将流量定向到子配置文件。有关嵌套式配置文件运行状况监视的完整详细信息，请参阅[常见问题](/documentation/articles/traffic-manager-FAQs/#traffic-manager-nested-profiles)。

回到前面的示例，假设西欧的生产部署发生故障。默认情况下，“子”配置文件会将所有流量定向到测试部署。如果测试部署也发生故障，父配置文件将确定子配置文件是否不应接收流量，因为所有子终结点都不正常。然后，父配置文件将流量分发到其他区域。

![嵌套式配置文件故障转移（默认行为）][3]  


你可能对这种流程感到满意。或者，你可能担心中国东部站点 1 的所有流量（而不是有限数量的流量）现在都会转到测试部署。不管测试部署的运行状况如何，你都希望区域中国东部站点 1 中的生产部署发生故障时，能够故障转移到其他区域。若要启用这种故障转移，可以在将子配置文件配置为终结点时，在父配置文件中指定“MinChildEndpoints”参数。该参数确定子配置文件中可用终结点的最小数目。默认值为“1”。在本方案中，可将 MinChildEndpoints 值设置为 2。如果低于此阈值，父配置文件会将整个子配置文件视为不可用，并将流量定向到其他终结点。

下图演示了此配置：

![嵌套式配置文件故障转移，“MinChildEndpoints”设置为 2][4]  


>[AZURE.NOTE]
“优先级”流量路由方法将所有流量分发到单个终结点。因此，为子配置文件设置除“1”以外的 MinChildEndpoints 值几乎没有作用。

## 示例 3：“性能”流量路由中的优先故障转移区域

“性能”流量路由方法的默认行为旨在避免下一个最靠近的终结点发生过载并导致一系列的连锁故障。当某个终结点发生故障时，定向到该终结点的所有流量将均匀分布到所有区域中的其他终结点。

![默认故障转移的“性能”流量路由][5]  


但是，假设你希望将中国东部站点 1 的流量故障转移到中国北部，仅当这两个终结点都不可用时才将流量定向到其他区域。可以使用包含“优先级”流量路由方法的子配置文件创建此解决方案。

![首选故障转移的“性能”流量路由][6]  


由于中国东部站点 1 终结点的优先级高于中国北部终结点，因此当两个终结点都处于联机状态时，所有流量将发送到中国东部站点 1 终结点。如果中国东部站点 1 发生故障，则其流量会定向到中国北部。如果嵌套式配置文件，仅当中国东部站点 1 和中国北部站点 2 都发生故障时，流量才定向到中国东部。

可以针对所有区域重复此模式。将父配置文件中的所有三个终结点替换为三个子配置文件，每个子配置文件提供故障转移优先顺序。

## <a name="example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region"></a>示例 4：控制同一区域中多个终结点之间的“性能”流量路由

假设在配置文件中使用“性能”流量路由方法时，该配置文件在特定区域有多个终结点。默认情况下，定向到该区域的流量会平均分布到该区域的所有可用终结点。

![“性能”流量路由区域内流量分布（默认行为）][7]  


无需在西欧添加多个终结点，这些终结点会包含在单独的子配置文件中。子配置文件将作为西欧的唯一终结点添加到父配置文件。子配置文件中的设置可以通过在西欧启用基于优先级或加权的流量路由，控制西欧的流量分布。

![“性能”流量路由，自定义区域内流量分布][8]  


## <a name="example-5-per-endpoint-monitoring-settings"></a>示例 5：基于终结点的监视设置

假设你希望使用流量管理器来顺利地将流量从旧的本地网站迁移到基于云的新版网站（托管在 Azure 中）。对于旧站点，你想要使用主页 URI 监视站点运行状况。但对于基于云的新版站点，你要实现一个包含附加检查的自定义监视页面（路径为“/monitor.aspx”）。

![流量管理器终结点监视（默认行为）][9]  


流量管理器配置文件中的监视设置将应用到单个配置文件中的所有终结点。使用嵌套式配置文件时，可为每个站点使用一个不同的子配置文件来定义不同的监视设置。

![按终结点进行设置的流量管理器终结点监视][10]  


## <a name="faq"></a>常见问题解答

### 如何配置嵌套式配置文件？

可以使用 Azure Resource Manager、经典 Azure REST API、Azure PowerShell cmdlet 和跨平台 Azure CLI 命令配置嵌套式流量管理器配置文件。也支持通过新 Azure 门户配置这些配置文件。不支持使用经典管理门户。

### 流量管理器支持多少层嵌套？

配置文件的嵌套最深可达 10 层。不允许使用“循环”。

### 能否在同一流量管理器配置文件中将其他终结点类型与嵌套式子配置文件混合在一起使用？

是的。至于如何在一个配置文件中组合使用不同类型的终结点，并无任何限制。

### 嵌套式配置文件如何应用计费模型？

使用嵌套式配置文件在价格方面不会给你带来负面影响。

流量管理器计费分两部分：终结点运行状况检查以及数百万的 DNS 查询

- 终结点运行状况检查：在父配置文件中将子配置文件配置为终结点时，不对子配置文件收费。在子配置文件中监视终结点按正常方式计费。
- DNS 查询：每个查询仅统计一次。对父配置文件执行查询时，如果返回了子配置文件中的终结点，则仅统计父配置文件。

有关完整详细信息，请参阅[流量管理器定价页](/pricing/details/traffic-manager/)。

### 嵌套式配置文件是否会造成性能影响？

否。使用嵌套式配置文件不会造成性能影响。

在处理每个 DNS 查询时，流量管理器名称服务器会在内部遍历配置文件层次结构。对父配置文件执行 DNS 查询可能会收到终结点来自子配置文件的 DNS 响应。不管使用的是单个配置文件还是嵌套式配置文件，都只使用一条 CNAME 记录。不需要在层次结构中为每个配置文件创建一条 CNAME 记录。

### 在父配置文件中，流量管理器如何计算嵌套式终结点的运行状况？

父配置文件不会针对子配置文件直接执行运行状况检查。子配置文件的终结点运行状况用于计算子配置文件的总体运行状况。此信息在嵌套式配置文件层次结构中向上传播，确定嵌套式终结点的运行状况。父配置文件使用此聚合运行状况信息确定是否可将流量定向到子配置文件。

下表描述了针对嵌套式终结点执行的流量管理器运行状况检查的行为。

|子配置文件监视器状态|父级终结点监视器状态|说明|
|---|---|---|
|已禁用。子配置文件已禁用。|已停止|父级终结点状态为“已停止”，而不是“已禁用”。“已禁用”状态保留用于指示你已在父配置文件中禁用了终结点。|
|已降级。至少一个子配置文件终结点处于“已降级”状态。| 联机：子配置文件中的“联机”终结点数量至少为 MinChildEndpoints 的值。<BR>正在检查终结点：子配置文件中的“联机”加“正在检查终结点”终结点的数量至少为 MinChildEndpoints 的值。<BR>已降级：处于其他情况。|流量将路由到状态为“正在检查终结点”的终结点。如果将 MinChildEndpoints 设置得过高，终结点将始终处于降级状态。|
|联机。至少一个子配置文件终结点处于“联机”状态。没有任何终结点处于“已降级”状态。|见上。||
|正在检查终结点。至少一个子配置文件终结点处于“正在检查终结点”状态。没有任何终结点处于“联机”或“已降级”状态|同上。||
|非活动。所有子配置文件终结点都处于“Disabled”或“Stopped”状态，除非这是没有终结点的配置文件。|已停止||


## 后续步骤

详细了解[流量管理器工作原理](/documentation/articles/traffic-manager-overview/)

了解如何[创建流量管理器配置文件](/documentation/articles/traffic-manager-manage-profiles/)

<!--Image references-->

[1]: ./media/traffic-manager-nested-profiles/figure-1.png
[2]: ./media/traffic-manager-nested-profiles/figure-2.png
[3]: ./media/traffic-manager-nested-profiles/figure-3.png
[4]: ./media/traffic-manager-nested-profiles/figure-4.png
[5]: ./media/traffic-manager-nested-profiles/figure-5.png
[6]: ./media/traffic-manager-nested-profiles/figure-6.png
[7]: ./media/traffic-manager-nested-profiles/figure-7.png
[8]: ./media/traffic-manager-nested-profiles/figure-8.png
[9]: ./media/traffic-manager-nested-profiles/figure-9.png
[10]: ./media/traffic-manager-nested-profiles/figure-10.png

<!---HONumber=Mooncake_Quality_Review_0104_2017-->