<properties
    pageTitle="流量管理器终结点监视和故障转移 | Azure"
    description="本文有助于你了解，流量管理器如何通过终结点监视和终结点自动故障转移来帮助 Azure 客户部署高可用性应用程序。"
    services="traffic-manager"
    documentationCenter=""
    authors="sdwheeler"
    manager="carmonm"
    editor=""
/>  

<tags
    ms.service="traffic-manager"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="infrastructure-services"
    ms.date="03/16/2017"
    wacn.date="04/27/2017"
    ms.author="sewhee"
/>  


# 流量管理器终结点监视和故障转移

Azure 流量管理器包括内置的终结点监视和终结点自动故障转移功能。此功能可以让你更好地交付高可用性应用程序，以便应对终结点故障（包括 Azure 区域故障）。


## 配置终结点监视

若要配置终结点监视，必须在流量管理器配置文件中指定以下设置：

- **协议**。选择 HTTP 或 HTTPS。请务必注意，HTTPS 监视并不验证 SSL 证书是否有效，它只检查是否有证书。
- **端口**。选择用于请求的端口。
- **路径**。指定监视功能要访问的网页或文件的相对路径和名称。正斜杠 (/) 是相对路径的有效条目。此值表示文件位于根目录中（默认设置）。

为了检查每个终结点的运行状况，流量管理器会使用给定的协议、端口和相对路径向终结点发出 GET 请求。

常见的做法是在应用程序中实现一个自定义页面，例如 /health.aspx。为监视使用此路径可以执行应用程序特定的检查，例如，检查性能计数器或者验证数据库可用性。页面根据这些自定义检查返回相应的 HTTP 状态代码。

流量管理器配置文件中的所有终结点共享监视设置。如果需要对不同的终结点使用不同的监视设置，可以创建[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/#example-5-per-endpoint-monitoring-settings)。

## <a name="endpoint-and-profile-status"></a>终结点和配置文件状态

你可以启用和禁用流量管理器配置文件和终结点。不过，也可以通过流量管理器的自动设置和过程来更改终结点状态。

### 终结点状态

可以启用或禁用特定的终结点。可能仍处于正常状态的基础服务不受影响。更改终结点状态可以控制流量管理器配置文件中终结点的可用性。当某个终结点的状态为已禁用时，流量管理器不会检查其运行状况，该终结点不会包括在 DNS 响应中。

### 配置文件状态

使用配置文件状态设置可以启用或禁用特定的配置文件。终结点状态影响单个终结点，而配置文件状态会影响整个配置文件（包括所有终结点）。禁用某个配置文件时，不会检查终结点的运行状况，并且不会在 DNS 响应中包括任何终结点。将会针对 DNS 查询返回 [NXDOMAIN](https://tools.ietf.org/html/rfc2308) 响应代码。

### 终结点监视器状态

终结点监视器状态是流量管理器生成的值，显示终结点的状态。不能手动更改此设置。终结点监视状态是终结点监视结果与所配置端点状态的组合。下表显示了终结点监视状态的可能值：

|配置文件状态|终结点状态|终结点监视器状态|说明|
|---|---|---|---|
|已禁用|Enabled|非活动|配置文件已禁用。尽管终结点状态为“已启用”，但配置文件状态（“已禁用”）优先。不会监视已禁用配置文件中的终结点。将会针对 DNS 查询返回 NXDOMAIN 响应代码。|
|&lt;任意&gt;|已禁用|已禁用|终结点已禁用。不会监视已禁用的终结点。该终结点不会包括在 DNS 响应中，因此也不会接收流量。|
|Enabled|Enabled|联机|终结点受到监视，处于正常状态。该终结点会包括在 DNS 响应中，并且可以接收流量。|
|Enabled|Enabled|已降级|监视运行状况检查的终结点将要发生故障。该终结点不会包括在 DNS 响应中，也不会接收流量。|
|Enabled|Enabled|正在检查终结点|终结点受监视，但是，尚未收到首个探测的结果。“正在检查终结点”是一种临时状态，在配置文件中添加或启用终结点后，通常会立即出现这种状态。处于此状态的终结点会包括在 DNS 响应中，并且可以接收流量。|
|Enabled|Enabled|已停止|终结点指向的云服务或 Web 应用未运行。检查云服务或 Web 应用设置。不会监视“已停止”状态的终结点。该终结点不会包括在 DNS 响应中，也不会接收流量。|

有关如何为嵌套式终结点计算终结点监视状态的详细了解，请参阅[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/)。

### 配置文件监视器状态

配置文件监视状态是配置的配置文件状态与所有终结点的终结点监视状态值的组合。下表描述了可能的值：

|配置文件状态（已配置）|终结点监视器状态|配置文件监视器状态|说明|
|---|---|---|---|
|已禁用|&lt;任意&gt; 或包含未定义终结点的配置文件。|已禁用|配置文件已禁用。|
|Enabled|至少一个终结点的状态为“已降级”。|已降级|查看各终结点状态值，确定哪些终结点需要进一步的关注。|
|Enabled|至少一个终结点的状态为“联机”。没有任何终结点的状态为“已降级”。|联机|服务正在接受流量。无需进一步执行操作。|
|Enabled|至少一个终结点的状态为“正在检查终结点”。没有任何终结点为“联机”或“已降级”状态。|正在检查终结点|创建或启用配置文件时，将出现这种过渡状态。正在首次检查终结点的运行状况。|
|Enabled|配置文件中所有终结点的状态为“已禁用”或“已停止”，或者配置文件中没有定义终结点。|非活动|没有任何终结点处于活动状态，但是配置文件的状态仍旧是“已启用”。|

## 终结点故障转移和恢复

流量管理器定期检查每个终结点（包括不正常的终结点）的运行状况。当终结点恢复正常时，流量管理器可以检测到这种状态，并将其重新加入轮转列表。

>[AZURE.NOTE] 只有当返回消息为“200 正常”时，流量管理器才会认为终结点处于联机状态。发生以下任一事件时，终结点将变得不正常：
><p>- 收到非 200 响应（包括其他 2xx 代码，或者 301/302 重定向）
><p>- 客户端身份验证请求
><p>- 超时（超时阈值为 10 秒）
><p>- 无法连接

>有关针对失败的检查进行故障排除的详细信息，请参阅 [Troubleshooting Degraded status on Azure Traffic Manager](/documentation/articles/traffic-manager-troubleshooting-degraded/)（排查 Azure 流量管理器中的降级状态）。

以下时间线详细描述了监视过程。

![流量管理器终结点故障转移和故障回复顺序](./media/traffic-manager-monitoring/timeline.png)  


1. **GET**。对于每个终结点，流量管理器监视系统将对监视设置中指定的路径和文件执行 GET 请求。
2. **200 正常**。监视系统预期在 10 秒内会返回一条“HTTP 200 正常”消息。如果收到该响应，该系统会认为云服务可用。
3. **每隔 30 秒检查**。终结点运行状况检查每隔 30 秒重复一次。
4. **服务不可用**。该服务变得不可用。在下次执行运行状况检查前，流量管理器不会知道该服务是否可用。
5. **尝试访问监视文件（四次尝试）**。监视系统执行了 GET 请求，但没有在 10 秒的超时期间内收到响应（也可能收到的是非 200 响应）。然后又尝试了三次，每隔 30 秒一次。如果其中一次尝试成功，尝试次数就会重置。
6. **状态设置为“已降级”**。第四次连续失败后，监视系统将不可用终结点的状态标记为“已降级”。
7. **流量转移到其他终结点**。流量管理器 DNS 名称服务器进行更新，流量管理器不再返回终结点来响应 DNS 查询。新连接将定向到其他可用终结点。不过，包含此终结点的 DNS 响应可能仍由递归 DNS 服务器和 DNS 客户端缓存。在 DNS 缓存过期之前，客户端将一直使用该终结点。DNS 缓存过期后，客户端将发出新的 DNS 查询并定向到其他终结点。缓存持续时间由流量管理器配置文件中的 TTL 设置控制，例如，可以将其设置为 30 秒。
8. **继续进行运行状况检查**。在终结点的状态为“已降级”后，流量管理器会继续检查该终结点的运行状况。当终结点恢复正常时，流量管理器可检测到这种状态。
9. **服务重新联机**。该服务变得可用。终结点会在流量管理器中始终保持“已降级”状态，直至监视系统执行下一次运行状况检查。
10. **继续将流量定向到服务**。流量管理器发送 GET 请求，然后收到“200 正常”状态响应。服务已恢复正常状态。流量管理器名称服务器进行更新，并开始在 DNS 响应中分发服务的 DNS 名称。当缓存的 DNS 响应（返回其他终结点）到期时，以及现有的到其他终结点的连接终止时，流量将返回到该终结点。

>[AZURE.NOTE] 由于流量管理器是在 DNS 级别工作的，因此不可能影响任何终结点的现有连接。在终结点之间引导流量时（不管是通过更改配置文件设置来进行，还是在故障转移或故障回复期间进行），流量管理器都会将新连接引导到可用的终结点。不过，其他终结点可能仍会通过现有连接继续接收流量，直至相关会话被终止。若要耗尽现有连接的流量，应通过应用程序来限制适用于每个终结点的会话持续时间。

## 流量路由方法

当某个终结点处于“已降级”状态时，不再会在 DNS 查询的响应中返回该终结点。而是选择一个替代终结点并将其返回。配置文件中配置的流量路由方法确定如何选择替代的终结点。

- **优先级**。终结点构成一个采用优先级的列表。将始终返回列表中第一个可用的终结点。如果终结点状态为“已降级”，则返回下一个可用的终结点。
- **加权**。根据分配的权重以及其他可用终结点的权重随机选择任何可用的终结点。
- **性能**。返回最靠近最终用户的终结点。如果该终结点不可用，则从其他所有可用的终结点中随机选择一个终结点。选择随机终结点可以避免下一个最靠近的终结点过载时发生连锁故障。可以使用[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region)针对性能流量路由来配置替代故障转移计划。

有关详细信息，请参阅[流量管理器流量路由方法](/documentation/articles/traffic-manager-routing-methods/)。

>[AZURE.NOTE] 当所有符合条件的终结点处于降级状态时，正常的流量路由行为会发生一种例外情况。流量管理器“尽最大努力”尝试，*其响应就好像所有处于“已降级”状态的终结点实际上处于联机状态一样*。这种行为要优于替代方法，后者不会在 DNS 响应中返回任何终结点。已禁用或已停止的终结点不受监视，因此，认为它们不符合接收流量的条件。

>这种状态通常是服务配置不当造成的，例如：
><p>    - 某个访问控制列表 (ACL) 正在阻止流量管理器运行状况检查
><p>    - 流量管理器配置文件中的监视路径配置不当

>此行为的一个结果是，即使流量管理器运行状况检查没有正确进行配置，但从流量路由的角度来看，流量管理器似乎也正常运行。但在这种情况下，不能发生会影响应用程序总体可用性的终结点故障转移。必须检查配置文件是否显示“联机”状态而不是“已降级”状态。状态为“联机”表示流量管理器运行状况检查按预期进行。

有关针对失败的运行状况检查进行故障排除的详细信息，请参阅 [Troubleshooting Degraded status on Azure Traffic Manager](/documentation/articles/traffic-manager-troubleshooting-degraded/)（排查 Azure 流量管理器中的降级状态）。

## 常见问题

### 流量管理器能否灵活应对 Azure 区域故障？

流量管理器是在 Azure 中提供高可用性应用程序的关键组件。若要提供高可用性，流量管理器必须具有超高的可用性，并且能够灵活应对区域故障。

在设计上，流量管理器组件能够灵活应对任何 Azure 区域的全面故障。这样的应对能力见于所有流量管理器组件：DNS 名称服务器、API、存储层、终结点监视服务。

在整个 Azure 区域发生服务中断的情况下（这种情况很少见），流量管理器仍可继续正常运行。在多个 Azure 区域中部署的应用程序可以依赖流量管理器将流量定向到这些区域中的可用应用程序实例。

### 选择资源组位置会如何影响流量管理器？

流量管理器属于单一的全局性服务，而不是区域性服务。选择资源组位置对部署在该资源组中的流量管理器配置文件没有影响。

Azure Resource Manager 要求所有资源组指定一个位置，这决定了部署在该资源组中的资源的默认位置。创建流量管理器配置文件时，将在资源组中创建该配置文件。所有流量管理器使用“全局”作为位置，覆盖资源组的默认值。

### 如何确定每个终结点的当前运行状况？

除了整个配置文件以外，每个终结点的当前监视状态也会显示在 Azure 门户中。此信息也可通过流量监视器 [REST API](https://msdn.microsoft.com/zh-cn/library/azure/mt163667.aspx)、[PowerShell cmdlet](https://msdn.microsoft.com/zh-cn/library/mt125941.aspx) 和[跨平台 Azure CLI](/documentation/articles/xplat-cli-install/) 获取。

Azure 不提供有关过去终结点运行状况的历史信息，也不提供在终结点运行状况发生变化时引发警报的功能。

### 能否监视 HTTPS 终结点？

是的。流量管理器支持通过 HTTPS 进行探测。在监视配置中将 **HTTPS** 配置为协议。

流量管理器无法提供任何证书验证，包括：

- 不验证服务器端证书
- 不支持 SNI 服务器端证书
- 不支持客户端证书

### 终结点运行状况检查使用什么主机头？

流量管理器在 HTTP 和 HTTPS 运行状况检查中使用 host 标头。流量管理器使用的 host 标头是在配置文件中配置的终结点目标名称。在主机头中使用的值不能通过目标属性单独指定。

### 运行状况检查从哪些 IP 地址发起？

以下列表包含流量管理器可从中发起运行状况检查的 IP 地址。可以使用此列表确保终结点上允许来自这些 IP 地址的传入连接，以便能够检查这些终结点的运行状况。

- 13\.75.153.124
- 13\.75.152.253
- 191\.232.214.62
- 191\.232.208.52
- 52\.172.155.168
- 52\.172.158.37
- 13\.75.124.254
- 13\.75.127.63
- 137\.135.82.249
- 137\.135.80.149
- 104\.41.190.203
- 104\.41.187.209
- 65\.52.217.19
- 23\.96.236.252
- 40\.87.147.10
- 40\.87.151.34
- 104\.215.91.84
- 13\.84.222.37
- 40\.68.30.66
- 40\.68.31.178
- 137\.135.47.215
- 137\.135.46.163

## 后续步骤

了解[流量管理器工作原理](/documentation/articles/traffic-manager-overview/)

详细了解流量管理器支持的[流量路由方法](/documentation/articles/traffic-manager-routing-methods/)

了解如何[创建流量管理器配置文件](/documentation/articles/traffic-manager-manage-profiles/)

流量管理器终结点上的[降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded/)

<!---HONumber=Mooncake_Quality_Review_1230_2016-->