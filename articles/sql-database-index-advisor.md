<properties 
   pageTitle="Azure SQL 数据库索引顾问" 
   description="Azure SQL 数据库索引顾问建议你为现有 SQL 数据库使用新索引，这样可以提高当前查询性能。" 
   services="sql-database" 
   documentationCenter="" 
   authors="stevestein" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.date="12/01/2015"
   wacn.date="01/29/2016"/>

# SQL 数据库索引顾问

Azure SQL 数据库索引顾问建议你为现有 SQL 数据库使用新索引，这样可以提高当前查询性能。

SQL 数据库服务通过分析 SQL 数据库的历史资源使用状况来评估索引性能，并提供最适合运行数据库的典型工作负荷的索引建议。

索引顾问提供有关创建哪些索引的建议，使索引管理更容易。对于 V12 服务器，索引顾问还可以创建和验证索引，只需在 [Azure 门户](https://manage.windowsazure.cn)中单击几下即可。创建索引后，SQL 数据库服务将分析数据库工作负荷的性能并提供有关新索引影响的详细信息。如果分析确定建议的索引对性能具有负面影响，则会自动还原索引。

索引顾问可以花费更少的时间优化数据库性能。


> [AZURE.NOTE] 索引顾问目前处于预览状态，仅在 [Azure 门户](https://manage.windowsazure.cn)中提供。


## 预览注意事项

索引顾问目前处于预览状态并具有以下限制：

- 仅可对 V12 服务器自动创建并验证索引建议（为 V12 服务器提供了建议和索引创建脚本）。
- 建议和管理仅可用于非聚集索引。

## 先决条件

若要查看和创建索引建议，需要 Azure 中正确的[基于角色的访问控制](/documentation/articles/role-based-access-control-configure)权限。

- 查看建议需要“读者”、“SQL DB 参与者”权限。
- 执行任何操作（如创建或删除索引、取消创建索引）需要“所有者”、“SQL DB 参与者”权限。


## 使用索引顾问

索引顾问易于使用。若要简化数据库的索引管理，请遵循以下准则：

- 首先查看索引建议列表并决定要创建或忽略的索引。将根据预估性能影响对建议列表进行排序和标记（下面详细介绍）。 
- 创建或忽略建议的索引。单击门户中的“创建索引”自动创建索引，或通过运行索引创建脚本手动创建索引。
- 对于手动创建的索引，应监视创建过程并测量性能影响。对于自动创建的索引，Azure SQL 数据库服务将自动执行监视和性能影响分析。 



## 查看建议的索引

索引顾问在 [Azure 门户](https://manage.windowsazure.cn)中的数据库边栏选项卡上提供了索引建议列表。所选数据库的每个表中都显示了前几个常选的建议，在该数据库中创建新索引可能提供性能提升。

### 若要查看当前可用索引建议：

1. 登录到 [Azure 门户](https://manage.windowsazure.cn)。
2. 在左侧菜单中，单击“浏览”。
3. 在“浏览”边栏选项卡中，单击“SQL 数据库”。
4. 在“SQL 数据库”边栏选项卡中，单击想要查看其建议索引的数据库。
5. 单击“索引顾问”以打开并查看所选数据库的可用“索引建议”。

> [AZURE.NOTE] 若要获取索引建议，数据库需要具有一周左右的使用量，且该周内需要有一些活动。此外也需要一些一致的活动。索引顾问优化一致的查询模式比优化随机的突发活动更加轻松。

![建议的索引][3]

按其对性能的潜在影响将建议分为以下 4 个类别：

| 影响 | 说明 |
| :--- | :--- |
| 高 | 高影响建议应提供最重要的性能影响。 |
| 极大 | 极大影响建议应显著提升性能。 |
| 中等 | 中等影响建议应提高性能，但提升程度不大。 |
| 低 | 低影响建议提供的性能比没有索引时更好，但改进可能不明显。 
使用影响标记来确定最适合用于创建新索引的候选建议。

### 管理建议索引的列表

如果你的建议索引列表包含你认为不会有用的索引，索引顾问可让你放弃此索引建议（如果需要，之后你可以将放弃的索引添加回“建议索引”列表）。

#### 放弃索引建议

1. 在“建议索引”列表中选择索引。
1. 在“索引详细信息”边栏选项卡上单击“放弃索引”。

#### 查看放弃的索引，并将其添加回主列表

1. 在“索引建议”边栏选项卡上，单击“查看放弃的索引建议”。
1. 从列表中选择一个放弃的索引，查看其详细信息。
1. 根据需要单击“撤消放弃”，将索引重新添加到“索引建议”的主列表。



## 创建新的索引

索引顾问让你完全控制索引的创建方式。每一项建议提供一个 T-SQL 索引创建脚本，在数据库中执行任何操作之前，可查看将如何创建索引的准确详细信息。

索引建议可用于所有 Azure SQL 数据库服务器，但只有 V12 服务器提供自动化索引创建。非 V12 服务器仍可以利用索引顾问，但必须按如下所述手动创建索引。

对于自动和手动索引创建，只需从“索引建议”边栏选项卡选择一个建议的索引，并执行以下操作：

### 自动创建索引（仅适用于 V12 服务器）

如果数据库位于 V12 服务器，则可通过在门户上选择所需索引，然后单击“创建索引”来轻松创建建议的索引。

在创建索引期间，数据库保持联机状态，使用索引顾问创建索引不会使数据库脱机。

此外，使用“创建索引”创建的索引不需要任何进一步的性能监视。如果索引对性能有负面影响，索引会自动还原。使用创建索引后，有关新索引的影响的度量值在门户中有提供。


### 手动创建索引（适用于所有服务器）

在门户中选择任意建议的索引，然后单击“查看脚本”。针对你的数据库运行此脚本以创建建议的索引。不监视和验证手动创建的索引的实际性能影响，因此建议你在创建后监视这些索引以验证它们是否提供性能提升，并调整或删除它们（如有必要）。有关创建索引的详细信息，请参阅[创建索引 (Transact-SQL)](https://msdn.microsoft.com/zh-cn/library/ms188783.aspx)。


### 取消创建索引

处于“挂起”状态的索引可以取消。正在创建的索引（“正在执行”状态）不能取消。

1. 在“索引操作”区域选择任意“挂起”的索引，以便打开“索引详细信息”边栏选项卡。
1. 单击“取消”中止索引创建过程。

## 在创建索引后监视索引操作

创建索引不会在瞬间完成。该门户提供了有关索引操作状态的详细信息。管理索引时，以下是索引可能处于的状态：

| 状态 | 说明 |
| :--- | :--- |
| 挂起 | 创建索引命令已被接收，计划对索引进行创建。 |
| 执行 | 创建索引命令正在运行，当前正在创建索引。 |
| 成功 | 已成功创建索引。 |
| 已失败 | 未能创建索引。这可能是暂时性问题，或可能是表的架构更改所致，并且脚本不再有效。 |
| 还原 | 索引创建过程已被取消，或被认为是非性能的且正被自动还原。 |



![建议的索引][4]



## 删除索引
可以删除使用索引顾问已创建的索引。


1. 在“索引操作”列表中选择一个已成功创建的索引。
1. 单击“索引详细信息”边栏选项卡上的“删除索引”，或单击“查看脚本”以查看删除索引脚本。



## 摘要

索引建议为每个 SQL 数据库提供管理索引创建和分析以及建议最佳索引的自动化体验。单击数据库边栏选项卡上的“索引顾问”磁贴以查看索引建议。



## 后续步骤

监视索引建议并继续应用它们以优化性能。数据库工作负荷是动态的，并且不断地更改。索引顾问将继续监视和建议可能提高数据库性能的索引。


<!--Image references-->
[1]: ./media/sql-database-index-advisor/index-recommendations.png
[2]: ./media/sql-database-index-advisor/index-details.png
[3]: ./media/sql-database-index-advisor/recommended-indexes.png
[4]: ./media/sql-database-index-advisor/index-operations.png

<!---HONumber=Mooncake_0118_2016-->
