<properties
    pageTitle="Azure 微服务简介 | Azure"
    description="概述了为何使用微服务方法生成云应用程序对于开发现代应用程序非常重要，以及 Azure Service Fabric 如何提供一个平台来实现此目的。"
    services="service-fabric"
    documentationcenter=".net"
    author="msfussell"
    manager="timlt"
    editor="" />
<tags
    ms.assetid="fae2be85-0ab4-4cd3-9d1f-e0d95fe1959b"
    ms.service="service-fabric"
    ms.devlang="dotnet"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
    ms.workload="NA"
    ms.date="02/06/2017"
    wacn.date="03/03/2017"
    ms.author="msfussell" />  


# 为什么通过微服务的方法生成应用程序？
作为软件开发人员，我们已知道思考如何将应用程序因数分解成组件部分。这是对象导向、软件抽象和组件化的中心模式。现在，这种因数分解往往以共享库和技术层之间的类与接口呈现。通常采用一种分层方法，有后端存储、中间层业务逻辑和前端用户界面 \(UI\)。过去几年来*的*变化是身为开发人员的我们开始为业务驱动的云生成分布式应用程序。

不断变化的业务需求包括：

* 大规模生成和操作的一项服务，以吸引新地理区域的客户（举例而言）。
* 更快速地提供特性与功能，灵活应对客户的需求。
* 提高资源利用率以降低成本。

这些业务需求影响我们生成应用程序的*方式*。

有关 Azure 实现微服务的方法的详细信息，请阅读[微服务：由云支持的应用程序革新](https://azure.microsoft.com/blog/microservices-an-application-revolution-powered-by-the-cloud/)。

## 单一式设计方法与微服务设计方法
所有应用程序会随着时间而发展。成功的应用程序因为有实用性而发展。失败的应用程序不会发展，最终将被取代。问题在于：你对自己现在的需求了解多少？未来会有何变化？ 例如，假设需要为某个部门生成报告应用程序。你确定该应用程序将保留于公司范围内，而且报告只是短暂存在。选择的方法将不同于生成服务向数千万个客户传送视频内容的方式。

在已知后来可以重新设计应用程序的情况下，有时向外寻求概念证明才是驱动因素。过度设计永不使用的功能并没有太大意义。这就是通常所谓的工程取舍。另一方面，公司谈论生成云时都期望成长和使用量。问题在于成长和规模不可预测。我们想要能够快速创建原型，同时还要了解我们正在通往未来成功的路上。这是简练的启动方法：生成、测量、学习、迭代。

在客户端-服务器时代，我们倾向专注于生成分层式应用程序，每一层采用特定的技术。已针对这些方法派生出*单一式* 应用程序一词。接口通常存在于各层之间，而在一层内的各组件之间采用更紧密耦合的设计。开发人员设计并分解类，将类编译成库，然后链接起来成为一些可执行文件和 DLL。

这类单一式设计方法有一些优点。设计较简单，组件之间通常通过进程间通信 \(IPC\) 调用，因此调用更快。此外，每个人都只测试单一产品，人力资源运用更有效率。缺点是分层之间紧密耦合，无法缩放单独组件。如果需要执行修复或升级，必须等待其他人完成其测试。灵活性更难以发挥。

微服务解决了这些缺点，更密切配合上述业务要求，但它们本身也都有优缺点。微服务的优点是通常各自封装较为简单的业务功能，可独立增加或减少、测试、部署和管理。微服务方法的一个重要优点是团队倾向于以业务方案为导向，而不是以分层方法建议的技术为导向。实际上，较小的团队可以根据客户方案开发微服务，采用他们选择的任何技术。

换句话说，组织不需要为了维护单一式应用程序而将技术标准化。拥有服务的单独团队可以根据团队的专业知识，或什么最适合解决问题，各自发挥所长。实际上，最好使用一组建议的技术，例如特定的 NoSQL 存储或 Web 应用程序框架。

微服务的缺点包括需要管理越来越多的独立实体、处理更复杂的部署和版本控制。微服务之间的网络流量以及相应的网络延迟不断增加。可以通过大量琐碎但却精细的服务来解决性能问题。如果没有工具帮助查看这些依赖性，很难“看到”整个系统。

若要让微服务方法奏效，必须在以下方面制定标准：在通信方式上达成共识，只注重需要从服务获得什么，不在乎僵化的约定。必须在设计的初期定义这些约定，因为之后服务将各自独立更新。使用微服务方法进行设计时，出现的另一个描述是“精细的面向服务的体系结构 SOA”。

***简而言之，微服务设计方法是分离的服务联合，各自独立更改，并达成一致的通信标准。***

随着越来越多云应用的生成，人们发现这种将整体应用分解成独立、方案焦点式服务的做法，在长期上是较好的方法。

## 应用程序开发方法的比较
![Service Fabric 平台应用程序开发][Image1]

* 单一式应用包含域特定的功能，通常按照功能层划分，例如 Web、业务和数据。
* 单一式应用可通过复制到多个服务器/虚拟机/容器上进行扩展。
* 微服务应用程序将单独功能分隔成单独的较小服务。
* 微服务方法可通过独立部署每个服务而扩大，跨服务器/虚拟机/容器创建这些服务的实例。

使用微服务方法进行设计并非适用于所有项目，但确实更符合前面所述的业务目标。如果知道以后没有机会根据需要将代码修改为微服务设计，也许可以一开始就使用单一式方法。较常见的情况是一开始设计单一式应用，可以从需要更高缩放性或灵活性的功能领域开始，分阶段缓慢地将此框架分解。

总而言之，微服务方法是以许多小型服务来组成应用程序。这些服务在部署于计算机群集上的容器中运行。较小的团队可针对方案来开发服务，且每个服务独立进行测试、版本控制、部署和缩放，因此整个应用程序可以不断改进。

## 什么是微服务？
微服务有不同的定义。如果在 Internet 中搜索，可以找到许多有用的资源，了解各种观点和定义。但在微服务的以下大部分特性上，已广泛达成共识：

- 封装客户方案或业务方案。你要解决什么问题？
- 由小型工程团队开发。
- 使用任何编程语言编写并使用任何框架。
- 由独立控制版本、部署及缩放的代码和（可选）状态组成。
- 通过定义完善的接口和协议与其他微服务交互。
- 具有用来解析位置的唯一名称 (URL)。
- 在出现故障时可保持一致且可用。

一言以蔽之：

微服务应用程序是由独立控制版本和可缩放的、以客户为中心的服务组成，这些服务通过标准协议和定义完善的接口彼此通信。


我们在上一部分已介绍了前两点，接下来进一步澄清其他各要点。

### 使用任何编程语言编写并使用任何框架
作为开发人员，我们应该根据本身的技能或服务需求，自由选择所需的语言或框架。在某些服务中，你可能认为 C++ 的性能优点胜于一切，而在其他服务中，C\# 或 Java 的简易管理开发可能才是最重要的。在某些情况下，可能需要使用特定的合作伙伴库、数据存储技术，或向客户端公开服务的方式。

选择技术之后，接下来的课题就是服务的操作或生命周期管理和缩放。

### 允许独立控制版本、部署及缩放的代码和状态
无论选择何种方式编写微服务，代码和（可选）状态都应该独立部署、升级和缩放。这确实是更难以解决的一项问题，因为这归根到底是技术选择问题。在缩放方面，难以了解如何分区（或分片）代码和状态。当代码和状态使用不同的技术时（目前的普遍情况），微服务的部署脚本必须能够妥善缩放两者。这也关乎到灵活性和弹性，以便你可以升级某些微服务，而无需一次性全部升级。

暂时回到单一式方法和微服务方法的比较，下图显示了状态存储方法的差异。

#### 应用程序样式之间的状态存储
![Service Fabric 平台状态存储][Image2]


***左侧的单一式方法有单一数据库和多层的特定技术。***

***右侧是微服务方法，图中显示互连的微服务，其中状态通常以微服务为范围，并使用各种技术。***

在单一式方法中，应用程序通常使用单一数据库。优点是这是单一位置，很容易部署。每个组件可以通过单个表存储其状态。困难之处在于团队必须严格区分状态。无可避免地就想将新的列添加到现有客户表、在表之间执行联接，并且对存储层形成依赖性。发生这种情况后，无法缩放各个组件。

在微服务方法中，每个服务都管理并存储自己的状态。每个服务将负责同时缩放代码和状态，以满足服务的需求。缺点在于，当需要对应用程序的数据创建视图或查询时，必须跨不同的状态存储进行查询。为了解决此问题，通常由一个独立的微服务生成一个跨许多微服务的视图。如果需要对数据执行多个即席查询，每个微服务应该考虑将其数据写入数据仓库服务以供脱机分析。

版本控制特定于部署的微服务版本，以便能够部署和并行运行多个不同的版本。当较新版的微服务在升级期间失败，因而需要回滚到旧版时，版本控制可以解决这种情况。版本控制的另一种情况是执行 A/B 式测试，其中不同的用户将体验到不同版本的服务。例如，在更广泛推出新功能之前，通常先对一组特定的客户升级微服务以测试新功能。在微服务的生命周期管理之后，便可以在微服务之间进行通信。

### 通过定义完善的接口和协议与其他微服务交互
本主题无需花费太多时间，因为过去 10 年来发布了大量关于面向服务的体系结构的文献，其中对通信模式进行了介绍。一般而言，服务通信使用 REST 方法，并配合 HTTP 与 TCP 协议及 XML 或 JSON 作为序列化格式。从接口观点来看，这涉及到采用 Web 设计方法。但是，用户仍然可以使用二进制协议或自己的数据格式。公开的微服务较难使用，因此要有心理准备。

### 具有用来解析位置的唯一名称 \(URL\)
记得我们一直在说，微服务方法与 Web 有点类似吗？ 就像 Web 一样，微服务无论在何处运行，都必须可寻址。如果你还在考虑要在哪一台计算机上运行特定的微服务，很快就会陷入困境。

就像 DNS 解析特定计算机的特定 URL 一样，微服务需要通过唯一的名称发现它目前所在的位置。微服务需要有可寻址的名称才能独立于它们运行所在的基础结构之外。这意味着服务的部署和发现方式之间互相影响，因为需要有服务注册表。同样地，当计算机发生故障时，注册服务必须指出服务现在的运行位置。

接下来的主题：复原能力和一致性。

### 在出现故障时可保持一致且可用
处理意外的故障是最难解决的问题之一，特别是在分布式系统中。开发人员编写的代码大多是在处理异常，这也是测试时花费最多时间的地方。问题比编写代码来处理故障更复杂。当运行微服务的计算机发生故障时，该怎么办？ 你不仅需要检测这种微服务故障（本身就是棘手的问题），还需要设法重新启动微服务。

微服务必须能够从故障复原，出于可用性理由，通常还必须能够在另一台计算机上重新启动。这也涉及到代表微服务所保存的状态、微服务可从何处恢复此状态，以及微服务是否能够成功地重新启动。换句话说，需要能够复原计算（也就是重新启动进程）以及状态或数据（不丢失任何数据，数据保持一致）。

在其他情况下，复原能力的问题更难处理，例如应用程序升级期间失败。在配合部署系统一起运行时，微服务不需要恢复。它还需要确定是要继续升级到更新版本，还是回滚到旧版以维持一致的状态。需要考虑一些问题，例如，是否有足够的计算机用于继续升级，以及如何恢复旧版的微服务。需要微服务发出运行状况信息才能做出这些决定。

### 报告运行状况和诊断
微服务必须报告其运行状况和诊断，这一点看似明显，但却经常被忽视。否则，难以从操作观点上深入了解。面临的难题是关联一组独立服务的诊断事件并修正计算机时钟偏差以识别事件顺序。同样地，通过议定的协议和数据格式与微服务交互时，需要将运行状况和诊断事件的记录方式标准化，这些事件最终将写入可供查询和查看的事件存储。在微服务方法中，关键在于不同团队同意采用单一的日志记录格式。需要通过一致的方法查看整个应用程序中的诊断事件。

运行状况与诊断不同。运行状况是指微服务报告其当前状态，以便采取适当的措施。一个很好的例子便是使用升级和部署机制保持可用性。当前服务可能由于进程崩溃或计算机重新启动而状况不正常，但仍可运行。不应该执行升级而让情况恶化。最好是先进行调查，或让微服务有时间恢复。微服务的运行状况事件有助于我们做出明智的决策，实际上有助于创建自我修复的服务。

## Service Fabric 作为微服务平台

Azure 从提供盒装产品（通常是单一式）转换到提供服务后，Azure Service Fabric 横空问世。生成和操作大型服务（例如 Azure SQL 数据库和 Azure DocumentDB）的经验成就了 Service Fabric。该平台随着越来越多服务采用它而不断发展变化。重要的是，Service Fabric 不仅必须在 Azure 中运行，还必须在独立的 Windows Server 部署中运行。

***Service Fabric 旨在解决构建和运行服务方面的难题，并有效地利用基础结构资源，使团队可以使用微服务方法来解决业务问题。***

Service Fabric 提供两个广泛的领域，帮助用户生成使用微服务方法的应用程序：

* 一个提供系统服务的平台，这些系统服务负责部署、升级、检测和重新启动失败的服务，发现服务位置，管理状态以及监视运行状况。这些系统服务实际上具备上述微服务的许多特性。
* 编程 API 或框架，帮助您将应用程序构建成微服务：[Reliable Actors 和 Reliable Services](/documentation/articles/service-fabric-choose-framework/)。当然，用户可以选择任何代码来生成微服务。但使用这些 API 不仅可让作业变得更简单，也能更深入地与平台集成。例如，可以通过这种方式获取运行状况和诊断信息，或利用内置的高可用性。

***Service Fabric 不限制用户生成服务的方式，允许用户使用任何技术，但提供内置的编程 API，方便用户生成微服务。***

### 微服务适合我的应用程序吗？
也许。根据我们的经验，随着 Microsoft 中越来越多团队开始出于商业理由而以云为目标来生成，有许多团队都了解到采用类似微服务的方法所带来的优点。例如，多年以来，必应一直在搜索方面开发微服务。微服务方法对于其他团队而言相当新颖。团队发现需要解决一些疑难问题，但这并非他们的强项。这就是为什么 Service Fabric 受到重视而成为生成服务的最佳技术。

Service Fabric 的目标是将使用微服务方法生成应用程序时的复杂性降低，使你不需要经历许多耗费成本的重新设计工作。方法是：从小规模开始，按需缩放，淘汰过时服务，添加新服务，根据客户使用情况而不断改进。我们也知道，还需要解决许多其他问题，才能让微服务更易为大部分开发人员所接受。容器和执行组件编程模型都是朝此目标前进的一小步，我们确信将涌现出更多的创新来轻松实现目标。 
<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->
## 后续步骤

* [Service Fabric 术语概述](/documentation/articles/service-fabric-technical-overview/)
* [微服务：由云支持的应用程序变革](https://azure.microsoft.com/zh-CN/blog/microservices-an-application-revolution-powered-by-the-cloud/)


[Image1]: ./media/service-fabric-overview-microservices/monolithic-vs-micro.png
[Image2]: ./media/service-fabric-overview-microservices/statemonolithic-vs-micro.png

<!---HONumber=Mooncake_0227_2017-->
<!--Update_Description: wording update-->