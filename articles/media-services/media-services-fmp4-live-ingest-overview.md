<properties 
	pageTitle="Azure 媒体服务分片 MP4 实时引入规范" 
	description="本规范描述基于分片 MP4 的实时流引入协议和格式（适用于 Azure 媒体服务）。Azure 媒体服务提供实时流服务，让客户使用 Azure 作为云平台来实时流式传输实时事件和广播内容。本文档还介绍了有关构建高度冗余和稳健的实时引入机制的最佳实践。" 
	services="media-services" 
	documentationCenter="" 
	authors="cenkdin,juliako" 
	manager="dwrede" 
	editor=""/>

<tags
	ms.service="media-services"
 	ms.date="04/18/2016"    
	wacn.date="06/20/2016"/>

#Azure 媒体服务分片 MP4 实时引入规范

本规范描述基于分片 MP4 的实时流引入协议和格式（适用于 Azure 媒体服务）。Azure 媒体服务提供实时流服务，让客户使用 Azure 作为云平台来实时流式传输实时事件和广播内容。本文档还介绍了有关构建高度冗余和稳健的实时引入机制的最佳实践。


##1\.一致表示法

本文档中的关键字“必须”、“不得”、“需要”、“应”、“不应”、“应该”、“不能”、“建议”、“可以”和“可选”根据 RFC 2119 中所述予以解释。

##2\.服务关系图 

下图显示 Azure 媒体服务中实时流服务的高级体系结构：

1.	实时编码器将实时源推送到通过 Azure 媒体服务 SDK 创建并设置的通道。
2.	Azure 媒体服务中的通道、节目与流终结点处理所有的实时流功能，包括引入、格式化、云 DVR、安全性、缩放性和冗余。
3.	（可选）客户可以选择在流式处理终结点与客户端终结点之间部署 CDN 层。
4.	客户端使用 HTTP 自适应流协议（例如平滑流、DASH、HDS 或 HLS）从流终结点开始流式传输。

![image1][image1]


##3\.位流格式 - ISO 14496-12 分片 MP4

本文档所述的实时流引入的有线格式基于 [ISO-14496-12]。有关分片 MP4 格式、视频点播和实时流引入的详细说明，请参阅 [[MS SSTR]] (http://msdn.microsoft.com/zh-cn/library/ff469518.aspx)。

###实时引入格式定义 

下面是适用于 Azure 媒体服务的实时引入的特殊格式定义列表：

1. ‘ftyp’、LiveServerManifestBox 及 ‘moov’ 框必须连同每个请求 (HTTP POST) 一起发送。必须在流的开头发送，每当需要恢复流引入时，编码器都必须重新连接。有关详细信息，请参阅 [1] 中的“第 6 部分”。
2. [1] 中的第 3.3.2 部分实时引入定义了名为 StreamManifestBox 的可选框。Azure 负载平衡器的路由逻辑使得此框的使用已过时，在引入到 Azure 媒体服务时不应该存在此框。如果存在此框，Azure 媒体服务会以无提示方式将其忽略。
3. 每个片段必须有在 [1] 的 3.2.3.2 中定义的 TrackFragmentExtendedHeaderBoxMUST。
4. 应该使用第 2 版的 TrackFragmentExtendedHeaderBox，才能在多个数据中心生成具有相同 URL 的媒体片段。对于跨数据中心故障转移基于索引的流格式（例如 Apple HTTP 实时流 (HLS) 和基于索引的 MPEG DASH），片段索引字段是必需的。若要启用跨数据中心故障转移，多个编码器之间的片段索引必须同步，后续的每个媒体片段会增加 1，即使跨编码器重新启动或失败。
5. [1] 中的第 3.3.6 部分定义了名为 MovieFragmentRandomAccessBox (‘mfra’) 的框，此框可能会在实时引入结束时发送，表示通道 EOS（流式传输结束）。Azure 媒体服务的引入逻辑使得 EOS（流式传输结束）的使用方式已过时，不应该发送实时引入的 ‘mfra’ 框。如果已发送，Azure 媒体服务会无提示方式将其忽略。建议使用[通道重置](https://msdn.microsoft.com/zh-cn/library/azure/dn783458.aspx#reset_channels)来重置引入点的状态，此外，建议使用[节目停止](https://msdn.microsoft.com/zh-cn/library/azure/dn783463.aspx#stop_programs)来结束演播与流。
6. MP4 片段持续时间应该是恒定的才能减少客户端清单的大小，并通过使用重复标记来改善客户端下载启发。为了补偿非整数的帧速率，持续时间可能会波动。
7. MP4 片段持续期间应该大约在 2 到 6 秒之间。
8. 应该以递增顺序送达 MP4 片段时间戳和索引（TrackFragmentExtendedHeaderBox fragment_absolute_time 和 fragment_index）。尽管 Azure 媒体服务在复制片段方面很有弹性，但是其根据媒体时间轴将片段重新排序的功能非常有限。

##4\.协议格式 - HTTP

Azure 媒体服务的 ISO 分片 MP4 实时引入使用长时间运行的标准 HTTP POST 请求，将以分片 MP4 格式打包的编码媒体数据传输到服务。每个 HTTP POST 发送完整的分片 MP4 位流（“流”），其开头为标头框（‘ftyp’、“实时服务器清单框”及 ‘moov’ 框），后接一系列片段（‘moof’ 与 ‘mdat’ 框）。有关 HTTP POST 请求的 URL 语法，请参阅 [1] 中的第 9.2 部分。以下是 POST URL 的示例：

	http://customer.channel.mediaservices.chinacloudapi.cn/ingest.isml/streams(720p)

###要求

详细要求如下：

1. 编码器应该使用相同的引入 URL 来发送包含空白“正文”（零内容长度）的 HTTP POST 请求，以此开始广播。这可能有助于快速检测实时引入终结点是否有效，以及是否需要任何身份验证或其他条件。服务器无法对每个 HTTP 协议传回 HTTP 响应，直到收到整个请求为止，包括 POST 正文。由于实时事件具有长时间运行的性质，如果不执行此步骤，编码器在完成发送所有数据之前，无法检测任何错误。
2. 编码器必须处理任何因为　 (1) 而造成的错误或身份验证质询。如果 (1) 成功并返回 200 响应，则继续进行。
3. 编码器必须以分片 MP4 流开始新的 HTTP POST 请求。负载的开头必须是标头框后接片段。请注意，由于上一个请求在流结束前终止，因此即使编码器必须重新连接，‘ftyp’、“实时服务器清单框”及 ‘moov’ 框（依此顺序）仍必须连同每个请求发送。 
4. 因为无法预测实时事件的整个内容长度，编码器必须使用区块传输编码进行上载。
5. 当事件结束时，在发送最后一个片段之后，编码器必须正常结束区块传输编码消息序列（大多数 HTTP 客户端堆栈会自动处理）。编码器必须等候服务返回最终响应代码，然后终止连接。 
6. 如 [1] 中第 9.2 部分所述，编码器不得使用 Events() 名词，以便实时引入 Azure 媒体服务。
7. 如果 HTTP POST 请求在流结束时终止或超时，并发生 TCP 错误，则编码器必须使用新连接发出新的 POST 请求，并遵循上述要求及以下附加要求：编码器必须为流中的每个数据轨迹重新发送前两个 MP4 片段并继续进行，但不在媒体时间轴上造成不连续情况。为每个轨迹重新发送最后两个 MP4 片段可确保不会丢失数据。换句话说，如果流包含音频和视频轨迹，并且当前 POST 请求失败，则编码器必须重新连接，然后为音频轨迹重新发送最后两个片段（先前已成功发送），为视频轨迹重新发送最后两个片段（先前已成功发送），以确保不会丢失任何数据。编码器必须维护媒体片段的“转发”缓冲区，当重新连接时会重新发送此缓冲区。

##5\.时间刻度 

[[MS SSTR]] (https://msdn.microsoft.com/zh-cn/library/ff469518.aspx) 介绍了 SmoothStreamingMedia（第 2.2.2.1 部分）、StreamElement（第 2.2.2.3 部分）、StreamFragmentElement（第 2.2.2.6 部分）和 LiveSMIL（第 2.2.7.3.1 节）的“时间刻度”使用方式。如果没有时间刻度值，则使用默认值 10,000,000 (10 MHz)。尽管平滑流格式规范不会阻止使用其他时间刻度值，但大多数编码器实现会使用此默认值 (10 MHz) 来生成平滑流引入数据。由于 [Azure 媒体动态打包](/documentation/articles/media-services-dynamic-packaging-overview/)功能方面的原因，建议为视频流使用 90 kHz 时间刻度，为音频流使用 44.1 或 48.1 kHz。如果不同的流采用不同的时间刻度值，则必须发送流级时间刻度。请参阅 [[MS-SSTR]] (https://msdn.microsoft.com/zh-cn/library/ff469518.aspx))。

##6\.“流”的定义  

“流”是指在撰写实时演播内容、处理流故障转移和冗余方案的实时引入中操作的基本单位。“流”定义为一个唯一的分片 MP4 位流，其中可以包含单个轨迹或多个轨迹。完整实时演播可包含一个或多个流，视实时编码器配置而定。以下示例演示了使用流撰写完整实时演播内容的各种选项。

**示例：**

客户想要创建实时流演播，其中包含以下音频/视频比特率：

视频 - 3000kbps、1500kbps、750kbps

音频 - 128 kbps

###选项 1：在一个流中包含所有轨迹

在此选项中，单个编码器会生成所有音频/视频轨迹，并将其捆绑成一个分片 MP4 位流，系统将通过单个 HTTP POST 连接发送此流。在此示例中，此实时演播只有一个流：

![图像 2][image2]

###选项 2：将每个轨迹包含在单独的流中

在此选项中，编码器在每个分片 MP4 位流中只放置一个轨迹，并通过多个独立的 HTTP 连接发布所有流。这可通过一个或多个编码器来实现。从实时引入的角度来看，此实时演播由四个流组成。

![image3][image3]

###选项 3：将音频轨迹与比特率最低的视频轨迹捆绑成一个流

在此选项中，客户选择将音频轨迹与比特率最低的视频轨迹捆绑成一个分片 MP4 位流，并让另外两个视频轨迹分别保留在自己的流中。


![Image4][image4]


###摘要

上面显示的列表并不完整，只列出了此示例中部分可用的引入选项。事实上，实时引入支持将轨迹以任何组合方式分组到流中。客户和编码器供应商可以根据工程复杂性、编码器容量以及冗余与故障转移注意事项，来选择自己的实现。不过请注意，在大多数情况下，整个实时演播只有一个音频轨迹，因此请务必确保包含音频轨迹的引入流是正常的。在考虑到这个要点的情况下，用户通常会将音频轨迹放入其自己的流（如选项 2），或者将它与比特率最低的视频轨迹捆绑在一起（如选项 3）。此外，若要获得更好的冗余与故障转移效果，强烈建议针对嵌入到 Azure 媒体服务的实时引入，将同一个音频轨迹发送到两个不同的流（选项 2 中采用冗余音频轨迹），或者将音频轨迹与至少两个最低比特率视频轨迹捆绑在一起（选项 3 将音频与至少两个视频流捆绑在一起）。

##7\.服务故障转移 

根据实时流的性质，良好的故障转移支持是确保服务可用性的关键。Azure 媒体服务可以处理各种类型的故障，包括网络错误、服务器错误、存储问题，等等。当与实时编码器端的故障转移逻辑结合使用时，客户可以从云实现高度可靠的实时流服务。

在本部分中，我们将讨论服务故障转移的方案。在此案例中，服务的某个位置发生故障，且故障将自身记录为网络错误。以下是如何实施编码器以处理服务故障转移的一些建议：


1. 建立超时值为 10 秒的 TCP 连接。如果尝试建立连接超过 10 秒，便会中止操作并重试。 
2. 发送 HTTP 请求消息区块的超时值较短。如果目标 MP4 片段持续时间为 N 秒，请使用介于 N 和 2N 秒之间的发送超时；例如，如果 MP4 片段持续时间是 6 秒，则使用 6 到 12 的超时。如果发生超时，请重置连接，打开新连接，然后以新连接恢复流引入。 
3. 为每个轨迹维护一个循环缓冲区，其中包含最后两个已成功完全发送到服务的片段。如果流的 HTTP POST 请求在流结束前终止或超时，则打开新的连接，然后开始另一个 HTTP POST 请求、重新发送流标头、为每个轨迹重新发送最后两个片段，但不在媒体时间轴上造成不连续情况。这会减少数据丢失的可能性。
4. 建议编码器不要限制在发生 TCP 错误后，重新尝试创建连接或继续流式传输的次数。
5. 发生 TCP 错误后：
	1. 必须关闭当前连接，并且必须为新的 HTTP POST 请求创建新的连接。
	2. 新的 HTTP POST URL 必须与初始 POST URL 相同。
	3. 新的 HTTP POST 必须包括与初始 POST 相同的流标头（‘ftyp’、“实时服务器清单框”及 ‘moov’ 框）。
	4. 必须重新发送为每个轨迹发送的最后两个片段，并恢复流式传输，但不在媒体时间轴上造成不连续情况。MP4 片段时间戳必须连续递增，甚至可跨越 HTTP POST 请求。
6. 如果未以匹配 MP4 片段持续时间的速率发送数据，则编码器应该终止 HTTP POST 请求。不发送数据的 HTTP POST 请求可以防止 Azure 媒体服务在服务更新时很快与编码器断开连接。出于此原因，稀疏（广告信号）轨迹的 HTTP POST 应该短暂留存，并在发送疏松片段之后立即终止。

##8\.编码器故障转移

编码器故障转移是第二种故障转移方案，必须妥善配置此方案才能进行端到端实时流式传送。在此方案中，错误状况会发生在编码器端。

![图像 5][image5]


发生编码器故障转移时，实时引入终结点上预期会：

1. 应该创建新的编码器实例以恢复流式传输，如上图所示（以虚线表示的 3000k 视频流）。
2. 新编码器必须使用与故障实例相同的 HTTP POST 请求 URL。
3. 新编码器的 POST 请求必须包含与故障实例相同的分片 MP4 标头框。
4. 新编码器必须与所有其他运行中的编码器正确同步，相同的实时演播才能生成与相符片段边界同步的音频/视频样本。
5. 新流必须在语义上等同于上一个流，并可在标头与片段级别互换。
6. 新的编码器应该尝试最大程度地减少数据丢失。媒体片段的 fragment_absolute_time 与 fragment_index 应该从编码器上次停止的时间点开始增加。fragment_absolute_time 与 fragment_index 应该连续增加，但允许视需要造成不连续情况。Azure 媒体服务将忽略已收到并处理的片段，因此在片段重新发送端造成错误，好过在媒体时间轴上造成不连续情况。 

##9\.编码器冗余 

对于某些需要更高可用性与优质体验的重要实时事件，建议使用主动-主动冗余编码器，以实现无缝故障转移，且不会丢失数据。

![image6][image6]

如上图所示，有两组编码器同时将每个流的两个副本推送到实时服务。此设置之所以受支持，是因为 Azure 媒体服务能够根据流 ID 与片段时间戳筛选出重复片段。生成的实时流与存档将是所有流的单个副本，此副本很有可能是从两个源聚合而成。例如，在假设的极端条件下，只要有一个编码器（不一定是同一个）在任意给定时间点对每个流运行，则从服务生成的实时流就会是连续的，且不会丢失数据。

此方案的要求与编码器故障转移的要求几乎相同，不同之处在于，第二组编码器将与主编码器同时运行。

##10\.服务冗余  

对于高度冗余的全局分发，有时需要跨区域备份以处理区域灾难。通过扩展“编码器冗余”拓扑，客户可以选择在不同的区域部署冗余服务，且该区域与第 2 组编码器连接。客户还可与 CDN 提供商合作，将 GTM（全局流量管理器）放在两个服务部署之前，以此无缝路由客户端流量。编码器的要求与“编码器冗余”方案相同，不同之处在于，第二组编码器必须指向不同的实时引入终结点。下图演示了这种设置：

![image7][image7]

##11\.特殊类型的引入格式 

本部分介绍用于处理某些特定方案的某些特殊类型的实时引入格式。

###稀疏轨迹

当以丰富的客户端体验传递实时流演播时，通常需要传输与主要媒体数据时间同步的事件或带内信号。动态实时广告插播就是一个例子。这种类型的事件信号不同于一般音频/视频流，因为它具有稀疏的性质。换句话说，信号数据通常不会连续发生，其间隔难以预测。稀疏轨迹的概念专门用于引入和广播带内信号数据。

以下是引入稀疏轨迹的建议实现方式：

1. 创建独立的分片 MP4 位流，其中只包含稀疏轨迹，而不包含音频/视频轨迹。
2. 在如 [1] 的第 6 部分定义的“实时服务器清单框”中，使用“parentTrackName”参数指定父轨迹的名称。有关详细信息，请参阅 [1] 中的第 4.2.1.2.1.2 部分。
3. 在“实时服务器清单框”中，manifestOutput 必须设置为“true”。
4. 根据信号事件的稀疏性质，建议：
	1. 实时事件开始时，编码器会将初始标头框发送给服务，使服务可以在客户端清单中注册稀疏轨迹。
	2. 未发送数据时，编码器应该终止 HTTP POST 请求。不发送数据且长时间运行的 HTTP POST 可在服务更新或服务器重新启动时，防止 Azure 媒体服务很快与编码器断开连接，因为会在对套接字执行的接收操作中暂时阻止媒体服务器。 
	3. 在此期间如果没有可用的信号数据，编码器应该关闭 HTTP POST 请求。当 POST 请求处于活动状态时，编码器应发送数据 
	4. 发送稀疏片段时，编码器可以设置显式 Content-Length 标头（如果可用）。
	5. 通过新连接发送稀疏片段时，编码器应该从标头框开始发送，接着发送新片段。这会处理在中途发生故障转移的情况，并会与先前从未看到稀疏轨迹的新服务器创建新的稀疏连接。
	6. 当时间戳值相等或更大的对应父轨迹片段可供客户端使用时，稀疏轨迹片段便可供客户端使用。例如，如果稀疏片段的时间戳 t=1000，则预期在客户端看到视频（假设父轨迹名称为 video）片段时间戳为 1000 或以上后，便可下载 t=1000 的稀疏片段。请注意，实际信号能够在演播时间轴上的不同位置上，极好地用于其指定用途。在上述示例中，t=1000 的稀疏片段具有 XML 负载，可将广告插入到数秒后的位置上。
	7. 稀疏轨迹片段的负载可以采用各种不同的格式（例如 XML、文本或二进制等），具体取决于不同的方案。 


###冗余音频轨迹

在典型的 HTTP 自适应流式传输方案中（例如平滑流或 DASH），通常在整个演播中只有一个音频轨迹。具有多个质量级别的视频轨迹可让客户端在错误条件中选择，而音频轨迹不同于这类轨迹，当引入的流中有损坏的音频轨迹时，音频轨迹会是唯一的故障点。

为了解决此问题，Azure 媒体服务支持实时引入冗余音频轨迹。其思路与可通过不同的流多次发送音频轨迹相同。尽管服务只会在客户端清单中注册音频轨迹一次，但它能够使用冗余的音频轨迹作为备份，在主音频轨迹发生问题时检索音频片段。为了引入冗余音频轨迹，编码器必须：

1. 在多个分片 MP4 位流中创建相同的音频轨迹。冗余的音频轨迹必须在语义上与片段时间戳完全相同，并可在标头与片段级别互换。
2. 确保实时服务器清单中的“audio”条目（[1] 中的第 6 部分）对于所有冗余音频轨迹相同。

以下是冗余音频轨迹的建议实现方式：

1. 让流独自发送每个唯一的音频轨迹。另外，为每个音频轨迹流发送冗余流，其中第 2 个流与第 1 个流的唯一不同之处在于 HTTP POST URL 中的标识符：{protocol}://{server address}/{publishing point path}/Streams({identifier})。
2. 使用独立的流发送两个最低视频比特率。其中每个流还应该包含每个唯一音频轨迹的副本。例如，当支持多种语言时，这些流应包含每种语言的音频轨迹。
3. 使用独立的服务器（编码器）实例来编码和发送 (1) 与 (2) 中所提到的冗余流。 





[image1]: ./media/media-services-fmp4-live-ingest-overview/media-services-image1.png
[image2]: ./media/media-services-fmp4-live-ingest-overview/media-services-image2.png
[image3]: ./media/media-services-fmp4-live-ingest-overview/media-services-image3.png
[image4]: ./media/media-services-fmp4-live-ingest-overview/media-services-image4.png
[image5]: ./media/media-services-fmp4-live-ingest-overview/media-services-image5.png
[image6]: ./media/media-services-fmp4-live-ingest-overview/media-services-image6.png
[image7]: ./media/media-services-fmp4-live-ingest-overview/media-services-image7.png

 
<!---HONumber=Mooncake_0613_2016-->