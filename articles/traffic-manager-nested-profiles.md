<!-- customized -->

<properties 
   pageTitle="嵌套式流量管理器配置文件 | Azure"
   description="本文介绍了 Azure 流量管理器的“嵌套式配置文件”功能"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags 
	ms.service="traffic-manager"
	ms.date="05/25/2016"
	wacn.date="07/04/2016"/>

# 嵌套式流量管理器配置文件

流量管理器包含一系列流量路由方法，你可以控制流量管理器如何选择具体的终结点来从每个最终用户处接收流量。这些内容均在[流量管理器流量路由方法](/documentation/articles/traffic-manager-routing-methods/)中进行了介绍，可以让流量管理器满足最常见的流量路由要求。

每个流量管理器配置文件都会指定一个流量路由方法。但有时候，那些更复杂应用程序所要求的流量路由复杂程度超出了单个流量管理器配置文件所能提供的复杂程度。

为了支持这些复杂的应用程序，流量管理器允许用户以组合或嵌套方式使用流量管理器配置文件，这样的好处是单个应用程序可以使用多个流量路由方法。使用嵌套式配置文件，可以创建更灵活且功能更强大的流量路由方案，以支持用户对更大型、更复杂部署的需求。

另外，嵌套式配置文件还可以在某些情况下覆盖默认的流量管理器行为，例如在使用“性能”流量路由时在区域内路由流量，或者在故障转移过程中路由流量。

本页剩余内容通过一系列示例介绍了如何在各种方案中使用嵌套式流量管理器配置文件。最后是一些有关嵌套式配置文件的常见问题

## 示例 1：组合使用“性能”和“加权”流量路由

假设你的应用程序部署在多个 Azure 区域：中国北部和中国东部。你使用流量管理器的“性能”流量路由方法将流量分发到最靠近用户的区域。

![单个流量管理器配置文件][1]

现在，假设你希望先通过少量用户来试用某个服务更新，然后再推广该更新。为此，你希望使用“加权”流量路由方法，以便将少部分流量引导到你的试用部署。如果使用单个配置文件，则无法组合使用“加权”和“性能”这两种流量路由方法。而使用嵌套式配置文件，则这两种方法都可使用。

具体操作方法是：假设你想要在中国东部的站点 1 试用新部署。你将试用部署与现有生产部署设置在一起，并使用这两个终结点和“加权”流量路由方法创建了一个流量管理器配置文件。然后，你将该“子”配置文件作为终结点添加到“父”配置文件，后者仍使用“性能”流量路由方法，并且仍包含其他终结点形式的全局性部署。

下图演示了此示例：

![嵌套式流量管理器配置文件][2]

使用这种方案，通过父配置文件定向的流量将像正常一样跨区域分布。在中国东部站点 1 中，流量将根据分配的权重在生产部署和试用部署之间进行定向。

请注意，当父配置文件使用“性能”流量路由方法时，每个终结点的位置必须是已知的。对于嵌套式终结点，必须在终结点配置中指定该位置，这一点与外部终结点一样。选择最靠近你的部署的 Azure 区域--可用选项为 Azure 区域，因为这些区域是 Internet 延迟表所支持的位置。如需更多详细信息，请参阅[流量管理器“性能”流量路由方法](/documentation/articles/traffic-manager-routing-methods/#performance-traffic-routing-method)。

## 示例 2：嵌套式配置文件中的终结点监视

流量管理器会主动监视每个服务终结点的运行状况。如果确定某个终结点运行状况不正常，流量管理器会将用户引导到替代终结点，从而确保服务的总体可用性。这种终结点监视和故障转移行为适用于所有流量路由方法。如需更多详细信息，请参阅[流量管理器终结点监视](/documentation/articles/traffic-manager-monitoring/)。

对于嵌套式配置文件，需遵循某些特殊的终结点监视规则。对父配置文件进行配置时，如果让子配置文件作为嵌套式终结点，则父配置文件不会对子配置文件直接执行运行状况检查。与之相反，子配置文件的终结点的运行状况用于计算子配置文件的总体运行状况，而该信息会在嵌套式配置文件层次结构中向上传播，以便确定父配置文件中嵌套式终结点的运行状况。这决定了父配置文件是否会将流量定向到子配置文件。如需详细且完整地了解如何根据子配置文件的运行状况来计算父配置文件中嵌套式终结点的运行状况，请参阅[以下内容](#faq)。

回到示例 1，假设中国东部站点 1 中的生产部署发生故障。默认情况下，“子”配置文件会将所有流量定向到试用部署。如果试用部署也发生故障，则由于所有子终结点的运行状况都不正常，父配置文件就会认为子配置文件不应接收流量，因此会将中国东部站点 1 的所有流量故障转移到其他区域。

![嵌套式配置文件故障转移（默认行为）][3]

你可能会满意此方案，也可能担心试用部署，认为不应使用它来进行中国东部站点 1 所有流量的故障转移：如果中国东部站点 1 中的生产部署发生故障，你宁肯故障转移到其他区域，不管试用部署的运行状况如何。也可使用以下方案：将子配置文件配置为父配置文件中的终结点时，你可以指定“MinChildEndpoints”参数，以便确定必须在子配置文件中提供的终结点的最小数目。低于此阈值（默认为 1）时，父配置文件会认为整个子配置文件不可用，转而将流量定向到其他父配置文件终结点。

以下示例表明：将 MinChildEndpoints 设置为 2 时，如果中国东部站点 1 中的任一部署发生故障，父配置文件就会认为子配置文件不应接收流量，因此会将用户引导到其他区域。

![嵌套式配置文件故障转移，“MinChildEndpoints”设置为 2][4]

请注意，当子配置文件使用“优先级”流量路由方法时，所有流向该子配置文件的流量都会被单个终结点接收。因此，在这种情况下，MinChildEndpoints 设置中除“1”外几乎无法设置其他值。

## 示例 3：“性能”流量路由中的优先故障转移区域

通过单个配置文件来使用“性能”流量路由时，如果某个终结点（例如中国东部站点 1）发生故障，则所有本应定向到该终结点的流量就会转而分发到跨所有区域的其他终结点。这是“性能”流量路由方法的默认行为，这样设计是为了避免下一个最靠近的终结点发生过载并导致一系列的级联故障。

![默认故障转移的“性能”流量路由][5]

但是，假设你更愿意将中国东部站点 1 的流量故障转移到中国北部，仅当这两个区域的相关终结点都不可用的情况下才将流量定向到其他区域，则应如何操作呢？这种情况下，你可以创建一个子配置文件来使用“优先级”流量路由方法，如下所示：

![首选故障转移的“性能”流量路由][6]

由于中国东部站点 1 终结点的优先级高于中国北部终结点，因此当两个终结点都处于联机状态时，所有流量都会发送到中国东部站点 1 终结点。如果中国东部站点 1 发生故障，则其流量会定向到中国北部。仅当中国北部也发生故障的情况下，中国东部站点 1 的流量才会定向到中国东部站点 2。

你可以对所有区域重复此模式，将父配置文件中的所有 3 个终结点替换为 3 个子配置文件，每个子配置文件都提供一个具有优先级的故障转移顺序。

##<a name="example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region"></a> 示例 4：控制同一区域中多个终结点之间的“性能”流量路由

假设在配置文件中使用“性能”流量路由方法时，该配置文件在特定区域（例如中国北部）有多个终结点。默认情况下，定向到该区域的流量会平均分布到该区域的所有可用终结点。

![“性能”流量路由区域内流量分布（默认行为）][7]

此默认设置可以使用嵌套式流量管理器配置文件进行更改。你不必在中国北部添加多个终结点，只需将这些终结点置于单独的子配置文件中，然后将该子配置文件作为中国北部的唯一终结点添加到父配置文件即可。然后，系统就可以使用该子配置文件中的设置来控制中国北部的流量分布，在该区域进行相关操作，例如按优先级或权重进行流量路由。

![“性能”流量路由，自定义区域内流量分布][8]

##<a name="example-5-per-endpoint-monitoring-settings"></a> 示例 5：基于终结点的监视设置

假设你希望使用流量管理器来顺利地在传统本地网站和基于云的新版网站（托管在 Azure 中）之间迁移流量。对于传统网站，你希望使用主页（路径为“/”）来监视网站运行状况，但对于基于云的新版网站，你需要实现一个自定义监视页面，其中包括额外的检查（路径为“/monitor.aspx”）。

![流量管理器终结点监视（默认行为）][9]

流量管理器配置文件中的监视设置适用于该配置文件中的所有终结点，也就是说，在以前你必须在两个站点上使用相同的路径，而现在，在使用嵌套式流量管理器配置文件的情况下，你可以每个网站都使用一个子配置文件，以便按站点来定义不同的监视设置：

![按终结点进行设置的流量管理器终结点监视][10]

##<a name="faq"></a> 常见问题

### 如何配置嵌套式配置文件？

嵌套式流量管理器配置文件既可以使用 Azure Resource Manager (ARM) 配置，也可以使用 Azure 服务管理 (ASM) REST API、PowerShell cmdlet 和跨平台 Azure CLI 命令来配置。也可以通过 Azure 门户预览来使用这些配置文件，但经典管理门户除外。

### 流量管理器支持多少层嵌套？
配置文件的嵌套最深可达 10 层。不允许使用“循环”。

### 能否在同一流量管理器配置文件中将其他终结点类型与嵌套式子配置文件混合在一起使用？

是的。至于如何在一个配置文件中组合使用不同类型的终结点，并无任何限制。

### 嵌套式配置文件如何应用计费模型？

使用嵌套式配置文件在价格方面不会给你带来负面影响。

流量管理器计费分两部分：终结点运行状况检查以及数百万的 DNS 查询（如需完整的详细信息，请参阅我们的[定价页](/home/features/traffic-manager/pricing/)）。 嵌套式配置文件的计费方式具体如下：

- 终结点运行状况检查：在父配置文件中将子配置文件配置为终结点时，不对子配置文件收费。子配置文件中用于监视基础服务的终结点按通常方式计费。

- DNS 查询：每个查询仅计一次。对父配置文件进行查询时，如果返回了子配置文件中的终结点，则仅对父配置文件计费。

### 嵌套式配置文件是否会造成性能影响？

否。使用嵌套式配置文件不会造成性能影响。

在处理每个 DNS 查询时，流量管理器名称服务器会在内部遍历配置文件层次结构，因此，在对父配置文件进行 DNS 查询时，可能会收到终结点来自子配置文件的 DNS 响应。

这是只使用单个 CNAME 记录的原因，与使用单个流量管理器配置文件的情形相同。**不**需要一系列的 CNAME 记录（每个记录对应于层次结构中的每个配置文件），因此不会造成性能影响。

### 在父配置文件中，流量管理器如何根据子配置文件的运行状况来计算嵌套式终结点的运行状况？

对父配置文件进行配置时，如果让子配置文件作为嵌套式终结点，则父配置文件不会对子配置文件直接执行运行状况检查。与之相反，子配置文件的终结点的运行状况用于计算子配置文件的总体运行状况，而该信息会在嵌套式配置文件层次结构中向上传播，以便确定父配置文件中嵌套式终结点的运行状况。这决定了父配置文件是否会将流量定向到子配置文件。

下表介绍了在父配置文件中的嵌套式终结点指向子配置文件的情况下，流量管理器进行运行状况检查时的行为。

|子配置文件监视器状态|父级终结点监视器状态|说明|
|---|---|---|
|已禁用。子配置文件已被用户禁用。|已停止|父级终结点状态为“已停止”，而不是“已禁用”。“已禁用”状态保留用于指示你已在父配置文件中禁用了终结点。|
|已降级。至少一个子配置文件终结点处于“已降级”状态。|联机：子配置文件中处于“联机”状态的终结点的数目至少是 MinChildEndpoints 的值。正在检查终结点：子配置文件中处于“联机”和“正在检查终结点”状态的终结点的数目至少是 MinChildEndpoints 的值。已降级：其他。|流量将路由到状态为“正在检查终结点”的终结点。如果将 MinChildEndpoints 设置得过高，则终结点将始终处于“已降级”状态。|
|联机。至少一个子配置文件终结点处于“联机”状态，没有终结点处于“已降级”状态。|见上。||
|正在检查终结点。至少一个子配置文件终结点处于“正在检查终结点”状态；没有终结点处于“联机”或“已降级”状态|同上。||
|非活动。所有子配置文件终结点都处于“已禁用”或“已停止”状态，除非这是没有终结点的配置文件|已停止||


## 后续步骤

详细了解[流量管理器工作原理](/documentation/articles/traffic-manager-how-traffic-manager-works/)

了解如何[创建流量管理器配置文件](/documentation/articles/traffic-manager-manage-profiles/)

<!--Image references-->
[1]: ./media/traffic-manager-nested-profiles/figure-1.png
[2]: ./media/traffic-manager-nested-profiles/figure-2.png
[3]: ./media/traffic-manager-nested-profiles/figure-3.png
[4]: ./media/traffic-manager-nested-profiles/figure-4.png
[5]: ./media/traffic-manager-nested-profiles/figure-5.png
[6]: ./media/traffic-manager-nested-profiles/figure-6.png
[7]: ./media/traffic-manager-nested-profiles/figure-7.png
[8]: ./media/traffic-manager-nested-profiles/figure-8.png
[9]: ./media/traffic-manager-nested-profiles/figure-9.png
[10]: ./media/traffic-manager-nested-profiles/figure-10.png


<!---HONumber=Mooncake_0627_2016-->