<properties 
   pageTitle="事件中心概述 | Azure"
   description="Azure 事件中心的简介和概述。"
   services="event-hubs"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="" />
<tags 
   ms.service="event-hubs"
    ms.date="04/15/2016"
   wacn.date="05/23/2016" />

# Azure 事件中心概述

许多新型解决方案旨在通过连续反馈和自动遥测提供自适应客户体验或改善产品。此类解决方案面临着这样的挑战：如何安全可靠地从多个并发发布服务器引入极大量的信息。Azure 事件中心是一个托管平台服务，为各种方案中的大规模数据引入提供基础。这种方案的示例包括移动应用中的行为跟踪、从 Web 场中采集流量信息、控制台游戏中的游戏内事件捕获，或者从工业机器或互联汽车中收集遥测数据。事件中心在解决方案体系结构中所扮演的常见角色是充当事件管道的“前门”，通常称为*事件引入器*。事件引入器是位于事件生成者与事件使用者之间的组件或服务，可以将事件流的生成与这些事件的使用分离开来。

![事件中心](./media/event-hubs-overview/IC759856.png)

Azure 事件中心是一种事件处理服务，用于向云提供大规模的事件与遥测数据入口，并且具有较低的延迟和较高的可靠性。在应用程序检测、用户体验或工作流处理以及物联网 (IoT) 方案中，将此服务与其他下游服务结合使用可以带来极好的效果。事件中心提供消息流处理功能，尽管它是类似于队列和主题的实体，但与传统的企业消息传递相比，它具有明显不同的特征。企业消息传递方案通常需要大量复杂的功能，例如定序、死信、事务支持和强传送保证，而在事件引入方面，决定性的因素在于高吞吐量和事件流的处理灵活性。因此，事件中心功能与服务总线主题的不同之处在于，它明显偏向于高吞吐量和事件处理方案。事件中心未实现主题提供的某些消息传递功能。如果你需要这些功能，主题仍是最佳的选择。

事件中心在服务总线中的命名空间级别创建，这与队列和主题类似。事件中心使用 AMQP 和 HTTP 作为主要 API 接口。下图显示了事件中心与服务总线之间的关系。

![事件中心](./media/event-hubs-overview/IC741188.png)

## 概念概述

事件中心通过分区使用者模式提供消息流式处理。队列和主题使用[使用者竞争](https://msdn.microsoft.com/zh-cn/library/dn568101.aspx)模式，在此模式下，每个使用者都尝试从同一队列或资源读取数据。这种资源争用最终会导致流处理应用程序变复杂并造成缩放限制。事件中心使用分区使用者模式，在此模式下，每个使用者只读取消息流的特定子集或分区。此模式允许以水平缩放规模进行事件处理，并提供队列和主题所不能提供的其他面向流的功能。

### 分区

分区是事件中心内保留的有序事件。当较新的事件到达时，它们将添加到此序列的末尾。可以将分区视为“提交日志”。

![事件中心](./media/event-hubs-overview/IC759857.png)

分区按配置的保留时间保留数据，该时间在事件中心级别设置。此设置将应用到事件中心内的所有分区。事件根据特定的时间过期；无法显式删除事件。一个事件中心包含多个分区。每个分区是独立的，包含其自身的数据序列。因此，分区通常以不同的速率增大。

![事件中心](./media/event-hubs-overview/IC759858.png)

分区数在创建事件中心时指定，它必须介于 2 和 32 之间（默认值为 4）。分区是一种数据组织机制，主要与消费应用程序中所需的下游并行度而不是事件中心吞吐量相关。因此，事件中心内分区数的选择与你预期获得的并发读取者数目直接相关。创建事件中心后，分区计数不可更改，因此你应该从长远预期并行度考虑此数字。可以通过联系服务总线团队来增加 32 个分区这一限制。

尽管分区是可识别的并且可以直接向其发送数据，但通常最好不要向特定分区发送数据，而可以使用“[事件发布者](#event-publisher)”和“[发布者策略](#capacity-and-security)”部分中介绍的更高级构造。

事件数据在事件中心上下文中，消息称为事件数据。事件数据包含事件的正文、用户定义的属性包和有关事件的各种元数据，例如，它在分区中的偏移量，以及它在流序列中的编号。分区中填充了事件数据的序列。

## 事件发布者

向事件中心发送事件或数据的任何实体都称为事件发布者。事件发布者可以使用 HTTPS 或 AMQP 1.0 发布事件。事件发布者使用共享访问签名 (SAS) 令牌在事件中心上标识自身，并且可以包含唯一标识，或使用常见的 SAS 令牌，具体取决于方案的要求。

有关使用 SAS 的详细信息，请参阅[使用服务总线进行共享访问签名身份验证](/documentation/articles/service-bus-shared-access-signature-authentication/)。

### 常见的发布者任务

本部分介绍事件发布者的常见任务。

#### 获取 SAS 令牌

共享访问签名 (SAS) 是事件中心的身份验证机制。服务总线在命名空间和事件中心级别提供 SAS 策略。SAS 令牌是从 SAS 密钥生成的，它是以特定格式编码的 URL 的 SHA 哈希。使用密钥（策略）和令牌的名称，可以重新生成哈希，并因此对发送者进行身份验证。通常，为事件发布者创建的 SAS 令牌只对特定的事件中心具有**发送**权限。此 SAS 令牌 URL 机制是“发布者策略”中介绍的发布者标识的基础。有关使用 SAS 的详细信息，请参阅[使用服务总线进行共享访问签名身份验证](/documentation/articles/service-bus-shared-access-signature-authentication/)。

#### 发布事件

你可以通过 AMQP 1.0 或 HTTPS 发布事件。服务总线提供了一个 [EventHubClient](https://msdn.microsoft.com/zh-cn/library/microsoft.servicebus.messaging.eventhubclient.aspx) 类，使用该类可从 .NET 客户端向事件中心发送事件。对于其他运行时和平台，你可以使用任何 AMQP 1.0 客户端，例如 [Apache Qpid](http://qpid.apache.org/)。可以逐个或者批量发送事件。单个发布（事件数据实例）限制为 256KB，不管它是单个事件还是事件批。发布大于此限制的事件将导致出错。发布者最好是不知道事件中心内的分区数，而只是通过其 SAS 令牌指定分区键（如下一部分所述）或其标识。

是要使用 AMQP 还 HTTPS 根据具体的使用方案而定。AMQP 除了需要使用传输级别安全 (TLS) 或 SSL/TLS 以外，还需要建立持久的双向套接字。从网络流量的角度讲，这可能是开销较大的操作，但这种操作只会在 AMQP 会话开始时发生。HTTPS 的初始开销较低，但需要为每个请求提供更多的 SSL 开销。对于频繁发布事件的发布者而言，AMQP 可以实现明显的性能、延迟和吞吐量节省。

### 分区键

分区键是用于将传入事件数据映射到特定分区以便组织数据的值。分区键是发送者提供的、要传递给事件中心的值。该键将通过静态哈希函数进行处理，处理后将会创建分区分配。如果在发布事件时未指定分区键，则会使用循环分配。在使用分区键时，事件发布者只知道其分区密钥，而不知道事件要发布到的分区。键与分区的这种分离使发送者无需了解有关下游处理和事件存储的过多信息。分区键对于组织下游处理数据非常重要，但基本上与分区本身无关。每个设备或用户的唯一标识就可以充当一个适当的分区键，但是，也可以使用其他属性（例如地理位置），以便将相关的事件分组到单个分区中。下图显示了使用分区键固定到分区的事件发送者。

![事件中心](./media/event-hubs-overview/IC759859.png)

事件中心可确保按顺序将共享同一分区键值的任一和所有事件传送到同一分区。请务必注意，如果将分区键与下一部分中所述的发布者策略结合使用，则发布者的标识与分区键的值必须匹配。否则将会出错。

### 事件使用者

从事件中心读取事件数据的任何实体称为事件使用者。所有事件使用者将通过使用者组中的分区读取事件流。每个分区每次只能有一个活动的读取者。所有事件中心使用者通过 AMQP 1.0 会话进行连接，在此模式下，事件将在可用时传送。客户端不需要轮询数据可用性。

#### 使用者组

事件中心的发布/订阅机制是通过使用者组实现的。使用者组是整个事件中心的视图（状态、位置或偏移量）。使用者组使多个消费应用程序都有各自独立的事件流视图，并按自身步调和偏移量独立读取流。在流处理体系结构中，每个下游应用程序相当于一个使用者组。如果你要将事件数据写入长期存储，则该存储写入器应用程序就是一个使用者组。复杂的事件处理由另一个独立的使用者组执行。你只能通过使用者组访问分区。事件中心内始终有一个默认的使用者组，最多可为一个标准层事件中心创建 20 个使用者组。

以下是使用者组 URI 约定的示例：

	//<my namespace>.servicebus.chinacloudapi.cn/<event hub name>/<Consumer Group #1>
	//<my namespace>.servicebus.chinacloudapi.cn/<event hub name>/<Consumer Group #2>

下图显示了使用者组内的事件使用者。

![事件中心](./media/event-hubs-overview/IC759860.png)

#### 流偏移量

偏移量是事件在分区中的位置。可以将偏移量视为客户端游标。偏移量是事件的字节编号。这样，事件使用者（读取者）便可以在事件流中指定要从其开始读取事件的点。可以时间戳或者偏移量值的形式指定偏移量。使用者负责在事件中心服务的外部存储其自身的偏移量值。

![事件中心](./media/event-hubs-overview/IC759861.png)

在分区中，每个事件都包含一个偏移量。使用者使用此偏移量来显示给定分区的事件序列中的位置。当读取者建立连接时，可以数字或时间戳值的形式将偏移量传递给事件中心。

#### 检查点

检查点是读取者在分区事件序列中标记或提交其位置时执行的过程。检查点操作由使用者负责，并在使用者组中的每个分区上进行。这意味着，对于每个使用者组而言，每个分区读取者必须跟踪它在事件流中的当前位置，当它认为数据流已完成时，可以通知服务。如果读取者与分区断开连接，当它重新连接时，将开始读取前面由该使用者组中该分区的最后一个读取者提交的检查点。当读取者建立连接时，它会将此偏移量传递给事件中心，以指定要从其开始读取数据的位置。这样，你便可以使用检查点将事件标记为已由下游应用程序“完成”，并且在不同计算机上运行的读取者之间发生故障转移时，还可以提供弹性。由于事件数据是根据创建事件中心时指定的保留间隔保留的，因此可以通过在执行此检查点过程中指定较小的偏移量来返回到旧数据。借助此机制，检查点可以实现故障转移弹性和受控的事件流重放。

#### 常见的使用者任务

本部分介绍事件中心事件使用者或读取者的常见任务。所有事件中心使用者通过 AMQP 1.0 进行连接。AMQP 1.0 是会话和状态感知的双向通信通道。每个分区都提供一个 AMQP 1.0 链接会话用于方便传输按分区隔离的事件。

##### 连接到分区

为了使用事件中心内的事件，使用者必须连接到一个分区。如前所述，你始终要通过使用者组访问分区。作为分区使用者模式的一部分，在使用者组中，每个分区上每次只能有一个读取者处于活动状态。在直接连接到分区时，常见的做法是使用租用机制来协调读取者与特定分区的连接。这样，便可以做到一个使用者组中每分区只有一个活动的读取者。管理读取者序列中的位置是一项重要任务，这可以通过检查点来实现。使用 .NET 客户端的 [EventProcessorHost](https://msdn.microsoft.com/zh-cn/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) 类可以简化此功能。[EventProcessorHost](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventprocessorhost.aspx) 是智能使用者代理，下一部分对此做了介绍。

##### 读取事件

为特定分区建立 AMQP 1.0 会话和链接后，事件中心服务会将事件传送到 AMQP 1.0 客户端。与 HTTP GET 等基于提取的机制相比，此传送机制可以实现更高的吞吐量和更低的延迟。将事件发送到客户端时，每个事件数据实例将包含重要的元数据，例如，用于简化对事件序列执行的检查点操作的偏移量和序列号。

![事件中心](./media/event-hubs-overview/IC759862.png)

用户负责以最有利于控制流处理进度的方式管理此偏移量。

## 容量和安全性

事件中心是高度可伸缩的流入口并行体系结构。因此，在根据事件中心调整和缩放解决方案时，有几个重要的方面需要考虑。在容量控制方面，第一个要素是下一部分所述的吞吐量单位。

### 吞吐量单位

事件中心的吞吐量容量由吞吐量单位控制。吞吐量单位是预先购买的容量单位。单个吞吐量单位包括：

- 入口：最高每秒 1MB，或每秒 1000 个事件。

- 出口：最高每秒 2MB。

入口限制为购买的吞吐量单位数所提供的容量。发送超过此容量的数据会导致“超出配额”异常。此容量为每秒 1MB 或每秒 1000 个事件，以先达到的限制为准。出口不会生成限制异常，但仅限于所购买吞吐量单位所能提供的数据传输量：每个吞吐量单位每秒 2MB。如果你收到发布速率异常或者预期会看到更高的出口，请务必检查你为创建事件中心的命名空间购买了多少个吞吐量单位。若要获取更多的吞吐量单位，可以在 [Azure 门户][]中“命名空间”页上的“规模”选项卡中调整设置。也可以使用 Azure API 更改此设置。

分区是一个数据组织概念，而吞吐量单位纯粹是一个容量概念。吞吐量单位按小时计费，需提前购买。购买后，吞吐量单位的最短计费时限为一小时。最多可为一个服务总线命名空间购买 20 个吞吐量单位，一个 Azure 帐户限制为 20 个吞吐量单位。这些吞吐量单位将在给定命名空间的所有事件中心之间共享。

吞吐量单位是尽最大努力设置的，不一定能够马上买到。如果你需要特定的容量，建议你提前购买这些吞吐量单位。如果你需要的吞吐量单位超过 20 个，你可以联系服务总线支持部门购买有承诺的更多吞吐量单位，并且前 100 个吞吐量单位以 20 个为一块的形式交付。除此之外，也可以购买包含 100 个吞吐量单位的块。

建议你认真权衡吞吐量单位和分区数目，以便对事件中心实现最佳缩放性。一个分区最多只能缩放一个吞吐量单位。吞吐量单位数应小于或等于事件中心内的分区数。

有关详细定价信息，请参阅[事件中心定价](/home/features/event-hubs/pricing/)。

### 发布者策略

事件中心可让你通过发布者策略对事件发布者进行精细控制。发布者策略是一组运行时功能，旨在为大量的独立事件发布者提供方便。借助发布者策略，每个发布者在使用以下机制将事件发布到事件中心时可以使用自身的唯一标识符。

	//<my namespace>.servicebus.chinacloudapi.cn/<event hub name>/publishers/<my publisher name>

你不需要提前创建发布者名称，但它们必须与发布事件时使用的 SAS 令牌匹配，以确保发布者标识保持独立。有关 SAS 的详细信息，请参阅[使用服务总线进行共享访问签名身份验证](/documentation/articles/service-bus-shared-access-signature-authentication/)。使用发布者策略时，**PartitionKey** 值将设置为发布者名称。若要正常工作，这些值必须匹配。

## 摘要

Azure 事件中心提供缩放性超高的事件与遥测处理服务，可用于任何规模的常见应用和用户工作流监视。由于能够以较低的延迟和极高的规模提供发布订阅功能，事件中心可以充当大数据的“入口”。借助基于发布者的标识和吊销列表，可以将这些功能扩展到常见的物联网方案。有关开发事件中心应用程序的详细信息，请参阅[事务中心编程指南](/documentation/articles/event-hubs-programming-guide/)。

## 后续步骤

在了解事件中心的相关概念后，你可以继续学习以下主题：

- 使用[事件中心教程]入门。
- [使用事件中心的完整示例应用程序]。
- 使用服务总线队列的[队列消息解决方案]。

[Azure 门户]: http://manage.windowsazure.cn
[事件中心教程]: /documentation/articles/hdinsight-apache-storm-tutorial-get-started/
[使用事件中心的完整示例应用程序]: https://github.com/Azure-Samples/
[队列消息解决方案]: /documentation/articles/service-bus-dotnet-multi-tier-app-using-service-bus-queues/
 
<!---HONumber=Mooncake_0321_2016-->