<properties
 pageTitle="IoT 设备管理 | Microsoft Azure"
 description="有关使用 IoT 中心和 IoT 套件管理 IoT 设备的概述"
 services="iot-hub,iot-suite"
 documentationCenter=""
 authors="dominicbetts"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.date="01/21/2016"
 wacn.date="03/18/2016"/>

# 使用 Azure IoT 套件和 Azure IoT 中心管理 IoT 设备

[Azure IoT 套件][lnk-iot-suite]和 Azure IoT 中心提供的基本功能可让你批量管理 IoT 解决方案，以及对多样化的设备和设备拓扑进行管理。本文提到的设备管理专门与 IoT 设备管理相关。

## 介绍

服务提供商和企业（或任何维护大量 IoT 设备的组织）可使用设备管理功能来执行以下业务过程：

* 注册和发现 IoT 设备。
* 启用连接。
* 远程配置和更新设备上的软件。例如，管理制造车间或油田中的设备时，可以使用远程配置和更新设备的策略，其中涵盖审批链、法规审核要求、物理防护措施的当前状态，等等。

为 IoT 解决方案启用 IoT 设备管理时，请考虑以下功能并根据企业目标判断其重要性：

* **[设备预配和发现](#device-provisioning-and-discovery)**：使用此过程可将设备注册到系统。
* **[设备注册表和设备模型](#device-registry-and-device-models)**：设备模型以此方式来呈现设备关系的元数据结构化用法、系统中的角色，以及验证方法。
* **[设备访问管理](#device-access-management)**：设备使用此方式来控制对云服务中设备资源的访问。
* **[远程控制](#remote-control)**：远程用户使用此方式来获取设备的访问权限以及指示设备进行更改。
* **[远程系统管理](#remote-administration-and-monitoring)**：管理员可以使用此过程来定义设备母体运行状况。  
* **[远程配置](#remote-configuration)**：管理员可使用此方法来更改设备配置。
* **[远程固件与软件更新](#remote-firmware-and-software-update)**：管理员可使用此过程来更新设备固件与软件。

以下部分更深入说明了上述每项设备管理功能，并介绍了一个可以使用 Azure IoT 中心实现这些功能的高级模型。

## 设备预配和发现

可以使用注册表 API 通过 Azure IoT 中心预配设备。在注册设备并提供或接收密钥之后，设备即可使用该密钥连接到 IoT 中心。Azure IoT 中心只与能够提供授权凭据的已注册设备进行通信。管理员可以通过设备管理门户禁止设备访问 Azure IoT 中心。

可以使用的引导过程取决于 IoT 设备的制造、预配和部署方式。可以在解决方案中构建引导服务，以提供简单连接功能，并延迟将设备分配给特定 IoT 中心的过程。制造设备时，有可能不知道设备所要运行的位置。这是具有大量可能相当复杂的工作流的唯一示例，这些工作流有助于让 Azure IoT 中心知道设备，以及与现有的业务流程集成。

使用引导服务时，IoT 设备将启动并发出请求，并最终可能提供分配的 Azure IoT 中心的访问权限。请求应包含设备引导凭据和任何其他所需的数据。对于已授权的设备，引导服务应向分配的 Azure IoT 中心注册此设备并将连接详细信息提供给请求引导的设备。IoT 中心将连接详细信息提供给请求引导的设备。

## 设备注册表和设备模型

术语*设备模型*是指包含设备属性且可供云服务读取或写入的模型。它还包括云服务可以在远程对设备执行的设备命令。在下一部分所述的服务驱动的模型中，设备并不知道该模型，但云服务仍可跟踪和使用设备的元数据。

对于 IoT 系统和设备注册表的角色而言，存储设备信息和关联的元数据极为重要。对于无法更改的遗留设备或未使用设备模型的设备，这种重要性尤为明显。服务驱动的模型可以启用 IoT 服务来与设备母体交互。当设备使用定义的模型运行时，设备注册表可充当设备数据的一致性视图（设备为主存储）。在此情况下，服务将通知设备其所需的更改，这些更改只有在设备确认之后才生效。

### 服务驱动的模型

如果设备连接到 Azure IoT 中心但未提供设备模型，请务必实现设备注册表，以跟踪已注册的设备及其关联的元数据。在此情况下，设备注册表是设备元数据的唯一存储位置。你可能想要跟踪的设备元数据示例包括逻辑拓扑（例如，109 栋 4 楼）、设备功能（例如门道传感器）或任何其他标记信息。

### 设备驱动的模型

为了使 IoT 解决方案能够运用 IoT 设备的功能，设备必须在连接到 IoT 中心之后向云做自我介绍。下面是可以在 IoT 解决方案中使用的两种设备模型：

#### 自定义的设备模型

设备工程师（或使用设备仿真器的开发人员）在制造设备时迭代设备功能，从而使用自定义的设备模型。设备工程师首先可以创建一个包含部分属性和受支持命令的设备，然后添加更多的属性和命令。同样地，该设备工程师可能有许多设备，每个设备可提供独特的功能并使用自定义的模型。在此情况下，设备工程师无需注册设备模型的结构。在扩展到大量设备时，自定义模型的显著差异会带来一些挑战。

#### 预定义的设备模型

在网络和电源或处理能力约束之下运行的生产 IoT 部署大大受益于预定义的设备模型，该模型可帮助减少设备处理资源和能耗。同样，设备可通过异构网络（WiFi、2G/3G/4G、BLE、Sat 等）传输最小的网络流量，特别是在使用受限且成本高昂的基础结构（例如卫星）时。在实现预定义的设备模型时，设备工程师可以发送以一个或两个字节（在预定义的设备模型中充当键）编码的设备信息。此方法非常直接，相比于自定义的设备模型，效率可提高一到两倍。

### 远程监视预配置的解决方案及其设备模型

Azure IoT 套件[远程监视预配置解决方案][lnk-remote-monitoring]实现自定义的设备模型。你可以使用此模型在定义和改进设备功能时快速迭代。

可以在 [azure-iot-solution][lnk-azure-iot-solution] GitHub 存储库中找到此预配置解决方案的源代码。

远程监视预配置解决方案用来创建设备对象并将其发送到服务的代码位于 **Simulator/Simulator.WorkerRole/SimulatorCore/Devices/DeviceBase.cs** 文件中。在 **SendDeviceInfo** 和 **GetDeviceInfo** 方法中，你可以看到如何创建自述设备模型并将其发送到 Azure IoT 中心。

云服务用来处理设备模型相关事件的代码位于 **EventProcessor/EventProcessor.WorkerRole/Processors/DeviceManagementProcessor.cs** 文件中。大多数涉及到根据设备模型相关消息（由设备发送给预配置解决方案服务端）采取措施的操作都发生在 **ProcessJToken** 方法中。

在收到设备模型相关消息后，**DeviceManagement/Infrastructure/BusinessLogic/DeviceLogic.cs** 文件中的 **UpdateDeviceFromSimulatedDeviceInfoPacketAsync** 和 **UpdateDeviceFromRealDeviceInfoPacketAsync** 方法将负责更新设备注册表。可以在 **DeviceManagement/Web/WebApiControllers/DeviceApiController.cs** 文件中找到远程监视预配置解决方案中的设备注册表 API。

### 现场网关设备模型

对于无法或不应直接连接 Internet 的设备而言，现场网关通常用于连接和协议转换。如果你要制造的设备是现场网关，它可以是在与 Azure IoT 中心的所有交互中通过现场网关连接的设备。现场网关制造商需要负责实现设备协议与 IoT 服务支持的协议之间的转换。若要使现场网关能够连接蓝牙低功耗 (BLE) 设备，必须实现设备的 BLE 接口和 Azure IoT 中心的接口。

## 设备访问管理

IoT 套件的预配置解决方案可控制不同设备层面的访问，包括设备属性的读写访问以及设备命令的执行权限。在预配置的解决方案中，此访问权限是在设备管理门户中通过 Azure Active Directory (AAD) 控制的。在预配置的解决方案中扩展 AAD 的用法，即可启用基于角色的访问安全性。

## 远程控制

远程控制已超出 Azure IoT 套件预配置解决方案的方案范畴。不过，下面提供了可用于在 IoT 解决方案中启用远程控制的选项的全面分析。

在 IT 方案中，远程控制通常用于协助远程用户或者在远程配置远程服务器。在 IoT 方案中，大多数设备不需要用户干预，因此远程控制用于远程配置和诊断方案。你可以使用两种不同的模型实现远程控制：

* **直接连接**若要通过直接连接到设备来启用远程控制（例如 Linux 上的 SSH、Windows 上的远程桌面，或通过远程调试工具），必须能够与设备建立连接。由于在开放式 Internet 中公开设备有安全风险，因此建议使用中继服务（例如 Azure [服务总线中继服务][service-bus-relay]）来启用连接和路由流量。由于中继连接是来自设备的出站连接，因此有助于限制设备上打开的 TCP 端口的攻击面。

* **设备命令**通过设备命令进行的远程控制既使用现有的连接，也使用在设备与 Azure IoT 中心之间建立的通信通道。若要启用基于设备命令的远程控制，必须遵守以下要求：
  * 在设备上运行的软件必须通知 IoT 服务：设备命令已可在设备上使用。这通常被定义为设备模型的一部分。
  * 在设备上运行的软件必须实现远程控制命令。这些设备命令应遵循请求（从 IoT 服务到设备）和响应（从设备到 IoT 服务）模式。当你执行设备命令时，可能会影响设备状态，而且必须在设备注册表中更新此新状态。

当设备是设备配置和状态的主存储时，设备注册表使用最终一致的模型，而且必须将设备状态更改推送到设备注册表。从 IoT 服务到设备的请求可以强制更新设备注册表状态，或者设备可以在识别系统状态中的更改时自动更新服务。从设备自动更新此服务可能会生成大量网络流量，并增加设备处理器和可用电源使用量。

## 远程管理和监视

大多数 IoT 设备区分操作用户和管理用户角色。管理员可以使用远程管理方法监视其设备的状态、配置从设备到业务流程和应用程序（例如 CRM、ERP、维护系统等）的数据流，以及使用设备命令从远程更新设备的状态或配置。

Azure IoT 套件的预配置解决方案包含一个 Azure 网站，可让你着手将设备管理体验延伸到垂直 IoT 解决方案中的方案。

管理员可以通过查看设备操作数据（通常快速移动）和设备元数据（通常缓慢移动），来确定设备运行状况。你可以使用规则来启用设备运行状况警报系统，这是通过流处理引擎（例如 [Azure 流分析](https://azure.microsoft.com/services/stream-analytics/)）而不是轮询策略来实现的。

## 远程配置

在设备生命周期的某些阶段，从远程更改设备配置非常重要：预配、诊断，或者与业务流程集成。结合设备模型与 IoT 服务从远程更新设备模型实例状态的功能，就能够进行远程配置更改。

在远程监视预配置解决方案中，设备描述它支持使用以下命令进行远程配置：

* ChangeKey
* ChangeConfig
* ChangeSystemProperties

这些设备命令不会在预配置解决方案设备管理门户中显示为可用的设备命令，因为它们是由门户在特定情况下远程执行的。设备收到设备命令时，将确认响应发送到服务。在处理设备命令之后，设备发送结果响应来通知服务，指出设备命令执行成功（如果失败，则包含错误代码）。此时，将在设备上确认设备所需的状态并更新设备注册表。

## 远程固件与软件更新

远程固件和软件更新是 IoT 系统的一项重要功能。更新可让设备运行最新且最安全的软件。远程更新设备上的固件与软件是一个分布式长时间运行的过程，通常涉及到与其他业务流程交互。例如，在控制高功率燃料泵的设备上更新固件时，可能需要在其他系统中执行一些步骤，以便在执行和验证更新时重新输送燃料。

### 固件更新分析

以下示例是根据你的业务需求实现固件更新的可能方式之一。此示例旨在概述过程注意事项，而不是强加特定的实现。关于如何设计更新要求并考虑到多种业务和技术因素，并不属于本文的范畴。

设备更新由 IoT 服务发起，设备通过设备命令在指定的时间收到通知。当设备明确支持固件或软件的远程更新时，IoT 服务应根据定义的业务流程和策略来传送更新命令。在收到更新设备命令时，设备必须：

1. 下载并部署更新包。
2. 重新引导至新部署的配置（如果是固件更新），或启动新的软件包。
3. 验证新固件或软件是否按预期运行。

在这个多步骤过程中，设备必须通知 IoT 服务有关它在每个步骤的状态。

存储服务（如 Azure 存储空间）或内容传送网络 (CDN) 可以传送更新包。在应用固件或软件更新之前，请务必验证所下载包的完整性，以确保该包源自预期的源。

完成固件更新后，设备必须能够验证和识别正常状态。如果设备无法成功进入该正常状态，则设备上的软件应开始回滚到已知正常状态。已知正常状态可能是上一次已知正常状态，或者是存储分区中存储的设备固件映像（所谓的*黄金状态*）。

## 后续步骤

若要了解有关 Azure IoT 中心的详细信息，请参阅以下链接：

* [IoT 中心入门][]
* [Azure IoT 中心是什么？][]
* [连接你的设备][]

[IoT 中心入门]: /documentation/articles/iot-hub-csharp-csharp-getstarted
[Azure IoT 中心是什么？]: /documentation/articles/iot-hub-what-is-iot-hub
[service-bus-relay]: /documentation/articles/service-bus/service-bus-relay-overview
[连接你的设备]: /develop/iot/
[lnk-azure-iot-solution]: https://github.com/Azure/azure-iot-solution
[lnk-iot-suite]: /documentation/suites/iot-suite/
[lnk-remote-monitoring]: /documentation/articles/iot-suite-remote-monitoring-sample-walkthrough

<!---HONumber=Mooncake_0307_2016-->