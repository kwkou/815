<!-- Remove Channel9 videos -->
<properties
    pageTitle="Azure 应用程序的灾难恢复和高可用性 | Azure"
    description="有关对在 Azure 基础之上设计应用程序高可用性和灾难恢复的技术概述和深入信息。"
    services=""
    documentationcenter="na"
    author="adamglick"
    manager="saladki"
    editor="" />
<tags
    ms.assetid="e13d5f49-2b91-44ba-829a-1e0f1fceaae8"
    ms.service="resiliency"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="na"
    ms.date="08/18/2016"
    wacn.date="02/20/2017"
    ms.author="aglick" />  

# 构建在 Azure 基础之上的应用程序灾难恢复和高可用性

## 介绍

本文重点介绍在 Azure 中运行的应用程序的高可用性。高可用性的总体策略也包括灾难恢复方面。针对云中的故障和灾难进行规划要求迅速识别故障。然后实施适当的策略，该策略应符合可以承受的应用程序停机时间。此外，还必须考虑在恢复应用程序时不产生不利的业务后果的情况下，应用程序可承受的数据丢失的程度。

大多数公司表示他们已准备好应对临时和大规模故障。但是，在你自己回答这个问题之前，贵公司是否演练遇到这些故障的情况？ 是否测试数据库的恢复以确保过程正确无误？ 很有可能并非如此。这是因为成功的灾难恢复首先需要大量规划和设计来实现这些过程。如同安全性等许多其他非功能性要求那样，灾难恢复很少需要预先分析和分配时间。此外，大多数客户没有预算用于分散在各地并具有冗余容量的区域。因此，即使是任务关键型应用程序，也经常被排除在正常的灾难恢复规划之外。

Azure 等云平台在中国国内提供分散在各地的区域。通过这些平台，还可以提供支持可用性以及各种灾难恢复方案的功能。现在，可为每个任务关键型云应用程序适当考虑系统防灾功能。Azure 具有复原能力，其中许多服务均内置灾难恢复。必须认真研究这些平台功能，并通过应用程序策略对这些功能加以补充。

本文概述了对 Azure 部署进行灾难预防必须采取的必要体系结构步骤。然后，你可以实现更大规模的业务连续性过程。业务连续性计划是一个发展方向，目标是在不利的条件下持续运转。其中涵盖技术故障（如中断服务）或自然灾害（如风暴或断电）。应用程序在灾难下复原只是更大规模灾难恢复过程的一部分，如以下 NIST 文档中所述：[Contingency Planning Guide for Information Technology Systems](https://www.fismacenter.com/sp800-34.pdf)（信息技术系统应急措施规划指南）。

以下部分定义不同级别的故障、应对这些故障的方法以及支持这些方法的体系结构。此信息将对灾难恢复过程和程序形成影响，以确保灾难恢复策略正确而高效地实施。

## 弹性云应用程序的特征

经过精心设计的应用程序可承受小规模的功能故障，也可在区域级别承受大规模的系统范围故障。以下部分定义了一些术语，本文通篇引用这些术语以说明弹性云服务的各个方面。

### 高可用性

高度可用的云应用程序实施一些策略以消减依赖项（如云平台提供的托管服务）的中断。尽管云平台功能可能会发生故障，但此方法使应用程序可继续展现应有的功能性和非功能性系统特征。<!-- 第 9 频道视频系列 [Failsafe: Guidance for Resilient Cloud Architectures（防故障：弹性云体系结构指南）](https://channel9.msdn.com/Series/FailSafe)中介绍了此功能。 -->

实现应用程序时，必须将功能中断的可能性考虑在内。此外还需要从业务角度考虑该中断对应用程序产生的影响，然后再深入探讨实施策略。如果未适当地考虑业务影响以及发生危险情况的可能性，则实现可能成本高昂，还可能实属多余。

对于高可用性，请考虑用汽车作为类比。即使拥有优质的部件和一流的设计，也无法阻止偶尔发生故障。例如，当汽车轮胎漏气时，汽车仍可行驶，但开动时功能减弱。如果已针对这种可能发生的情况安排了对策，则可暂时使用其中一个薄边备胎，直到抵达修理厂。尽管备胎不能快速行驶，但仍可开动车辆直到更换轮胎。同样，针对可能丧失功能进行规划的云服务可防止相对较小的问题使整个应用程序停止运行。即使必须在功能减弱的情况下运行云服务也是如此。

高度可用的云服务有几个重要特征：可用性、可缩放性和容错。虽然这些特征相互关联，但了解其中每个特征及其对解决方案的可用性发挥什么作用也很重要。

### 可用性

可用的应用程序将其底层基础结构和从属服务的可用性考虑在内。可用的应用程序通过冗余和复原的设计，消除单点故障。在 Azure 中谈论可用性时，了解平台的有效可用性这一概念很重要。有效可用性考虑每种从属服务的服务级别协议 (SLA) 以及这些协议对于总体系统可用性的累积影响。

系统可用性衡量系统可运转的时间范围所占的百分比。例如，Azure 中的 Web 或辅助角色至少有两个实例的可用性 SLA 为 99.95%（总比例为 100%）。它不衡量在这些角色上运行的服务的性能或功能。但是，其他从属服务的各种 SLA 也会影响云服务的有效可用性。系统中移动部件越多，越要小心操作以确保应用程序能够灵活满足其最终用户的可用性要求。

考虑使用 Azure 服务的一项 Azure 服务的以下 SLA：计算、Azure SQL 数据库和 Azure 存储空间。

|Azure 服务|SLA |每月（30天）可能发生的停机时间的分钟数|
|:------------|:-----|:----------------------------------------:|
|计算 |99\.95%|21\.6 分钟 |
|SQL 数据库 |99\.99%|4\.3 分钟 |
|存储 |99\.90%|43\.2 分钟 |

必须为所有服务有可能在不同时间中断安排对策。在这个简化的示例中，应用程序每月可中断的总分钟数为 108 分钟。一个月 30 天共有 43200 分钟。108 分钟占一个月 30 天的总分钟数（43200 分钟）的 0.25%。这样，云服务的有效可用性为 99.75%。

但是，使用本章中介绍的可用性方法可提高这个数字。例如，如果将应用程序设计为在 SQL 数据库不可用时继续运行，则可从等式中删去那一行。这可能意味着应用程序运行时功能减少，因此还要考虑业务要求。有关 Azure SLA 的完整列表，请参阅[服务级别协议](/support/legal/sla/)。

### 可伸缩性

可缩放性直接影响可用性。在增加负载的情况下发生故障的应用程序不再可用。可缩放的应用程序可满足提高的需求，并在可接受的时间范围内获得相同结果。当系统可缩放时，它进行水平或垂直缩放以承受负载提高，同时保持性能一致。简而言之，水平缩放会添加更多相同大小（处理器、内存、带宽）的计算机，而垂直缩放则增加现有计算机的大小。就 Azure 而言，具有选择不同计算机大小以供计算的垂直缩放选项。但更改计算机大小需要重新部署。因此，大多数灵活的解决方案都适合水平缩放。计算尤其如此，因为你可以轻松增加任何 Web 或辅助角色的运行实例数量。这些附加实例可通过 Azure Web 门户、PowerShell 脚本或代码来处理增多的流量。应在所监视的特定指标增大时作出此决策。在此情况下，负载增加不会造成用户性能或指标大幅下降。Web 角色和辅助角色通常将任何状态存储在外部。这样便可灵活进行负载均衡以及正确处理实例数量的任何更改。水平缩放也适用于不提供垂直缩放分层选项的服务，如 Azure 存储空间。

应将云部署视为一组缩放单位。这可使应用程序可灵活地满足最终用户的吞吐量需求。缩放单位在 Web 和应用程序服务器级别更容易可视化。这是因为 Azure 已通过 Web 角色和辅助角色提供了无状态计算节点。向部署中添加更多计算缩放单位不会产生任何应用程序状态管理方面的副作用，因为计算缩放单位是无状态的。存储缩放单位负责管理（结构化或非结构化）数据分区。存储缩放单位的示例包括 Azure 表分区、Blob 容器和 SQL 数据库。即便是使用多个 Azure 存储帐户，也会直接影响应用程序可缩放性。必须设计一个高度可缩放的云服务来整合多个存储缩放单位。例如，如果应用程序使用关系数据，则在多个 SQL 数据库之间对数据进行分区。这样，存储便可以匹配灵活的计算缩放单位模型。同样地，通过 Azure 存储空间，可制定需要谨慎设计以满足计算层吞吐量需要的数据分区方案。有关设计可缩放的云服务的最佳实践，请参阅 [Best Practices for the Design of Large-Scale Services on Azure Cloud Services](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)（在 Azure 云服务上设计大规模服务的最佳实践）。

### 容错

应用程序需要假定每项依赖的云功能可能并将在某个时间点中断。容错应用程序可检测到发生故障的元素，设法使其继续运行并在特定期限内返回正确结果。对于暂时性的错误情况，容错系统将采用某种重试策略。对于更严重的故障，应用程序可检测问题，并故障转移到备用的硬件或采用应急计划，直到故障解除。可靠的应用程序能够正确处理一个或多个部件故障，同时继续正常运行。容错应用程序可使用一种或多种设计策略，如冗余、复制或性能减弱。

## 灾难恢复

云部署可能因从属服务或底层基础结构发生系统性中断而停止运转。在此类条件下，业务连续性计划将触发灾难恢复过程。此过程通常涉及操作人员和自动化过程，以便在正常运转的区域内重新激活应用程序。其中要求将应用程序用户、数据和服务转移到新的区域。它还涉及使用备份介质或持续复制。

考虑前面的类比，其中将高可用性比作可通过使用备件从轮胎漏气的情况下复原。相比之下，灾难恢复涉及在发生汽车无法再行驶的车祸事故后采取的步骤。在这种情况下，最佳解决方案是找到一种高效的换车方法，即通过致电旅行社或好友换车。在此方案中，重新上路行驶可能会耽搁更长时间。而且，修复然后重新使用原有车辆的情况可能会更加复杂。同样地，灾难恢复到另一区域是一项复杂的任务，通常会产生一些停机时间，并有可能丢失数据。为了更好地理解和评估灾难恢复策略，必须定义两个术语：恢复时间目标 (RTO) 和恢复点目标 (RPO)。

### 恢复时间目标

RTO 是为恢复应用程序功能而分配的最长时间。这取决于业务要求，并与应用程序的重要程度相关。重要的业务应用程序要求 RTO 较低。

### 恢复点目标

RPO 是恢复过程导致丢失数据的可接受时间范围。例如，如果 RPO 为一小时，则必须至少每小时将数据完全备份或复制一次。在备用区域内激活应用程序后，备份数据中最多缺少一小时的数据。如同 RTO 一样，重要的应用目标要求 RPO 越小越好。

##清单

下面总结本文已讨论的要点（并列出有关 Azure 应用程序[高可用性](/documentation/articles/resiliency-high-availability-azure-applications/)和[灾难恢复](/documentation/articles/resiliency-disaster-recovery-azure-applications/)的文章）。本摘要旨在提供你在自己进行可用性和灾难恢复规划时应考虑事项的清单。这些最佳实践对于寻求认真实现成功的解决方案的客户非常有用。

1. 对每个应用程序执行风险评估，因为每个应用程序的要求可能会有不同。某些应用程序比其他一些重要，有理由投入额外的成本为这些应用程序设计灾难恢复功能。
2. 使用此信息定义每个应用程序的 RTO 和 RPO。
3. 从应用程序的体系结构开始，针对故障进行设计。
4. 实现高可用性的最佳实践，同时在成本、复杂程度和风险之间取得平衡。
5. 实现灾难恢复计划和过程。
    * 设想故障跨越模块级别直至云完全瘫痪。
    * 为所有引用数据和事务数据制定备份策略。
    * 选择多站点灾难恢复体系结构。
6. 定义灾难恢复过程、自动化和测试的具体所有者。该所有者应管理并拥有整个过程。
7. 记载这些过程，以使其可轻松重复。尽管只有一个所有者，但应有多人可了解这些过程并在紧急情况下按这些过程操作。
8. 培训人员以实现过程。
9. 定期进行灾难模拟以进行过程的培训和验证。

## 摘要

在 Azure 中有硬件或软件发生故障时，处理这些故障的技术和策略与在本地系统上发生故障时有所不同。这主要是因为云解决方案通常更加依赖分散在 Azure 区域内并作为单独服务管理的基础结构。必须使用高可用性技术处理部分故障。若要处理更严重的故障（可能由于灾难事件导致），请使用灾难恢复策略。

Azure 可检测并处理许多故障，但有许多类型的故障需要使用应用程序特有的策略。必须主动为应用程序、服务和数据的故障做准备并应对这些故障。

制定应用程序的可用性和灾难恢复计划时，请考虑应用程序故障造成的业务后果。定义在灾难性事件后恢复关键系统的流程、策略和过程需要投入时间、规划和精力。制定计划后，并不能就此止步。必须根据应用程序组合、业务需求和可用的技术，定期分析、测试并不断完善这些计划。对于创建可承受故障的可靠应用程序，Azure 不仅提供新功能，也产生新难题。

## 其他资源

[构建在 Azure 基础之上的应用程序高可用性](/documentation/articles/resiliency-high-availability-azure-applications/)

[构建在 Azure 基础之上的应用程序灾难恢复](/documentation/articles/resiliency-disaster-recovery-azure-applications/)

[Azure 复原技术指南](/documentation/articles/resiliency-technical-guidance/)

[概述：云业务连续性与使用 SQL 数据库进行数据库灾难恢复](/documentation/articles/sql-database-business-continuity/)

[Azure 虚拟机中 SQL Server 的高可用性和灾难恢复](/documentation/articles/virtual-machines-windows-sql-high-availability-dr/)

<!-- [防故障：弹性云体系结构指南](https://channel9.msdn.com/Series/FailSafe) -->

[在 Azure 云服务上设计大规模服务的最佳实践](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)

##后续步骤

本文是着重介绍 Azure 应用程序灾难恢复和高可用性的系列教程的一部分。本系列教程的下一篇文章为[构建在 Azure 基础之上的应用程序高可用性](/documentation/articles/resiliency-high-availability-azure-applications/)。

<!---HONumber=Mooncake_0213_2017-->
<!-- Update_Description: update meta properties; wording update; update link reference -->