<properties linkid="dev-net-common-tasks-cdn" urlDisplayName="CDN" pageTitle="Azure CDN Management Portal new version guide" metaKeywords="Azure CDN, Azure CDN, Azure blobs, Azure caching, Azure add-ons, 缓存刷新, 内容预取, 日志下载, 缓存规则, CDN 助文档, CDN技术文档, CDN" description="Learn how to use advanced features of Azure CDN management portal to manage CDN endpoint" metaCanonical="" services="" documentationCenter=".NET" title="" authors="" solutions="" manager="" editor="" />
<tags ms.service="cdn"
    ms.date="4/20/2017"
    wacn.date="4/20/2017"
    wacn.lang="cn"
    />
 
# Azure CDN新版管理门户使用指南

Azure China CDN对管理门户进行设计改版，功能模块归类，并添加了很多新的管理功能。目前从[Azure门户预览](https://portal.azure.cn/)点击“管理”按钮会跳转到老版管理门户，用户可以在概览界面点击“访问新站点”跳转到新版管理门户。

![][16]

## **新版管理门户功能如下：**

+ [概览](#step1)
+ [域名管理](#step2)
+ [监控和分析](#step3)
+ [内容管理](#step4)
+ [自助服务工具](#step5)
+ [安全管理](#step6)

## **Azure CDN管理页面概览**<a id="step1"></a>

概览页面可以查看您的CDN订阅账号下的基本信息，关键数据如所有加速域名数量、已启用域名，当月总流量，当天峰值带宽等。还可以查看当月的流量趋势图和带宽趋势图。

![][1]

 **域名数量**

当前Azure订阅下已经创建的加速域名的统计数字。

 **已启用加速域名**

当前Azure订阅下目前处于启用状态的加速域名的统计数字。

 **当月总流量**

当前Azure订阅下本月所有的加速域名使用的流量总和，单位是MB.

 **当月流量**

当前Azure订阅下当月每天的流量信息。 如果您需要了更详细的流量信息，可以在左侧的导航窗格中单击 “流量报表”，进入流量统计报表页面。


**当月带宽**
当月每天的峰值带宽信息，单位是Kb/s。 如果您需要了解更详细的带宽信息，可以在左侧的导航窗格中单击 “带宽报表”，进入带宽统计报表页面。

## **域名管理**<a id="step2"></a>

单击左侧导航窗格中 “域名管理”时，将显示当前Azure订阅下已经创建的所有CDN加速域名的列表视图。 可以在搜索框内搜索需要管理的域名。也可以通过Azure订阅下拉列表选择不同的订阅查看不同订阅下的CDN加速域名信息。同时可以点击相应的域名行，对选中域名进行**“修改配置”**，**“缓存规则配置”**和**“访问控制管理”**等操作。

### **加速域名列表视图**

![][3]

 **域名列表视图包括：**

-   自定义域名，用于访问CDN缓存内容的域名，该域名必须有相应的ICP备案信息。
-   源站地址，CDN所缓存内容的原始位置。
-   状态，开启或者关闭（包括ICP审核，需要CNAME配置，禁用等非**开启**状态）
-   ICP，域名对应的ICP备案信息
-   加速类型 （目前支持“网站加速”，“下载加速”，“HTTP点播加速”，“流媒体直播加速”，“HTTPS加速”和“图片处理”加速）
-   CNAME，由Azure CDN平台提供，都是以 **.mschcdn.com**结尾，到域名提供商处将自定义域名映射到该CNAME。
-   CNAME状态，“非活动”和“活动”。

>**注意**
>您需要在CDN服务生效后（60分钟内），对你的加速域名配置CNAME映射信息，映射到微软提供的CDN域名。

>**注意**
>只有状态为**开启**的域名才可以正常使用CDN服务。

### **属性视图**
选中域名行后，右边会出现可以对改域名进行的操作的视图。属性视图可以修改源站域名或者Host Header。

![][17]

>**注意**
>Host Header表示 CDN 回源时，HTTP 请求头中的 HOST 字段的值。这个值一般是域名形式的字符串，被源站用来识别是否与源站服务器上配置的域名相同。
 **缓存规则配置视图**
 
![][4]

选中域名行后，右边会出现可以对改域名进行的操作的视图。系统会根据缓存规则设置默认规则。用户可以根据需求加以调整。用户规则优先匹配，如果用户规则未命中，则逐条执行系统默认缓存规则。


>**注意**

>- 不缓存规则优先执行
>- 缓存规则由上至下执行


### **缓存规则配置**

用户点击“配置缓存规则”后，可以根据需求设置对域名的缓存规则，包括：

- 根据目录进行配置

	目录必须以 "/" 开头，比如： "/pic", "/doc", "/htdoc/data" 等等。后台会匹配指定目录下的所有文件，**包括子目录**。

- 根据文件后缀配置

	常用文件后缀名，比如："jpg", "png", "gif", "txt", "m4v", "mp3" 等等。后台会匹配 **所有文件夹下** 指定的文件后缀。

- 根据全路径配置

	用来指定 **一个文件**，必须以 "/" 开头。比如："/sites/doc/example.doc"。

>**注意**

>- 如果用户填的全路径是"/"，则它匹配首页。
>- 用户填写配置规则时，字符串中不要包含 “{”, “}”, “(”, “)”, “[”, “]”, “.”, “?", “*”, “\”, “^”, “$” 等特殊字符。
>- 时间填为0表示禁止缓存。

**缓存配置顺序**

系统根据配置顺序**逐条匹配**，最先配置的规则具有最高优先级。规则被匹配后，其后的规则**不再**被匹配。

 **预定义模板**

用户可以通过 “应用预定义模板” 快速创建缓存配置规则。上图列出了用户选中“应用预定义模板”后，选择“常见文件”后创建的一个规则。用户可以根据需求对自动创建的规则进行修改。

 **禁止缓存设置**

勾选“设置为禁止缓存”，则该加速域名将不会被缓存。

### **访问控制管理**

通过访问控制管理，用户可以设置配置Referer黑白名单，从而实现防盗链。

![][5]

当防盗链开启之后，便可以编辑外链规则。每条规则是一个路径和文件名的组合。比如/*.png表示根目录下所有的png文件。

每条规则是一个路径和文件名的组合。比如/*.png表示根目录下所有的png文件。

- 如果设置了黑名单，那么当Referer在黑名单里面的时候，不允许访问，其他情况可以访问。
- 如果设置了白名单，那么只有当Referer是白名单中的域名时，才可以访问 。

点击“提交”按钮之后，等待操作结束，会显示操作是否成功。如果点击“提交并关闭”按钮，那么对话框会立即关闭。当用户下次再打开对话框时，会显示上次操作的状态。

## **监控和分析**<a id="step3"></a>

### **流量带宽**

你可以选择要查看的自定义速域名（单个域名或全部），时间范围，单击**刷新**按钮后界面将显示符合条件的流量统计报表、带宽统计报表，数据格式及含义请参见实际页面中的详细说明。

![][6]

**流量统计报表具有以下功能：**

-   有多个Azure 订阅的用户，可以查看单个订阅的流量以及回源流量统计。
-   有多个加速域名的Azure订阅，可以查询单个加速域名流量（以及回源流量）统计结果和所有加速域名流量（以及回源流量）汇总。
-   最小查询精度可以精确到分钟。
-   提供多种查询时间范围。 用户可以查询最近24小时，最近七天和上个月的流量统计。也可以选择查询某个特定的时间段的流量以及回源流量 （统计时间范围不超过六十天）。

**带宽统计报表具有以下功能：**

-   有多个Azure 订阅的用户，可以查询单个订阅的带宽统计和回源带宽统计。
-   有多个加速域名的Azure订阅，可以查询单个加速域名带宽（以及回源带宽）统计结果和所有加速域名带宽（以及回源带宽）汇总。
-   最小查询精度可以精确到分钟。
-   显示带宽峰值出现时间。
-   提供多种查询时间范围灵活选择。 用户可以查询最近24小时和上个月的带宽统计。也可以选择查询某个特定的时间段的带宽（统计时间范围不超过六十天）。

## **内容管理**<a id="step4"></a>

### **缓存刷新**

单击左侧导航窗格中“缓存刷新”，可以对指定的文件或者目录进行手动刷新。

 **缓存刷新列表视图**

在缓存刷新列表视图右边的“查询历史数据”视图中，选择要查询的域名、时间范围、状态，单击**刷新**后界面将显示符合条件的缓存刷新记录。
![][8]

 **缓存刷新列表视图包括：**

-   自定义域名，用于访问CDN缓存内容的URL
-   状态 (常见状态：成功，失败，刷新中）
-   提交时间

如果缓存刷新规则提交成功，状态栏会显示成功字样。如果失败的话，需要检查的缓存刷新规则是否正确。如果有问题，需要重新创建并提交缓存刷新规则。

 **提交缓存刷新**

点击“提交缓存刷新”按钮，既可以对单个文件，也可以对一个目录下的所有文件配置缓存刷新规则。

 **提交文件刷新**

![][9]

此任务包括下列步骤：

1. 选择“文件刷新”。
2. 点击“添加”。
2. 从域名列表中选取你要配置的域名，输入相应文件路径。
3. 你可以单击“添加”继续增加新的规则，也可以单击“x”来删除对应的文件。
4. 单击“提交”。

这样，新建的文件缓存规则就会显示在缓存刷新列表视图中。

>**注意**
>当加速域名尚未ICP验证通过时，无法进行文件刷新操作，加速域名下拉列表为空。请等待后台验证通过。

**提交目录刷新**

![][10]

此任务包括下列步骤：

1. 选择“文件刷新”。
2. 点击“添加”。
2. 从域名列表中选取你要配置的域名，输入相应文件路径。
3. 你可以单击“添加”继续增加新的规则，也可以单击“x”来删除对应的目录路径。
4. 单击“提交”。

这样，新建的目录缓存规则就会显示在缓存刷新列表视图中

### **预加载**
预加载是指预先将指定URL的内容从源站缓存到CDN节点，这样可以消除用户第一次访问该资源时的等待时间。预加载一般被用在进行大文件分发时的场景，可以有效的提升用户访问体验。


**预加载列表视图**

在预加载视图右边的“查询历史数据”视图中，选择要查询的域名、时间范围、状态，单击**刷新**后界面将显示符合条件的预加载记录。

![][11]
**内容预取列表视图包括：**

-   自定义域名，用于访问CDN缓存内容的URL
-   状态 （常见状态：成功，失败，进行中）
-   提交时间


如果预缓存规则提交成功，状态栏会显示成功字样。如果失败的话，需要检查的预缓存规则是否正确。如果有问题，需要重新创建并提交预缓存规则。

**提交预加载**

点击“提交缓存刷新”按钮，可以对单个文件或者多个文件配置预缓存。

![][12]

此任务包括下列步骤：

1. 在“提交预加载”视图中，单击 “添加”按钮。
2. 从自定义域名列表中选取你要配置的域名，输入相应文件路径。
3. 你可以单击“添加”继续增加新的规则，也可以单击“x”来删除对应的目录路径。
4. 单击“提交”。

这样，新建的预缓存加载规则就会显示在预缓存加载列表视图中。

## **自助服务工具**<a id="step5"></a>

### **服务检查**
用户在创建CDN服务终节点后，可以在“服务检查”视图做一些基本的检查。我们强烈建议用户在CNAME操作之前，做一下服务检查。

![][15]

如上视图，用户选择需要检查的域名后，提供一个源站可以访问的资源，然后点击“检查”。

1. 源站正常 - 表明提供的资源可以访问；
2. CDN部署完成 - 表明该域名对应的CDN服务已经部署；
3. CDN缓存正常 - 表明通过源站访问的内容和通过CDN访问的内容一致（通过比较HTTP头：HTTP Status Code，Last Modified Time，Content Length）。

>**注意**
>服务检查功能不能保证该域名所处的所有CDN边缘服务器都没有异常。

### **日志下载**
单击左侧的导航窗格中 “日志下载”，可以对指定的域名设置CDN原始日志下载相关参数。

 **日志下载视图**
日志下载需要用户首先提供一个 Azure Storage Account 用以存放CDN日志，点击“设置”进行设置。

![][13]

 **下载设置视图**

在“设置”中（如下视图右侧），用户可以设置存储账号，以及需要下载日志的域名，还可以对存储账号访问性进行验证。设置完成后，系统会把搜集到的日志自动存放到指定的存储账号中。
用户可以删除存储账号以取消日志下载。

![][14]

 **日志格式详解**
日志以 blob 的形式存放在名为 "cdn-access-logs"的容器中。每个blob是一个GZip压缩后的CSV文件。其中每一栏的含义如下：

- c-ip： 客户端IP地址
- timestamp： 访问时间
- cs-method： HTTP请求动作，如GET/HEAD等。
- cs-uri-stem： 请求的URI 
- http-ver： HTTP协议版本
- sc-status： HTTP状态码 
- sc-bytes： 服务器向客户端传送的字节数
- c-referer：客户端Referer URI
- c-user-agent：客户端User Agent标识
- rs-duration(ms)：完成请求花费的时间（单位毫秒）。
- hit-miss：CDN缓存命中、丢失标识。
- s-ip：生成日志的CDN边缘节点IP地址。

>**注意**
>如果CDN日志中未包括栏目内容，则相应记录标记为“-”，比如“c-referer”记录。此外，取决于边缘节点的日志配置，“rs-duration”、“hit-miss”、“s-ip”等记录也有可能为空。

>**注意**
>网站通过CDN加速后，其访问记录多数来源于CDN边缘节点。CDN回源时，会在HTTP Header X-Forwarded-For 中填入原始IP，源站的Web服务器可以修改日志配置该信息。如果用户需要知道客户端原始IP地址，可以参考以下信息。

>以 Nginx 为例，其配置文件可以加入如下信息：

>log_format logCDN '$remote_addr forwarded for $http_x_forwarded_for - $remote_user [$time_local]  '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent"';

>access_log /var/log/nginx/access.log logCDN;

## 密钥管理<a id="step6"></a>

单击左侧导航窗格中“密钥管理”，可以生成、创建、删除Azure CDN API接口所需的访问密钥。

**已有密钥列表视图**

该视图显示用户所有的密钥。

![][18]

**密钥列表视图包括：**

-   ID，密钥的ID
-   名称，密钥的用户友好名称
-   权限（包括只读和读写）
-   状态（包括活动、已撤销、删除中、已删除和创建中）

**密钥详细信息**

选择一个密钥，可以查看此密钥的详细信息，也可以对此密钥进行修改操作，如更新、禁用、启用和删除。

![][19]

**创建密钥**

可以创建一个新密钥。

-   名称，密钥的用户友好名称
-   只读或读写权限
  
[1]: ./media/cdn-new-portal/001.png
[2]: ./media/cdn-new-portal/002.png
[3]: ./media/cdn-new-portal/003.png
[4]: ./media/cdn-new-portal/cache-policy-2.png
[5]: ./media/cdn-new-portal/access-control.png
[6]: ./media/cdn-new-portal/004.png
[7]: ./media/cdn-new-portal/005.png
[8]: ./media/cdn-new-portal/006.png
[9]: ./media/cdn-new-portal/007.png
[10]: ./media/cdn-new-portal/008.png
[11]: ./media/cdn-new-portal/prefetch-1.png
[12]: ./media/cdn-new-portal/prefetch-2.png
[13]: ./media/cdn-new-portal/log-download-1.png
[14]: ./media/cdn-new-portal/log-download-2.png
[15]: ./media/cdn-new-portal/service-check.png
[16]: ./media/cdn-new-portal/version-change.png
[17]: ./media/cdn-new-portal/property.png
[18]: ./media/cdn-new-portal/key-1.png
[19]: ./media/cdn-new-portal/key-2.png
[20]: ./media/cdn-new-portal/key-3.png
[21]: ./media/cdn-new-portal/key-4.png