<properties 
	pageTitle="使用本地编码器执行实时流式处理以创建多比特率流" 
	description="本主题介绍如何设置接收来自本地编码器的多比特的实时流的频道。然后，该流可以使用以下自适应流式处理协议之一通过一个或多个流式处理终结点传递给客户端播放应用程序：HLS、平滑流、MPEG DASH、HDS。" 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="erikre" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.date="05/10/2016"
	wacn.date="06/20/2016"/>

#使用本地编码器执行实时流式处理以创建多比特率流

##概述

在 Azure 媒体服务中，**频道**表示用于处理实时流内容的管道。**频道**通过以下方式接收实时输入流：

本地实时编码器将多比特率 **RTMP** 或 **平滑流**（分片 MP4）发送到频道。可以使用以下输出多比特率平滑流的实时编码器：Elemental、Envivio、Cisco。以下实时编码器输出 RTMP：Adobe Flash Live、Telestream Wirecast 和 Tricaster 转码器。引入的流将会直接通过**频道**，而不会经过任何进一步的处理。你的实时编码器可以 lso 发送单比特率流，但不是建议使用。收到请求时，媒体服务会将该流传递给客户。


下图表示的是一个使用本地实时编码器输出多比特率 RTMP 或分片 MP4 流（平滑流式处理）的实时流式处理工作流。

![实时工作流][live-overview]

本主题涵盖以下内容：

- [常见实时流式处理方案](/documentation/articles/media-services-live-streaming-with-onprem-encoders/#scenario)
- [频道及其相关组件的说明](/documentation/articles/media-services-live-streaming-with-onprem-encoders/#channel)
- [注意事项](/documentation/articles/media-services-live-streaming-with-onprem-encoders/#considerations)

##<a id="scenario"></a>常见实时流式处理方案
以下步骤介绍创建常见的实时流式处理应用程序时涉及的任务。

1. 将视频摄像机连接到计算机。启动并配置输出多比特率 RTMP 或分段 MP4（平滑流式处理）流的本地实时编码器接收实时输入流。有关详细信息，请参阅 [Azure 媒体服务 RTMP 支持和实时编码器](https://azure.microsoft.com/zh-cn/blog/azure-media-services-rtmp-support-and-live-encoders/)。
	
	此步骤也可以在创建频道后执行。

1. 创建并启动频道。
1. 检索频道引入 URL。 

	实时编码器使用引入 URL 将流发送到频道。
1. 检索频道预览 URL。 

	使用此 URL 来验证频道是否正常接收实时流。

3. 创建节目。

	使用 Azure 管理门户时，创建节目的同时还会创建资产。

	使用 .NET SDK 或 REST 时，你需要创建一个资源并指定在创建节目时要使用该资源。 
1. 发布与节目关联的资源。   

	确保你要从中以流形式传输内容的流式传输终结点上至少有一个流式传输保留单元。
1. 在准备好开始流式传输和存档时，启动节目。
2. （可选）可以向实时编码器发信号，以启动广告。将广告插入到输出流中。
1. 在要停止对事件进行流式传输和存档时，停止节目。
1. 删除节目（并选择性地删除资产）。     

##<a id="channel"></a>通道及其相关组件的说明

###<a id="channel_input"></a>通道输入（引入）配置

####<a id="ingest_protocols"></a>引入流式传输协议

媒体服务支持使用以下流式处理协议引入的实时源：

- **多比特率分片 MP4**
 
- **多比特率 RTMP**

	当选择了 **RTMP** 引入流式传输协议时，会为通道创建两个引入（输入）终结点：
	
	**主 URL**：指定频道的主 RTMP 引入终结点的完全限定 URL。

	**辅助 URL**（可选）：指定频道的辅助 RTMP 引入终结点的完全限定 URL。


	如果你想要提高引入流的持久性和容错性，并实现编码器故障转移和容错性（尤其在以下情况时），请使用辅助 URL。

	- 单个编码器双推送到主和辅助的 URL：
	
		这样做的主要目的是为网络波动和抖动提供更多的复原能力。某些 RTMP 编码器无法良好处理网络断开连接情况。当出现网络断开连接时，编码器可能会停止编码，且在重新连接情况发生时，不再发送缓冲的数据，这将导致不连续性和数据丢失。网络断开连接可能是由错误的网络或 Azure 端的维护导致。主/辅助 URL 可减少网络问题，并且提供受控的升级过程。每当计划的网络发生断开连接情况时，媒体服务管理主要和次要断开连接并为两者提供延迟断开连接，从而使编码器有时间留发送的数据并且再次重新连接。断开连接的顺序可以是随机的，但是在主要/次要或次要/主要之间将始终存在延迟。在此方案中，编码器仍是单点故障。
	 
	- 多个编码器中每个编码器推送到专用的点：
		
		此方案提供编码器以及引入冗余。在此方案中编码器 1 推送到主 URL，且 编码器 2 推送到辅助 URL。当一个编码器失败时，另一个编码器仍可以发送数据。由于媒体服务不会在同一时间主要和次要均断开连接，仍可保持数据冗余。此方案假定编码器为时间同步，并提供完全相同的数据。
 
	- 多个编码器双推送到主和辅助的 URL：
	
		在此方案中这两个编码器将数据推送到主和辅助的 Url。这提供了最佳的可靠性、容错能力以及数据冗余。它可以容忍两个编码器均失败，并且即使一个编码器停止工作时亦会断开连接。此方案假定编码器为时间同步，并提供完全相同的数据。

有关 RTMP 实时编码器详细信息，请参阅 [Azure 媒体服务的 RTMP 支持和实时编码器](https://azure.microsoft.com/zh-cn/blog/azure-media-services-rtmp-support-and-live-encoders/)。

请注意以下事项：

- 确保你有足够的空闲 Internet 连接来将数据发送到引入点。 
- 使用辅助引入 URL 需要额外的带宽。 
- 传入多比特率流最多可包含 10 个视频质量级别（又称层）和最多为 5 个音频曲目。
- 任何视频质量级别或图层的最高的平均比特率应低于 10 mbps。
- 所有视频和音频流的均比特率聚合平应小于 25 Mbps。
- 当频道或其关联的节目正在运行时，无法更改输入协议。如果你需要不同的协议，应当针对每个输入协议创建单独的频道。 
- 你可引入单比特至你的频道，但由于频道不处理流，客户端应用程序也会接收单比特率流（不建议使用此选项）。

####摄取 URL（终结点） 

频道提供你在实时编码器中指定的输入终结点（引入 URL），因此编码器可以将流推送到你的频道。

当创建频道时，你可以获取摄取 URL。若要获取这些 URL，频道不一定要处于“正在运行”状态。当准备好开始将数据推送到频道时，频道必须处于“正在运行”状态。在频道开始引入数据后，你可以通过预览 URL 来预览流。

可以选择通过 SSL 连接引入分片 MP4（平滑流）实时流。若要通过 SSL 进行摄取，请确保将摄取 URL 更新为 HTTPS。当前，无法通过 SSL 摄取 RTMP。

####<a id="keyframe_interval"></a>关键帧间隔

当使用本地实时编码器生成多比特率流时，关键帧间隔指定 GOP 持续时间（与该外部编码器使用的相同）。当频道收到此传入流后，你可以通过下列任意格式将你的实时流传送到客户端播放应用程序：平滑流式处理、DASH 和 HLS。当执行实时流式传输时，HLS 始终是动态打包的。默认情况下，媒体服务根据从实时编码器收到的关键帧间隔（也称为图片组 – GOP）自动计算 HLS 段打包比率（每段的片数）。

下表显示了段持续时间是如何计算的：

关键帧间隔|HLS 段打包比率 (FragmentsPerSegment)|示例
---|---|---
小于或等于 3 秒|3:1|如果 KeyFrameInterval（或 GOP）为 2 秒长，则默认的 HLS 段打包比率将是 3:1，这将创建一个 6 秒的 HLS 段。
3 到 5 秒|2:1|如果 KeyFrameInterval（或 GOP）为 4 秒长，则默认的 HLS 段打包比率将是 2:1，这将创建一个 8 秒的 HLS 段。
大于 5 秒|1:1|如果 KeyFrameInterval（或 GOP）为 6 秒长，则默认的 HLS 段打包比率将是 1:1，这将创建一个 6 秒长的 HLS 段。


你可以通过配置频道的输出并设置 ChannelOutputHls 上的 FragmentsPerSegment 来更改每段的片数这一比率。

你还可以通过设置 ChanneInput 上的 KeyFrameInterval 属性更改关键帧间隔值。

如果你显式设置了 KeyFrameInterval，则会使用上面所述的规则计算 HLS 段打包比率 FragmentsPerSegment。

如果你同时显式设置了 KeyFrameInterval 和 FragmentsPerSegment，则媒体服务将使用你设置的值。


####允许的 IP 地址

你可以定义允许向此频道发布视频的 IP 地址。允许的 IP 地址可以指定为单个 IP 地址（例如“10.0.0.1”）、使用一个 IP 地址和 CIDR 子网掩码的 IP 范围（例如“10.0.0.1/22”），或使用一个 IP 地址和点分十进制子网掩码的 IP 范围（例如“10.0.0.1(255.255.252.0)”）。

如果未指定 IP 地址并且没有规则定义，则不会允许任何 IP 地址。若要允许任何 IP 地址，请创建一个规则并设置 0.0.0.0/0。

###频道预览 

####预览 URL

频道还提供了一个预览终结点（预览 URL），你可以使用它在进一步处理和传递流之前预览流并对其进行验证。

你可以在创建频道时获取预览 URL。若要获取该 URL，频道不一定要处于**“正在运行”**状态。

在频道开始摄取数据后，你可以预览流。

请注意，当前，不管指定了哪种输入类型，都只能以分片 MP4 (Smooth Streaming) 格式来传送预览流。你可以使用 [http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor) 播放器来测试平滑流。你还可以使用 Azure 管理门户中承载的播放器来查看你的流。


####允许的 IP 地址

你可以定义允许连接到预览终结点的 IP 地址。如果未指定 IP 地址，则将允许任何 IP 地址。允许的 IP 地址可以指定为单个 IP 地址（例如“10.0.0.1”）、使用一个 IP 地址和 CIDR 子网掩码的 IP 范围（例如“10.0.0.1/22”），或使用一个 IP 地址和点分十进制子网掩码的 IP 范围（例如“10.0.0.1(255.255.252.0)”）。

###频道输出

有关更多信息，请参阅[设置关键帧间隔](#keyframe_interval)部分。


###频道的节目

频道与节目相关联，使用节目，你可以控制实时流中的段的发布和存储。通道管理节目。频道和节目的关系非常类似于传统媒体，频道具有恒定的内容流，而节目的范围限定为该频道上的一些定时事件。

可以通过设置**存档窗口**长度，指定你希望保留节目录制内容的小时数。此值的设置范围是最短 5 分钟，最长 25 小时。存储时间窗口长度还决定了客户端能够从当前实时位置按时间向后搜索的最长时间。超出指定时间长度后，节目也能够运行，但落在时间窗口长度后面的内容将全部被丢弃。此属性的这个值还决定了客户端清单能够增加多长时间。

每个节目都与存储流式处理内容的资源相关联。资产将映射到 Azure Storage 帐户中的 BLOB 容器，资产中的文件则作为该容器中的 BLOB 存储。若要发布节目，以便客户可以查看该流，必须为关联的资源创建按需定位符。创建此定位符后，你可以生成提供给客户端的流 URL。

一个通道最多支持三个并发运行的节目，因此你可以为同一传入流创建多个存档。这样，你便可以根据需要发布和存档事件的不同部分。例如，你的业务要求是存档 6 小时的节目，但只广播过去 10 分钟的内容。为了实现此目的，你需要创建两个同时运行的节目。一个节目设置为存档 6 小时的事件但不发布该节目。另一个节目设置为存档 10 分钟的事件，并且要发布该节目。

不应当将现有节目重用于新事件。而是应当为每个事件创建并启动一个新节目，如“对实时流式传输应用程序进行编程”部分中所述。

在准备好开始流式传输和存档时，启动节目。在要停止对事件进行流式传输和存档时，停止节目。

若要删除存档的内容，请停止并删除节目，然后删除关联的资产。如果资产被某个节目使用，则无法将其删除，必须先删除该节目。

即使你停止并删除了节目，只要你没有删除资产，用户也将能够按需将你的已存档内容作为视频进行流式传输。

如果希望保留已存档的内容但不希望其可供流式传输，请删除流式传输定位符。

##<a id="states"></a>频道状态，以及状态如何映射到计费模式 

频道的当前状态。可能的值包括：

- **已停止**。这是频道在创建后的初始状态。在此状态下，可以更新频道属性，但不允许进行流式传输。
- **正在启动**。频道正在启动。在此状态下，不允许进行更新或流式传输。如果发生错误，则频道会返回到“已停止”状态。
- **正在运行**。频道能够处理实时流。
- **正在停止**。频道正在停止。在此状态下，不允许进行更新或流式传输。
- **正在删除**。频道正被删除。在此状态下，不允许进行更新或流式传输。

下表显示频道状态如何映射到计费模式。
 
频道状态|门户 UI 指示器|是否计费？
---|---|---|---
正在启动|正在启动|否（暂时状态）
正在运行|准备就绪（没有正在运行的节目）<p>或<p>流式处理（至少有一个正在运行的节目）|是
正在停止|正在停止|否（暂时状态）
已停止|已停止|否

##<a id="cc_and_ads"></a>隐藏字幕和广告插入 

下表展示了支持的隐藏字幕和广告插入标准。

标准|说明
---|---
CEA-708 和 EIA-608 (708/608)|CEA-708 和 EIA-608 是美国和加拿大实施的隐藏字幕标准。<p><p>当前，只有当编码的输入流中携带了该字幕时才支持该字幕。你需要使用能够向发送到媒体服务的编码流插入 608 或 708 字幕的实时媒体编码器。媒体服务会将带有插入的字幕的内容传送到你的显示器。
ismt 内的 TTML（Smooth Streaming 文本轨道）|媒体服务动态打包功能允许你的客户端对下列任何格式的内容进行流式传输：MPEG DASH、HLS 或平滑流式处理。不过，如果你摄取了 .ismt 内带有字幕（Smooth Streaming 文本轨道）的分片 MP4 (Smooth Streaming)，则只能将该流传送到 Smooth Streaming 客户端。
SCTE-35|用来提示广告插入的数字信号系统。下游接收器使用该信号来将广告接合到流中并使其占用规定的时间。SCTE-35 必须在输入流中作为稀疏轨道发送。<p><p>请注意，当前唯一受支持的可以携带广告信号的输入流格式是分片 MP4 (Smooth Streaming)。唯一受支持的输出格式也是 Smooth Streaming.


##<a id="Considerations"></a>注意事项

当使用本地实时编码器将多比特率流发送到一个频道时，以下限制将适用：

- 确保你有足够的空闲 Internet 连接来将数据发送到引入点。
- 传入多比特率流最多可包含 10 个视频质量级别（10 层）和最多为 5 个音频曲目。
- 任何视频质量级别或图层的最高的平均比特率应低于 10 Mbps
- 所有视频流和音频流的平均比特率聚合平应小于 25 Mbps
- 当频道或其关联的节目正在运行时，无法更改输入协议。如果你需要不同的协议，应当针对每个输入协议创建单独的频道。


其他有关使用频道及其相关组件的注意事项：

- 每次重新配置实时编码器后，请对频道调用**重置**方法。在重置频道之前，必须停止节目。在重置频道后，重新启动节目。
- 只有当频道处于“正在运行”状态且频道中的所有节目都已停止时才能停止频道。
- 默认情况下，你只能向你的媒体服务帐户添加 5 个频道。有关详细信息，请参阅[配额和限制](/documentation/articles/media-services-quotas-and-limitations/)。
- 当频道或其关联的节目正在运行时，无法更改输入协议。如果你需要不同的协议，应当针对每个输入协议创建单独的频道。
- 仅当你的频道处于**“正在运行”**状态时才会向你收费。有关详细信息，请参阅[此](/documentation/articles/media-services-live-streaming-with-onprem-encoders/#states)部分。

##如何创建从本地编码器接收多比特率实时流的频道

有关本地实时编码器的更多信息，请参阅[将第三方实时编码器与 Azure 媒体服务结合使用](https://azure.microsoft.com/blog/azure-media-services-rtmp-support-and-live-encoders/)。

选择**“门户”**、**.NET**、**REST API** 以了解如何创建和管理频道和节目。

[AZURE.INCLUDE [media-services-selector-manage-channels](../includes/media-services-selector-manage-channels.md)]





##相关主题

[Azure 媒体服务分片 MP4 实时引入规范](/documentation/articles/media-services-fmp4-live-ingest-overview/)

[使用 Azure 媒体服务传递实时流式处理事件](/documentation/articles/media-services-live-streaming-workflow/)

[媒体服务概念](/documentation/articles/media-services-concepts/)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png


<!---HONumber=Mooncake_0613_2016-->