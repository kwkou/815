<properties 
   pageTitle="流量管理器 - 流量路由方法 | Windows Azure"
   description="本文将帮助你了解流量管理器使用的各种流量路由方法。"
   services="traffic-manager"
   documentationCenter=""
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.date="08/19/2015"
   wacn.date="11/02/2015" />

# 流量管理器路由方法

流量管理器中提供了三种流量路由方法。虽然你随时可以为配置文件选择不同的流量路由方法，但每个流量管理器配置文件每次只能使用一种流量路由方法。

请务必注意，所有流量路由方法都包括终结点监视。在配置流量管理器配置文件来指定最符合你要求的流量路由方法后，可配置监视设置。正确配置监视后，流量管理器将监视终结点（包括云服务和网站）的状态，并且不会向它认为不可用的终结点发送流量。有关流量管理器监视的信息，请参阅[关于流量管理器监视](/documentation/articles/traffic-manager-monitoring)。

以下是三种流量管理器流量路由方法：

- **故障转移**：如果终结点位于相同或不同的 Azure 数据中心（在管理门户中称为区域）内，并且你想要为所有流量使用一个主终结点，但是希望在主终结点或备用终结点不可用时提供备份，请选择“故障转移”。有关详细信息，请参阅[故障转移流量路由方法](#failover-traffic-routing-method)。

- **轮循机制**：如果要将负载分配到同一数据中心内的一组终结点或者分配到不同的数据中心，请选择“轮循机制”。有关详细信息，请参阅[轮循机制流量路由方法](#round-robin-traffic-routing-method)。

- **性能**：如果终结点位于不同的地理位置，并且你希望发出请求的客户端依据最低延迟使用“最近的”终结点，请选择“性能”。有关详细信息，请参阅[性能流量路由方法](#performance-traffic-routing-method)。

请注意，无论网站模式如何，Azure 网站都已经针对数据中心内的网站提供了故障转移和轮循机制流量路由方法功能。你可以使用流量管理器为不同数据中心内的网站指定故障转移和轮询机制流量路由。

>[AZURE.NOTE]DNS 生存时间 (TTL) 指示 DNS 客户端以及 DNS 服务器上的解析程序要将解析的名称缓存多久。客户端将持续使用给定的终结点来解析域名，直到该名称的本地 DNS 缓存条目过期。

## 故障转移流量路由方法

组织通常希望为服务提供可靠性。一般通过在主服务发生故障时提供备用服务来实现这一目的。一种常用的服务故障转移模式是提供一组相同的终结点并向主服务发送流量，同时，提供包含一个或多个备份的列表。如果主服务不可用，则按顺序将发出请求的客户端路由到下一个服务。如果列表中的第一个和第二个服务都不可用，流量将转到第三个服务，依此类推。

在配置“故障转移”流量路由方法时，所选终结点的顺序非常重要。你可以使用管理门户在配置文件的“配置”页上配置故障转移顺序。

图 1 显示了针对一组终结点的“故障转移”流量路由方法的示例。

![流量管理器“故障转移”路由方法](./media/traffic-manager-routing-methods/IC750592.jpg)

**图 1**

以下带编号的步骤与图 1 中的数字相对应。

1. 流量管理器通过 DNS 收到来自客户端的传入请求，然后查找配置文件。
2. 配置文件包含终结点的有序列表。流量管理器检查哪个终结点是列表中的第一个。如果该终结点已联机（由进行中的终结点监视判定），则流量管理器将在对客户端所做的 DNS 响应中指定该终结点的 DNS 名称。如果该终结点脱机，则流量管理器将确定列表中的下一个联机终结点。在本例中，CS-A 脱机（不可用），但 CS-B 联机（可用）。
3. 流量管理器将 CS-B 的域名返回到客户端的 DNS 服务器，该服务器再将域名解析为 IP 地址，并将该地址发送到客户端。
4. 客户端向 CS-B 发起通信。

## 轮循机制流量路由方法

一种常见的流量路由模式是提供一组相同的终结点，并以循环方式向每个终结点发送流量。“循环”方法将流量拆分到不同的终结点之间。它将随机选择一个正常运行的终结点，而且不会将流量发送到检测为处于脱机状态的服务。有关详细信息，请参阅[流量管理器监视](/documentation/articles/traffic-manager-monitoring)。

图 2 显示了针对一组终结点的“轮循机制”流量路由方法的示例。

![流量管理器“轮循机制”路由方法](./media/traffic-manager-routing-methods/IC750593.jpg)

**图 2**

以下带编号的步骤与图 2 中的数字相对应。

1. 流量管理器收到来自客户端的传入请求，然后查找配置文件。
2. 配置文件包含终结点的列表。流量管理器从此列表中随机选择一个终结点，不包括由流量管理器终结点监视确定为脱机的（不可用的）任何终结点。在本例中，此终结点是 CS-B。
3. 流量管理器将 CS-B 的域名返回到客户端的 DNS 服务器。客户端的 DNS 服务器将此域名解析为 IP 地址，并将该地址发送到客户端。
4. 客户端向 CS-B 发起通信。

“轮循机制”流量路由还支持将网络流量进行加权分布。图 3 显示了针对一组终结点的加权“轮循机制”流量路由方法的示例。

![轮循机制加权路由方法](./media/traffic-manager-routing-methods/IC750594.png)

**图 3**

使用加权的“轮循机制”流量路由，可以根据为每个终结点分配的权重值，将负载分配到各个终结点。权重越大，将返回某个终结点的频率越高。此方法适用于的方案包括：

- 应用程序逐步升级：分配要路由到新终结点的流量百分比，并随着时间的推移逐渐将流量增加到 100％。
- 到 Azure 的应用程序迁移：创建一个包含 Azure 和外部终结点的配置文件，并为要路由到每个终结点的流量指定权重。
- 适用于更多容量的云爆发：通过将本地部署放在流量管理器配置文件之后，快速将本地部署扩展到云中。当你需要在云中获得额外的容量时，可以添加或启用更多终结点，并指定哪部分流量将流向每个终结点。

目前，不能使用管理门户来配置加权的流量路由。Azure 支持使用服务管理 REST API 和 Azure PowerShell cmdlet 对此方法进行编程访问。

有关使用 REST API 的信息，请参阅[有关流量管理器的操作（REST API 参考）](https://msdn.microsoft.com/zh-cn/library/hh758255.aspx)。

有关使用 Azure PowerShell cmdlet 的信息，请参阅 [Azure 流量管理器 Cmdlet](https://msdn.microsoft.com/zh-cn/library/dn690250.aspx)。有关示例配置，请参阅 Azure 博客中的 [Azure 流量管理器外部终结点与通过 PowerShell 实施的加权轮循机制](http://azure.microsoft.com/blog/2014/06/26/azure-traffic-manager-external-endpoints-and-weighted-round-robin-via-powershell/)。

若要从单个客户端测试配置文件并观察平等的或加权的循环行为，请验证是否能够根据配置文件中的相等值或加权值，将 DNS 名称解析为终结点的不同 IP 地址。测试时，你必须禁用客户端 DNS 缓存或在每次尝试操作之后清除 DNS 缓存，以确保发送新的 DNS 名称查询。

## 性能流量路由方法

若要对分布在全球不同数据中心的终结点进行流量路由，可以将传入的流量定向到最靠近的终结点，因为发出请求的客户端与该终结点之间的延迟最低。通常，“最靠近的”终结点对应于地理距离最短的终结点。使用“性能”流量路由方法可以基于位置和延迟进行分发，但无法考虑网络配置或负载中的实时变化。

“性能”流量路由方法查找发出请求的客户端，并将它路由到最靠近的终结点。“靠近程度”由“Internet 延迟表”确定，该表显示了不同 IP 地址与每个 Azure 数据中心之间的往返时间。此表定期更新，但并不是 Internet 性能的实时反映。此方法不考虑给定服务上的负载，不过，流量管理器将会根据选择的方法监视终结点，如果终结点不可用，则不将这些终结点包含在 DNS 查询响应中。换句话说，“性能”流量路由也包含“故障转移”流量路由方法。

图 4 显示了针对一组终结点的“性能”流量路由方法的示例。

![流量管理器“性能”路由方法](./media/traffic-manager-routing-methods/IC753237.jpg)

**图 4**

以下带编号的步骤与图 4 中的数字相对应。

1. 流量管理器定期生成“Internet 延迟表”。流量管理器基础结构运行测试来确定全球不同点与托管着终结点的 Azure 数据中心之间的往返时间。
2. 流量管理器通过其本地 DNS 服务器收到来自客户端的传入请求，然后查找配置文件。
3. 流量管理器在“Internet 延迟表”的行中查找传入 DNS 请求的 IP 地址。由于用户的本地 DNS 服务器正在执行迭代 DNS 查询来查找流量管理器配置文件名称的权威 DNS 服务器，因此从客户端的本地 DNS 服务器的 IP 地址发送 DNS 查询。
4. 流量管理器针对托管着配置文件所定义终结点的数据中心查找时间最短的数据中心。在本例中为 CS-B。
5. 流量管理器将 CS-B 的域名返回到客户端的本地 DNS 服务器，该服务器再将域名解析为 IP 地址，并将该地址发送到客户端。
6. 客户端向 CS-B 发起通信。

**需要注意的要点：**

- 如果配置文件包含同一数据中心内的多个终结点，则在由终结点监视判定为可用且正常运行的终结点之间平均分配定向到该数据中心的流量。
- 如果给定数据中心中的所有终结点均不可用（由终结点监视判定），则这些终结点的流量将在该配置文件中指定的所有其他可用终结点之间分发，而不分发至接下来最近的终结点。这有助于避免当下一个最靠近的终结点过载时可能发生的级联失败。
- 当“Internet 延迟表”更新后，你可能会发现终结点上的流量模式和负载有所变化。这些变化应该很小。
- 对外部终结点使用“性能”流量路由方法时，需要指定这些终结点的位置。请选择离你的部署最近的 Azure 区域。有关详细信息，请参阅[在流量管理器中管理终结点](/documentation/articles/traffic-manager-endpoints)。

## 流量管理器图表

如果你需要本主题中的图表作为自己的流量管理器相关演示文稿的 PowerPoint 内容，或者需要按照自己的意图进行修改，请参阅 [MSDN 文档中的流量管理器图表](http://gallery.technet.microsoft.com/Traffic-Manager-figures-in-887e7c99)。

## 后续步骤

[什么是流量管理器？](/documentation/articles/traffic-manager-overview)

[关于流量管理器监视](/documentation/articles/traffic-manager-monitoring)

[流量管理器上的操作（REST API 参考）](https://msdn.microsoft.com/zh-CN/library/hh758255.aspx)

[云服务](https://msdn.microsoft.com/zh-CN/library/jj155995.aspx)

[网站](/home/features/web-site/)

[Azure 流量管理器 Cmdlet](https://msdn.microsoft.com/zh-cn/library/dn690250.aspx)

 

<!---HONumber=76-->