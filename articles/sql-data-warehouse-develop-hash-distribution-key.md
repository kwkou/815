<properties
   pageTitle="哈希分布及其对 SQL 数据仓库中查询性能的影响 | Azure"
   description="在开发解决方案之前，了解哈希分布表及其如何影响 Azure SQL 数据仓库中的查询性能。"
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.date="03/03/2016"
   wacn.date="04/11/2016"/>

# 哈希分布及其对 SQL 数据仓库中查询性能的影响

做出明智的哈希分布决策是改善查询性能最重要的方式之一。

事实上，有三个主要因素：

1. 最小化数据移动
2. 避免数据偏斜
3. 提供平衡的执行

## 最小化数据移动
将表联接在一起或在表上执行聚合时，最常发生的情况就是数据移动。共享密钥中的哈希分布表是最小化此移动的最有效方法之一。

但是，若要让哈希分布对最小化移动发挥效果，必须符合以下所有条件：

1. 这两个表需为哈希分布式，并在共享的分布密钥上联接
2. 这两个列的数据类型需要匹配
3. 联接的列需为等值联接（即，左表列中的值需要等于右表列中的值）
4. 联接**不是** `CROSS JOIN`

> [AZURE.NOTE] 在 `JOIN`、`GROUP BY`、`DISTINCT` 和 `HAVING` 子句中使用的列都生成适当的哈希列候选项。另一方面，用于 `WHERE` 子句的列**不会**生成适当的哈希列候选项。请参阅以下与平衡执行相关的部分。

当查询语法（`COUNT DISTINCT` 和 `OVER` 两个子句都是绝佳示例）和不包含哈希分布键的列配合使用时，也可能发生数据移动。

> [AZURE.NOTE] 轮循机制表通常产生数据移动。表中的数据已经以不具确定性的方式分配，因此必须在大多数查询完成之前移动数据。

## 避免数据偏斜
为了使哈希分布有效，选择的列必须展示以下属性：

1. 该列包含大量的相异值。
2. 该列不会受到**数据偏斜**的影响。

每个相异值将分配到某个分布区。因此，数据需要合理数目的相异值，以确保生成足够的唯一哈希值。否则，我们可能会获得质量不佳的哈希。例如，如果分布区数目超过相异值的数目，某些分布区将保留空白。这会降低性能。

同样，如果哈希列的所有行都包含相同值，则数据就会**偏斜**。在此极端情况下，只能创建一个哈希值，导致所有行最后都在单个分布区内。在理想情况下，哈希列中的每个相异值都有相同数目的行。

> [AZURE.NOTE] 轮循机制表不会表现出偏斜的迹象。这是因为数据跨分布区平均存储。

## 提供平衡的执行
当每个分布区有相同数量的工作要执行时，就会实现平衡的执行。大规模并行处理 (MPP) 是一种团队游戏；在任何人被声明为赢家之前，每个人都必须取得胜利。如果每个分布区有相同数量的工作（也就是要处理的数据），则所有查询都会在大致相同的时间完成。这就是所谓的平衡执行。

我们知道，数据偏斜可能影响平衡的执行。但是，也因此可以选择哈希分布键。如果已选择出现在查询的 `WHERE` 子句中的列，则查询很有可能不平衡。

> [AZURE.NOTE] `WHERE` 子句通常有助于识别最适合用于分区的列。

出现在 `WHERE` 子句中的列的代表性示例是日期字段。日期字段是分区列极好、但哈希分布列通常极差的典型示例。一般而言，数据仓库查询将维持一段指定的时间，例如日、周或月。基于日期的哈希分布可能真正限制了我们的缩放性并损害了性能。例如，如果指定的日期范围是一周（即 7 天），则哈希的最大数目就是 7 - 每天一个。这意味着只有 7 个分布区包含数据。其余的分布区没有任何数据。这会导致不平衡的查询执行，因为只有 7 个分布区在处理数据。

> [AZURE.NOTE] 轮循机制表通常提供平衡的执行。这是因为数据跨分布区平均存储。

## 建议
若要最大化性能和整体查询吞吐量，请尽量确保哈希分布表遵循以下模式：

哈希分布键：

1. 是静态值，因为无法更新哈希列。 
2. 在查询的 `JOIN`、`GROUP BY`、`DISTINCT` 或 `HAVING` 子句中使用。
2. 不在 `WHERE` 子句中使用
3. 至少有 1000 个不同的值。
4. 不会将大量的不成比例的行哈希到少量的分布区。
5. 定义为 NOT NULL。NULL 行将聚集在单个分布区中。

## 摘要

哈希分布可总结如下：

- 哈希函数具确定性。相同的值始终分配到同一个分布区。
- 一个列用作分布列。哈希函数使用指定的列来计算分布区的行分配。
- 哈希函数基于列的类型，而不是本身的值
- 哈希分布表有时可能造成偏斜的表
- 解析查询时，哈希分布表通常需要较少的数据，因此可以改善大型事实表的查询性能。
- 遵循有关选择哈希分布列的建议，以增强查询吞吐量。

> [AZURE.NOTE] 在 SQL 数据仓库中，数据类型一致性相当重要！ 请确保现有架构一致使用相同类型的列。这对分布键尤其重要。如果未同步分布键数据类型，且表已联接，将会发生不必要的数据移动。如果表很大，成本可能很高，并且导致吞吐量和性能降低。


## 后续步骤
有关更多开发技巧，请参阅[开发概述][]。

<!--Image references-->

<!--Article references-->
[开发概述]: /documentation/articles/sql-data-warehouse-overview-develop/

<!--MSDN references-->

<!--Other Web references-->

<!---HONumber=Mooncake_0321_2016-->