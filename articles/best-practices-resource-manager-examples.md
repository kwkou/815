<properties
	pageTitle="实现模板的最佳做法的上下文示例"
	description="显示体现了最佳实践的 Azure 资源管理器模板的示例。"
	services="azure-resource-manager"
	documentationCenter=""
	authors="mmercuri"
	manager="georgem"
	editor="tysonn"/>

<tags
	ms.service="azure-resource-manager"
	ms.date="08/13/2015"
	wacn.date="10/3/2015"/>

# 实现模板的最佳做法的上下文示例

本主题提供了 7 个上下文示例，说明了如何实现 Azure 资源管理器模板。有关这些示例中所述原理的概述，请参阅[设计 Azure 资源管理器模板的最佳做法](/documentation/articles/best-practices-resource-manager-design-templates)。

本主题是包含更多内容的白皮书的一部分。若要阅读完整的白皮书，请下载 [一流的 ARM 模板注意事项和成熟的做法](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf)。

## 将功能范围模板移到端到端解决方案范围模板中

功能范围模板的开发模式此前已讨论过。您可能会自问：单独使用此功能范围模板或者将其用作端到端解决方案范围模板的一部分，是否需要进行不同的考虑？

例如，如果使用一种以技术为主导的模板将 SQL Server 作为功能进行部署，则单独使用该模板或将其用作端到端解决方案范围模板（后者可能会使用该 SQL Server 来支持 Web 应用程序，因此范围更广），需要进行什么样的不同的考虑（如果需要进行不同的考虑的话）？

审视这种方案时，有必要查看可能会涉及到的资源的数目。若要进行强大的实现，功能范围模板不能仅仅是存储帐户和只安装了 SQL Server 的单个 VM。强大的功能范围模板将会部署多个 VM，而部署的 SQL Server 可实现高可用性。对于某些功能（如 Analysis Services）来说，您的拓扑可能还一起部署了 Active Directory。

此方案的两大考虑因素是：SQL Server 的使用生命周期，以及您希望应用的 RBAC。具体说来就是，是将 SQL Server 设置为与解决方案的其他部分一起更新和删除，还是将其设置为与解决方案或解决方案的其他部分具有不同的生命周期？如果生命周期不同，则需考虑将其置于其他资源组中。

另一考虑因素是，您希望如何将 RBAC 应用于 SQL Server 功能范围解决方案模板。根据您所希望的在拓扑中应用 RBAC 的方式，您可以针对具体情况选择使用不同的资源组。您可以在资源级别应用 RBAC，但也可以考虑设置一个单独的资源组并向其应用 RBAC，具体取决于适用于 SQL Server 功能范围解决方案模板的资源的数目。

还可以考虑对 SQL Server 功能范围解决方案模板进行评估，确定其当前是否会自行创建某些资源（不同于允许您“自带资源”的情况）。 在“自带资源”(BYOR) 模型中，功能范围解决方案模板将允许您的模板重复使用业已存在的资源，存储帐户、虚拟网络或可用性集都是典型的示例。如果您的功能范围模板中不存在 BYOR 方式，您可以使用本文档中此前为可选资源模板定义的方式来更改它。在这种情况下，您的端到端解决方案范围模板将会有一个针对这些常用资源的共享资源模板，而功能范围模板将会进行扩展，因而可将这些资源设置为可选资源。这样便可创建更好的功能范围解决方案模板，因为该模板现在既可独立使用，也可联合使用。

在评估是否应从端到端解决方案范围模板中传入存储帐户时，还应重新评估 RBAC。具体说来就是，需要确保将 RBAC 应用于此特定资源吗？ 如果答案是需要（即在传入资源时，需要将 RBAC 应用到该资源），则不仅应对解决方案模块设置信任级别，还应对任何希望能够选择性地将此功能提供给功能范围模板（当独立使用时）的用户设置信任级别。如果 RBAC 很重要，则应考虑是将此模板设置为功能范围解决方案模板内的可选模板，还是要求在功能范围解决方案模板内通过必需的 RBAC 来创建此模板。

如果决定将这些资源置于不同的资源组中，您还可以使用“资源链接”来定义这些资源之间的关系，即使这些资源分布在多个资源组中。

## 使用多个功能范围模板来创建端到端解决方案范围模板

这在很大程度上是前一示例的超集。在此方案中，一个组织有多个针对一系列数据技术（例如 Kafka、Apache Hadoop、Apache Spark 和 Apache Storm）的功能范围解决方案模板，他们希望将这些技术集中到单个解决方案模块中。生成的组合方案将使用这些功能范围解决方案模板，以及共享的存储和虚拟网络，并进行具体的子网分配。

除了需要特定的功能范围模板，该解决方案还需要其他资源，例如，可能需要编写脚本将这些功能范围模板集成在一起并对其进行配置。

在本方案中，已确定还需使用共享虚拟网络和共享存储帐户。为此，您需要在端到端解决方案范围模板中将这些资源添加到共享资源模板中，并确保功能范围模板支持“自带资源”方式。如果功能范围模板不支持此方式，您可以对该模板进行相应的修改，如前面的示例所述。

若要添加更多的资源，您需要遵循创建单个功能范围模板时所使用的一大系列的模式。在本方案中，您需要添加共享资源模板、可选资源模板、成员节点模板，以及新资源所需的状态配置（脚本、Chef、Puppet、Powershell DSC）。存在依赖关系时，您需要进行优化，以便尽可能使用隐式引用与 dependsOn 来消除出现意外依赖关系的可能性，否则会影响部署的并行性（和速度）。您还需考虑这些资源的生命周期、RBAC 注意事项和各种依赖关系，以便确定是否应将这些资源置于不同的资源组中。

添加共享资源（如共享存储帐户）时，还应评估是否需为其设置资源锁，因为这样可避免意外删除。

添加新资源时，您还应检查一下，看是否可以将任何添加到端到端解决方案范围模板的资源隔离开来，让其自行充当功能范围模板。如果可以，则强烈建议这样做，以便促进资源的进一步细分，这对资源的重复使用和测试都有好处。

如前面的示例所示，在解决方案模块中进行集成时，您后面还需要考虑的是确定各个功能范围解决方案模板的生命周期是否不同于范围更广泛的解决方案的生命周期，以及在履行任何 RBAC 要求时，是否必须将这些资源分隔到不同的资源组中。

最后，您还需要考虑的是，您是否希望能够定义和查询资源之间的链接。如果您有这种想法，则可使用资源链接跨端到端范围解决方案模板来这样做，即使这些资源分布在多个资源组中。

## 使用部分打开/关闭模式创建端到端解决方案范围模板

此方案是前一方案的变体。在此方案中，客户会在一天内按固定的时间间隔从本地系统提取数据。他们有处理此传入数据的数据管道，以及一个关系数据存储区，该存储区的数据始终可供查询。由于云是即用即付模型，因此客户希望数据管道仅在需要处理已提交数据的时段内运行。

客户数据管道的一部分是 SQL Server，用于接收已处理的数据并使其可用于查询。客户表示，虽然他们希望按固定计划来打开和关闭管道的数据引入和处理部分，但却希望 SQL Server 能够始终保持可用状态。

在此方案中，在生命周期方面似乎存在着明显的差异，并且可能有一些额外的注意事项，这些注意事项虽然客户尚未提出，但仍然需要进行评估。

如前所述，在创建和删除其他资源时，SQL Server 部署将始终保持活动状态。这些资源一开始将部署在一起，但然后，模板的其他成员就会被销毁并按不同的生命周期来创建。这些资源可以分隔到不同的资源组中，也可以留在同一个资源组中，但需对 SQL Server 资源应用资源锁定。如此前的示例所述，具体说来，由于可以将 SQL Server 表示为较大的一组资源，因此可以适当地将其隔离到自己的资源组中。

另一项考虑是，虽然客户说过他们希望按计划打开和关闭数据管道的其余部分，但他们可能未考虑过报告系统的不一致行为。通过第三方按计划传送数据并不总是那么精确 – 连接可能在某段时间内不可用、本地或基于云的服务器上的时钟可能存在偏差、时间更改可能按预想的进行，也可能不按预想的进行，等等。如果还需要采用打开/关闭模式来使用您的引入机制，则应该对这方面的情况进行评估，而如果答案为是，那么，相应的生命周期是否长于处理组件的生命周期？

如果您是使用 Azure 数据工厂或事件中心之类的托管服务，则这不算什么问题，因为其操作模式以及关联的计费方法使得这些服务可以很容易地用于引入您的数据并将其置于存储中。如果您要使用已部署到虚拟机的其他技术（例如 Kafka）则可能需要注意此方面的生命周期，以及进行引入所需的相关存储帐户。由于生命周期的不同，这可能会导致引入和处理资源被置于不同的资源组中。

## 在一个订阅内支持不同的环境

为了有效地提供服务，许多组织在规模、计费隔离、责任隔离和地理隔离方面有一系列的要求，这些要求必须得到满足。在设计 Azure 的服务时，他们就会根据历史经验在其方法中使用订阅分区来满足这些要求。

资源管理器会减轻可以在订阅中部署的特定类型资源的数量限制，并且引入了资源组、RBAC 和审核功能。将这些组合起来，组织就可以根据其需求将资源组用于分区，并减少可能需要完成的订阅分区的容量（如果有）。

本部分将讨论所看到的针对这些环境类型的要求，并提供相关指导，说明如何才能提供令人满意的带 ARM 的环境。

### 隔离注意事项

本部分将更详细地探讨在环境隔离、计费隔离和地理隔离方面常见的客户驱动因素。

#### 环境隔离

服务所有者希望对不同的环境进行隔离。对每个环境进行隔离以后，相关团队就可以对能够访问环境的人员进行更精细的控制。虽然就访问的人员来说开发环境可能更开放，但随着环境范围越来越接近生产，为了符合相关规范并降低总体风险，将会减少用户（不管是人还是用于自动操作的系统帐户）的数量。

#### 计费隔离 – 开发服务和运行服务的比较

为了准确地反映销货成本 (COGS) 和营业费用 (OpEx)，企业所有者希望能够将研究和构建服务的成本与运行服务的成本细分开来。

前面提到进行各种环境隔离的超集，其目的是将开发和测试整合在一起以便进行单独计费和/或聚合计费（针对前者），而生产仍然保持独立（针对后者）。

#### 计费隔离 – 加强服务使用成本的透明性和问责制

计费隔离还可用于加强特定团队使用平台时的相关成本的透明性，并引入问责制，对团队进行相应级别的追责。

虽然云很有弹性并允许使用即用即付模型，但对于某些使用非云模型（相关硬件需要通过采购来获得）的开发人员来说，这是一种他们不太熟悉的技术。在非云模型中，能够打开的“计算机”的数量存在物理限制，在资源不使用时，基本都希望能够缩减资源的规模或关闭这些资源。在很多情况下，采购这些专用硬件不是由负责使用的开发人员来完成的。

服务所有者发现，可以对订阅进行隔离并将这些订阅的责任指定给特定的团队，这种类型的订阅分区有助于推行和实施所需的行为规范。

#### 地理驱动型隔离 – 根据特定地区的法律进行部署

在特定情况下，针对特定地区的服务需要考虑采用适当的部署方式，以便符合相关法律法规的要求。

虽然某项服务从性质上来说可能是全球性服务，但将该服务部署在特定的地区或向特定地区提供该服务时，需遵循相应的运营人员安排要求。具体说来，就是只能让属于特定的国家/地区（或一系列特定的国家/地区）或通过特定背景调查流程的人员来运营这些服务。

地理隔离还有其他好处，例如可以充分利用新的平台服务和功能。某些地区（如中国）可能只提供一部分平台服务，并且/或者平台服务的部署在时间上落后于其他地区。

地理隔离可以让团队改进其服务，以便充分利用所提供的新型或增强型平台服务和功能。

### 合规性考虑事项

服务在交付时，可能会跨多个地理区域和多个垂直市场。这些受众的应用程序中通常包含敏感数据或流程，而政府则已制定相关的合规性法规来保护他们并对与之相关的合约进行审核。

#### 角色和职责分离

角色和职责分离是一项关键要求，这样是为了让内部服务能够遵循内部策略。许多商业服务也会有这种要求，这样是为了遵循政府规定和行业规范。在特定情况下，需要对服务访问权限进行限制，只允许经授权的角色访问服务及其下面的资源。许多服务构建了相应的基架来提供两项功能 – RBAC 和审核。

#### 基于角色的访问控制 (RBAC) 用例

在合规性方案中，必须限制对特定资源的访问，这很重要。

例如，在涉及合规性的多种方案中，在查看敏感数据（健康信息、财务数据、纳税记录等）时，必须限制能够访问、查看或操作数据的人员的数目，仅将数据访问权限授予那些需要进行访问才能完成父组织工作的人员。

可以通过 RBAC 授予特定的个人、系统或小组在特定条件下对特定资源的访问权限。

#### 审核

除了通过 RBAC 对访问进行限制，组织还需对资源访问权限以及与资源的交互情况进行审核。

### 通过 Azure 资源管理器进行实现

在以前，组织会使用订阅分区来实现这些目标。虽然可以这样做，但结果并不理想。创建订阅实际上是一种商业活动，而服务管理 API 并没有提供相应的机制来自动创建或删除新订阅，订阅需要手动创建。其结果就是，订阅数量可能会显著增长。对于规模很大的服务（例如 Microsoft 自行推出的商业服务）来说，该数字可能会很大，超过一千个订阅。这种情况下通常需要创建自定义基架，用于创建和管理组织的订阅。

使用资源管理器时，在一个订阅内部署多个环境将简单得多。它不再像以前的模型那样对资源设置固定的限制，因此不需迫于资源限制而进行分区。

可以将环境置于资源组中，以便向其应用特定的 RBAC，从而实现环境隔离的目标。在需要进行地理隔离的情况下，也可以使用资源组来实现此目标。由于资源组可以跨多个地理区域，因此可以实现对一个或多个地理区域进行特定隔离的目标。

您可以向进行帐单汇总和视图汇总时所用的资源和资源组应用标记，以便实施计费隔离。您可以使用标记来定义环境类型（研究、教育、开发、测试、生产）以及负责单位或个人（“HR”、“财务”、“John Smith”、“Jane Jones”）。

审核要求是通过基础 Azure 资源管理器的现成功能集来实现的，可以集中进行查看。

最终客户可以在 Azure Active Directory 中注册帐户，这样可以方便地进行身份验证和基于角色的访问控制，从而限制对环境和资源的访问。

#### 密度优化

虽然在 Azure 资源管理器中对资源限制有所放松，但是仍然存在限制。除了创建环境本身，您还应注意在订阅中确保一定的环境密度。向个人或组织提供环境相当于向其提供容量，您应该评估一下，需要提供什么样的“容量”才合适。具体说来，您需要确定小型客户、中型客户、大型客户和超大型客户在所需资源方面存在何种差异。

您可以针对不同的规模来选择使用不同的订阅，从而确保较高的密度。例如，您可以在一个特定的订阅中安排 1000 个小型环境、500 个中型部署、100 个大型部署、10 个超大型部署。由于多个订阅并没有计费的成本，因此您可以将不同的大小分开到不同的订阅中，以确保最大密度。这样做可以保持订阅数目相对不高，因而容易管理。

您应该考虑的一大因素是，您需要确定是否允许客户增大或改变其部署大小，而如果答案为是，则您应如何应对。

一种方法是允许客户在其现有的资源组中获取更多容量。这在技术上可以轻松做到，但会影响密度。与直接定义所有客户的大小相比，这种方法有一定程度的可变性，但会增加进行密度优化的开销。如果每个小型环境的大小都是 X，您可以轻松地计算出需要在订阅中放置多少小型环境才能达到最佳密度。如果允许客户自定义环境，则变量的数目和环境的数目将是不可预测的，可能会是 X、X+1、X+2，等等。在变化如此之大的情况下，您所获得的密度将会较低，因为您需要在订阅中留出一定的容量来应对这种变化情况。

虽然这种方法可以使用，但作为一种通用方法并不理想，因为它能达到的密度较低，而需要的管理开销则较高。对于较大型的环境来说，这种方法的可行性较高。将这些大型和超大型环境置于订阅中时，其所需要的数量会较少，因此您可以选择将较少数目的此类环境置于订阅中，以应对需求增长的情况。

另一种方法是删除客户当前大小的环境，创建其他大小的新环境。虽然这种方法不适合某些情况，但很适合临时使用的环境（如开发和测试环境）。

接下来要在这里介绍的是最容易的方法，即允许客户获取更大型的环境，然后让其自行管理向该环境的迁移。例如，可以让将 SQL Server 部署在小型环境中的客户购买中型环境，然后让其自行负责转移数据和自定义状态。

另一种方法是提供托管服务，通过该服务来实现从一种环境大小到另一种环境大小的过渡。这种方法显然更复杂，但您的组织可能愿意采用它，具体取决于工作负荷和客户的情况。

## 在提供环境时，施加更多客户策略限制

某些组织会针对所部署的环境提出更多要求并制定相应的策略。具体说来，他们会制定策略来限制哪些端口可以对外公开，并会制定策略来要求监视环境的入站和出站流量。考虑到可支持性和成本，也可以对最终客户能够创建、更新或删除的资源进行限制。提供环境的组织通常也会要求访问该订阅，以便提供支持。

就此前的各种情况来看，这需要添加特定的资源来施加额外的限制，限制哪些人可以创建特定类型的资源，哪些人则不可以。

使用基于角色的访问控制可以限制用户创建、更新或删除某些资源。例如，组织可能会要求不允许最终客户更新或删除某些网络 VNET 以及可能存在的子网。

可以使用资源锁来确保相关资源为只读或无法删除。可以通过 RBAC 来允许用户或服务主体针对某个资源或资源组执行特定的活动。

如果组织要求某些通信（例如应用程序中不同层之间的通信）首先经过一个中介（例如虚拟网络设备），则应使用用户定义的路由。

虚拟设备只是一个 VM，该 VM 所运行的应用程序用于通过某种方式（例如防火墙或 NAT 设备）处理网络流量。许多第三方会在 Azure 上提供虚拟网络设备，组织也可以自带设备。

组织可以通过“自带设备”方式来重复使用现有的代码，这些代码可能已在本地环境中使用过。此虚拟设备 VM 必须能够接收不发送给自身的传入流量。若要允许 VM 接收发送到其他目标的流量，必须在 VM 中启用 IP 转发。

与前面的示例一样，在制定资源组策略时，应查看并考虑资源生命周期和 RBAC 限制因素。

## 防止资源受内部人员的非法侵犯

组织需要考虑对其资源和模板进行保护，防止其受到恶意侵犯。

这方面的一个例子是，一家银行希望确保恶意软件开发人员或其 IT 部门的员工不会对系统进行修改或提取关键信息，否则会导致数据落入进行犯罪活动的不法分子手中。

一个典型的企业方案是，允许一小组受信任的操作员访问已部署工作负载中的关键机密，同时允许范围更广的一组开发/运营人员可以创建或更新 VM 部署。

可以将 Azure 密钥保管库与 ARM 一起使用，以便管理和存储 VM 机密和证书。

最好是始终使用独立的 ARM 模板来创建保管库（将包含关键材料）和部署 VM（通过 URI 来引用保管库中包含的密钥）。

受信任的操作员可以通过 RBAC 来完全控制密钥保管库中存储的机密。如果这个受信任的操作员离开了公司或者转到了公司内部的新组中，他/她将无法继续访问该保管库中创建的密钥。

用于部署的 ARM 模板只包含机密的 URI 引用，这意味着实际机密不在代码、配置或源代码存储库中。这样可降低通过网络钓鱼获取机密的机会，并且限制了不法分子更改数据的能力。

如文档前面所述，没有全局性的密钥保管库。由于密钥保管库始终是区域性的，因此 VM 的机密始终具有地区性（和自主性）。

此方法的实现示例参见本文档前面的“机密和证书”部分。

## 启用“自带订阅”模型

公司 IT、系统集成商和云服务供应商可以为其客户部署“自带订阅”模型。具体说来就是，组织向最终客户提供服务，然后以某种方式利用该客户的 Azure 订阅。

此方法有多种变体，每种变体的要求稍有不同，详述如下。

### 允许第三方访问，以便监视帐户中的资源

装有监视应用程序的组织可能会要求对客户的订阅进行只读访问，以便检索可以在该应用程序中使用的数据。这需要进行一定时间的只读访问。访问需要受客户的控制，即客户可以在与监视服务提供商的关系终止的情况下终止该访问。

#### 通过 Azure 资源管理器进行实现

此方面的实现细节详见“开发人员指南：如何通过 Azure 资源管理器 API 进行身份验证”，该文章可以在[此处](http://www.dushyantgill.com/blog/2015/05/23/developers-guide-to-auth-with-azure-resource-manager-api/)找到。该文档提供了分步实现说明以及示例代码。

### 允许第三方访问，以便一次性部署软件

在另一个示例中，组织在客户的帐户中部署和配置某个版本的软件，需要在部署期间获得写访问权限。

#### 通过 Azure 资源管理器进行实现

这将遵循与前一示例类似的方法。

根据安装的具体需要，分配给服务主体的特定角色只具有进行安装所需的最低程度的访问权限，而在完成安装后，该访问权限会被立即撤销。

### 允许第三方访问，以便使用客户订阅进行数据存储

另外一个例子就是，组织可能希望在自己的环境中运行软件，而使用客户的帐户进行存储。这样可以让客户全程控制其数据并自行选择利用平台上的其他技术（例如 Azure 机器学习或 HDInsight），同时并不增加企业 IT、系统集成商或提供该功能的 CSV 的成本/计费开销。这要求组织能够持续访问存储帐户，而客户则能够控制并访问与访问该信息相关的审核信息。

#### 通过 Azure 资源管理器进行实现

这是使用与其他示例相同的模式来实现的。为服务主体提供了存储资源的访问权限。由于此方案要求角色具有对存储帐户的读取和写入访问权限，因此会向服务主体分配内置的参与者角色以实现这种级别的访问权限。

由于此方案涉及到具有共享存储帐户的第一方和第三方，因此还需确保该存储帐户不会被意外删除。考虑到该方案此方面的情况，您需要向存储帐户应用资源锁。

### 允许第三方进行服务管理

另外一个例子就是，组织希望在客户订阅中部署、监视和管理软件。可以设置限制条件，指出客户可以对部署软件的环境进行哪些更改（或者更明确地指出不能进行哪些更改）。

#### 通过 Azure 资源管理器进行实现

这需要遵循此部分一开始就确定的一大系列的模式。具体说来就是，需要向第三方所使用的服务主体提供对资源组中资源的完全访问权限。

此外，由于对客户进行了限制，因此需向客户那边的用户或小组授予利用此环境所需的相应权限。这可以通过模板来完成，如此部分前面所述。

最后，可能需要确保某些资源不会被意外删除。如果属于这种情况，则还应考虑对那些需要此类保护的资源应用资源锁。

## 后续步骤

- 若要了解如何创建模板，请参阅[创作模板](/documentation/articles/resource-group-authoring-templates)。
- 至于如何在 Azure 资源管理器中处理安全事项，请参阅 [Azure 资源管理器的安全注意事项](/documentation/articles/best-practices-resource-manager-security)以获取相关建议。
- 若要了解进出模板的状态，请参阅[共享 Azure 资源管理器模板中的状态](/documentation/articles/best-practices-resource-manager-state)

<!---HONumber=71-->