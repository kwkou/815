<properties
	pageTitle="Azure AD Connect Sync 配置筛选"
	description="说明如何在 Azure AD Connect Sync 中配置筛选。"
	services="active-directory"
	documentationCenter=""
	authors="markusvi"
	manager="swadhwa"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.date="07/27/2015"
	wacn.date="01/29/2016"/>


# Azure AD Connect Sync：配置筛选

在 Azure AD Connect Sync 中，你可以随时启用筛选。如果你已经运行目录同步的默认配置，并在此后配置了筛选，则筛选出的对象不再同步到 Azure AD。因此，Azure AD 中前面已同步，但之后进行筛选的任何对象会在 Azure AD 中进行删除。如果由于筛选错误导致对象被无意中删除，则可以通过删除筛选配置，然后再次同步目录，在 Azure AD 中重新创建对象。

> [AZURE.IMPORTANT]Microsoft 不支持在正式记录的这些操作之外修改或操作 Azure AD Connect Sync。其中的任何操作都可能会导致 Azure AD Connect Sync 出现不一致或不受支持状态，并由此导致 Microsoft 无法提供这种部署的技术支持。
 
除了基于属性的出站筛选，当安装或升级到较新版本的 Azure AD Connect 时，仍会保留配置。运行第一个同步周期之前，在升级到较新版本之后验证配置没有被无意中更改，这始终是最佳做法。


## 筛选选项

> [AZURE.NOTE]在本主题中，源 AD 用作 Active Directory 域服务连接器的名称。如果你有多个林，则每个林有一个连接器，并且必须为每个林重复配置。
 
以下三种筛选配置类型可以应用于目录同步工具中：

- **基于域**：你可以使用此筛选类型在 Azure AD Connect Sync 中管理 SourceAD 连接器的属性。你可以利用此类型选择允许同步到 Azure AD 的域。

- **配置基于组织单元的筛选**：你可以使用此筛选类型在 Azure AD Connect Sync 中管理 SourceAD 连接器的属性。你可以利用此筛选类型选择允许同步到 Azure AD 的 OU。

- **基于属性**：你可以使用此筛选方法指定基于属性的筛选器。通过此操作，你可以控制应同步到云的对象。

## 配置基于域的筛选

本部分为你提供配置域筛选器需要执行的步骤。


> [AZURE.NOTE]如果你已修改域筛选器，则还需要更新运行配置文件。
 

**若要设置域筛选器，请执行以下步骤：**

1. 通过使用属于 **ADSyncAdmins** 安全组的成员的帐户，登录到正在运行 Azure AD Connect Sync 的计算机。

2. 在“启动”上，点击或单击“同步服务”，以打开 **Synchronization Service Manager**。<br>

3. 若要打开连接器视图，请在“工具”菜单中单击“连接器”。

4. 在“连接器”列表中，选择将 **Active Directory 域服务**作为“类型”的连接器。

5. 若要打开“属性”对话框，请在“操作”菜单中单击“属性”。

6. 单击“配置目录分区”。

7. 在“选择目录分区”列表中，验证是否只选择了你想要同步的分区。<br> >[AZURE.Note]若要从同步过程中删除域，请清除该域的复选框。

8. 若要关闭“属性”对话框中，请单击“确定”。


如果你已修改域筛选器，则还需要更新以下运行配置文件：

- 完全导入
- 完全同步
- 增量导入
- 增量同步
- 导出


如果你已从目录分区列表中删除某个分区，则需要确保引用此分区的所有运行配置文件步骤也被删除。

**若要从运行配置文件中删除某个步骤，请执行以下步骤：**

1. 在“连接器”列表中，选择将 **Active Directory 域服务**作为“类型”的连接器。

2. 若要打开“配置运行配置文件为”对话框，请在“操作”菜单中单击“配置运行配置文件”。

3. 在“连接器运行配置文件”列表中，选择你想要配置的运行配置文件

4. 对于步骤详细信息列表中的每个步骤，请执行以下步骤：

     4\.1.如有必要，单击步骤，以展开步骤的详细信息。

     4\.2.如果“分区”属性的“值”为 GUID，请单击“删除步骤”。

5. 若要关闭“配置运行配置文件为”对话框，请单击“确定”。

如果已将某个分区添加到目录分区列表中，则需要确保该分区的运行配置文件步骤在上述列表中的每个运行配置文件上都可用。

**若要向运行配置文件中添加步骤，请执行以下步骤：**

1. 在“连接器”列表中，选择将 **Active Directory 域服务**作为“类型”的连接器。

2. 若要打开“配置运行配置文件为”对话框，请在“操作”菜单中单击“配置运行配置文件”。

3. 在“连接器运行配置文件”列表中，选择你想要配置的运行配置文件

4. 若要打开“配置运行配置文件”对话框，请单击“新步骤”。

5. 在“配置步骤”页上，在步骤类型列表中，选择步骤类型，然后单击“下一步”。

6. 在“连接器配置”页上，在“分区”列表中，选择已添加到域筛选器的分区名称。

7. 若要关闭“配置运行配置文件”对话框，请单击“完成”。

8. 若要关闭“配置运行配置文件为”对话框，请单击“确定”。

 

## 配置基于组织单元的筛选

**若要配置基于组织单元的筛选，请执行以下步骤：**

1. 通过使用属于 **ADSyncAdmins** 安全组的成员的帐户，登录到正在运行 Azure AD Connect Sync 的计算机。

2. 在“启动”上，点击或单击“同步服务”，以打开 **Synchronization Service Manager**。<br>

3. 在 **Synchronization Service Manager** 上，单击“连接器”，然后双击“SourceAD”。

4. 单击“配置目录分区”，选择你想要配置的域，然后单击的域“容器”。

5. 出现提示时，输入本地 Active Directory 林的域凭据。<br> >[AZURE.NOTE]出现凭据对话框时，则会显示用于导入和导出到 AD DS 的帐户。如果你不知道帐户的密码，则可以输入要使用的另一个帐户。使用的帐户必须具有读取当前正在配置的域的权限。

6. 在“选择容器”对话框中，清除不想与云目录同步的 OU，然后单击“确定”。

7. 在“SourceAD 属性”页上单击“确定”。

8. 通过完成以下步骤来运行完全导入和增量同步：

     8\.1.在连接器列表中，选择“SourceAD”

     8\.2.若要打开“运行连接器”对话框，请从“操作”菜单中选择“运行”。

     8\.3.在“运行配置文件”列表中，选择“完全导入”，然后等待运行配置文件完成。

     8\.4.若要打开“运行连接器”对话框，请从“操作”菜单中选择“运行”。

     8\.5.在“运行配置文件”列表中，选择“增量同步”，然后等待运行配置文件完成。




## 配置基于属性的筛选

有多种方式可以基于属性配置筛选。建议在 AD 入站上进行配置，因为即使在升级到较新版本后，也会保留这些配置设置。支持在 AAD 出站上进行配置，但升级到较新版本后，不会保留这些配置设置，并且当需要在 metaverse 中查看组合对象来确定筛选时，才应使用该设置。

### 入站筛选

基于入站的筛选会利用默认配置，在默认配置中，转到 AAD 的对象必须使 metaverse 属性 cloudFiltered 未设置为值，且 metaverse 属性 sourceObjectType 设置为“用户”或“联系人”。

当对象不应同步到 Azure AD 并在其他情况下保持为空时，属性 cloudFiltered 应设置为 True。当我们可以查看某对象并指明我们不想同步该对象（消极筛选）时，则使用此方法。

在下面的示例中，我们会筛选出其中 extensionAttribute15 具有值 NoSync 的所有用户：

1. 通过使用属于 ADSyncAdmins 安全组的成员的帐户，登录到正在运行 Azure AD Connect Sync 的计算机。
2. 从“开始”菜单中打开**同步规则编辑器**。
3. 确保选择了“入站”，然后单击“添加新规则”。
4. 为规则指定一个描述性名称，如“In from AD – User DoNotSyncFilter”，选择正确的林，**用户**作为 **CS 对象类型**，**人员**作为 **MV 对象类型**。作为**链接类型**，选择“联接”，然后在“优先类型”中，选择另一个同步规则当前未使用的值（例如：50），然后单击“下一步”。
5. 在“范围筛选器”中，单击“添加组”，单击“添加子句”，然后在属性中选择“ExtensionAttribute15”。确保运算符设置为“等于”，并在值框中**键入**值 NoSync。单击“下一步”。
6. 将“联接”规则留空，然后单击“下一步”。
7. 单击“添加转换”，选择“FlowType”到“Constant”，选择目标属性 cloudFiltered，然后在源文本框中键入 True。单击“添加”保存规则。
8. 执行完全同步：在“连接器”选项卡上，右键单击“SourceAD”，依次单击“运行”、“完全同步”，然后单击“确定”。 


如果属性“sourceObjectType”分别具有值“用户”或“联系人”，则此属性会为 Azure AD 设置“用户”或“联系人”。通过创建具有比现成同步规则更高优先级的同步规则，你可以重写默认行为。此方法还会为你提供表达正值和负值规则的机会。

在下面的示例中，如果部门属性为“*Sales*”或为空，则只同步用户：

1. 通过使用属于 ADSyncAdmins 安全组的成员的帐户，登录到正在运行 Azure AD Connect Sync 的计算机。
2. 从“开始”菜单中打开**同步规则编辑器**。
3. 确保选择了“入站”，然后单击“添加新规则”。
4. 为规则指定一个描述性名称（如“In from AD – User DoNotSyncFilter”），选择正确的林，**用户**作为 **CS 对象类型**，**人员**作为 **MV 对象类型**。作为**链接类型**，选择“联接”，然后在“优先类型”中，选择另一个同步规则当前未使用的值（例如：60）。单击“下一步”。
5. 将“范围筛选器”和“联接规则”留空，然后单击“下一步”两次。
6. 单击“添加转换”，选择“FlowType”到“表达式”，然后选择“目标属性” 到“sourceObjectType”。在“源”中，键入以下表达式：<br>`IIF(IsNullOrEmpty([department]),NULL,IIF([department]<>”Sales”,”DoNotSync”,NULL))`
7. 单击“添加”保存规则。
8. 执行完全同步：在“连接器”选项卡上，右键单击“SourceAD”，依次单击“运行”、“完全同步”，然后单击“确定”。下面是操作的显示结果：<br>

> [AZURE.NOTE]请注意，我们将使用 cloudFiltered 和 sourceObjectType 的组合来确定我们想要同步到 AAD 的对象。
 
通过使用表达式，你可以拥有非常强大的筛选选项。在上述表达式中，请注意，当部门不存在以及部门为“Sales”时，我们提供了 NULL 值。这表示此属性未提供值，并会评估现成规则。我们希望获得此结果，以便它们可以确定我们应在 Azure AD 中创建“用户”或“联系人”。


## 基于出站的筛选

在某些情况下，仅在对象已联接到 metaverse 中之后执行筛选是必要的。例如，可能需要从资源林中查看邮件属性，并需要从帐户林中查看 userPrincipalName 属性，以确定某一对象是否应为 synchronizedx。在这些情况下，我们会基于出站规则创建筛选。

> [AZURE.NOTE]此方法要求对现成同步规则进行更改。支持更改同步规则的范围，但升级到较新版本的 Azure AD Connect 后可能不会保留更改。如果你使用基于出站的筛选，请记录作出的更改，升级之后，确保筛选仍然存在，并根据需要重新应用。
 

在此示例中，我们会更改筛选，以便只同步 mail 和 userPrincipalName 均以 @contoso.com 结尾的用户：

1. 通过使用属于 ADSyncAdmins 安全组的成员的帐户，登录到正在运行 Azure AD Connect Sync 的计算机。
2. 从“开始”菜单中打开同步规则编辑”。
3. 在“规则类型”下，单击“出站”。
4. 查找名为“Out to AAD – User Join”的规则。单击“编辑”。
5. 单击左侧导航上的“范围筛选器”。单击“添加子句”，在“属性”中，选择“mail”，在“运算符”中，选择“ENDSWITH”，并在值中键入 @contoso.com。单击“添加子句”，在“属性”中，选择“userPrincipalName”，在“运算符”中，选择“ENDSWITH”，并在值中键入 @contoso.com。
6. 单击“保存”。
7. 执行完全同步：在“连接器”选项卡上，右键单击“SourceAD”，依次单击“运行”、“完全同步”，然后单击“确定”。



## 其他资源

* [Azure AD Connect Sync：自定义同步选项](/documentation/articles/active-directory-aadconnectsync-whatis)
* [将本地标识与 Azure Active Directory 集成](/documentation/articles/active-directory-aadconnect)

 

<!---HONumber=71-->